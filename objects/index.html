
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://report.ice6413p.space/objects/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.0">
    
    
      
        <title>Objects - K8S Experiment</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.fd896c8a.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WZKCHK54MZ"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-WZKCHK54MZ",{page_path:e.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WZKCHK54MZ"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#objects-experiment" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="K8S Experiment" class="md-header__button md-logo" aria-label="K8S Experiment" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            K8S Experiment
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Objects
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/davidliyutong/ICE6413P-260-M01.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../installation/" class="md-tabs__link">
        Installation
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../container/" class="md-tabs__link">
      Container
    </a>
  </li>

      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="./" class="md-tabs__link md-tabs__link--active">
      Objects
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../components/" class="md-tabs__link">
      Components
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../helm/" class="md-tabs__link">
      Helm
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../wordpress/" class="md-tabs__link">
      Wordpress
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="K8S Experiment" class="md-nav__button md-logo" aria-label="K8S Experiment" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    K8S Experiment
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/davidliyutong/ICE6413P-260-M01.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Installation" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../docker/" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../minikube/" class="md-nav__link">
        Minikube
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cluster/" class="md-nav__link">
        Cluster
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../container/" class="md-nav__link">
        Container
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Objects
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Objects
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#config" class="md-nav__link">
    Config
  </a>
  
    <nav class="md-nav" aria-label="Config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context-related" class="md-nav__link">
    Context related
  </a>
  
    <nav class="md-nav" aria-label="Context related">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-k8s" class="md-nav__link">
    实践 - 远程控制K8S
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    实践 - 新建用户并配置权限
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    检查证书并续签
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    小结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-nodes" class="md-nav__link">
    Cluster &amp; Nodes
  </a>
  
    <nav class="md-nav" aria-label="Cluster &amp; Nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node" class="md-nav__link">
    Node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#taint-toleration" class="md-nav__link">
    Taint &amp; Toleration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#label" class="md-nav__link">
    Label
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#namespaces" class="md-nav__link">
    Namespaces
  </a>
  
    <nav class="md-nav" aria-label="Namespaces">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitor" class="md-nav__link">
    Monitor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log" class="md-nav__link">
    Log
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pod" class="md-nav__link">
    Pod
  </a>
  
    <nav class="md-nav" aria-label="Pod">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod-with-1-container" class="md-nav__link">
    Pod with 1 Container
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod-with-2-containers-and-shared-emptydir" class="md-nav__link">
    Pod with 2 Containers and shared EmptyDir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod-with-resource-limitation" class="md-nav__link">
    Pod with resource limitation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod-with-liveness-check" class="md-nav__link">
    Pod with Liveness Check
  </a>
  
    <nav class="md-nav" aria-label="Pod with Liveness Check">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#liveness-cmd-check" class="md-nav__link">
    Liveness CMD Check
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#liveness-http-check" class="md-nav__link">
    Liveness HTTP Check
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#liveness-tcp-check" class="md-nav__link">
    Liveness TCP Check
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod-with-nodeselector" class="md-nav__link">
    Pod with NodeSelector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initcontainer" class="md-nav__link">
    InitContainer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-pod" class="md-nav__link">
    Static Pod
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workload" class="md-nav__link">
    Workload
  </a>
  
    <nav class="md-nav" aria-label="Workload">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replicaset" class="md-nav__link">
    ReplicaSet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment" class="md-nav__link">
    Deployment
  </a>
  
    <nav class="md-nav" aria-label="Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#by-cmd" class="md-nav__link">
    by CMD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scale-upgrade" class="md-nav__link">
    Scale &amp; upgrade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#horizontal-pod-autoscalerhpa" class="md-nav__link">
    Horizontal Pod Autoscaler(HPA)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#daemonset" class="md-nav__link">
    DaemonSet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#job" class="md-nav__link">
    Job
  </a>
  
    <nav class="md-nav" aria-label="Job">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lab-simple-job" class="md-nav__link">
    Lab - Simple Job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lab-completion-job" class="md-nav__link">
    Lab - Completion Job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lab-cronjob" class="md-nav__link">
    Lab - Cronjob
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#service" class="md-nav__link">
    Service
  </a>
  
    <nav class="md-nav" aria-label="Service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nodeport" class="md-nav__link">
    NodePort
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clusterip" class="md-nav__link">
    ClusterIP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expose-cmd" class="md-nav__link">
    Expose CMD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#health-check" class="md-nav__link">
    Health Check
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-service" class="md-nav__link">
    External Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#headless-service" class="md-nav__link">
    Headless Service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage" class="md-nav__link">
    Storage
  </a>
  
    <nav class="md-nav" aria-label="Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#etcd-based-storage" class="md-nav__link">
    etcd-based Storage
  </a>
  
    <nav class="md-nav" aria-label="etcd-based Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configmap" class="md-nav__link">
    ConfigMap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secret" class="md-nav__link">
    Secret
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#volume-based" class="md-nav__link">
    Volume-based
  </a>
  
    <nav class="md-nav" aria-label="Volume-based">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod-volume" class="md-nav__link">
    Pod Volume
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistent-volume" class="md-nav__link">
    Persistent Volume
  </a>
  
    <nav class="md-nav" aria-label="Persistent Volume">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#persistent-volume-pv" class="md-nav__link">
    Persistent Volume (PV)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistentvolumeclaim-pvc" class="md-nav__link">
    PersistentVolumeClaim (PVC)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage-class" class="md-nav__link">
    Storage Class
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#third-party-drivers" class="md-nav__link">
    Third-party Drivers
  </a>
  
    <nav class="md-nav" aria-label="Third-party Drivers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#custom" class="md-nav__link">
    Custom
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nfs" class="md-nav__link">
    NFS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ceph" class="md-nav__link">
    Ceph
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network" class="md-nav__link">
    Network
  </a>
  
    <nav class="md-nav" aria-label="Network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hostport" class="md-nav__link">
    hostPort
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hostnetwork" class="md-nav__link">
    hostNetwork
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nodeport_1" class="md-nav__link">
    nodePort
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#externalip" class="md-nav__link">
    externalIP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ingress-controller" class="md-nav__link">
    Ingress Controller
  </a>
  
    <nav class="md-nav" aria-label="Ingress Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-ingress-nginx" class="md-nav__link">
    实验 - 安装ingress-nginx
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-_1" class="md-nav__link">
    实验 - 编译镜像
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-ingress-http" class="md-nav__link">
    HTTP-Ingress-HTTP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-http-ingress-https" class="md-nav__link">
    实验 - HTTP-Ingress-HTTPS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-https-ingress-http" class="md-nav__link">
    实验 - HTTPS-Ingress-HTTP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-https-ingress-https-ssl-termination" class="md-nav__link">
    实验 - HTTPS-Ingress-HTTPS (ssl-termination)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-https-ingress-https-ssl-passthroughtmp" class="md-nav__link">
    实验 - HTTPS-Ingress-HTTPS (ssl-passthrough)(tmp)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../components/" class="md-nav__link">
        Components
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../helm/" class="md-nav__link">
        Helm
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../wordpress/" class="md-nav__link">
        Wordpress
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/davidliyutong/ICE6413P-260-M01.git/edit/master/docs/objects.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="objects-experiment">Objects Experiment</h1>
<p><a class="md-button" href="https://github.com/rebirthmonkey/k8s/tree/master/20_objects">Lab API Objects</a></p>
<p>我们回顾一下cluster的配置</p>
<ul>
<li>有<code>node0</code>，<code>node1</code>，<code>node2</code>三个节点</li>
<li><code>node0</code>是控制平面所在节点</li>
</ul>
<h2 id="config">Config</h2>
<h3 id="context-related">Context related</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config view
</code></pre></div>
<p><img alt="View" src="../img/20220428160356.png" /></p>
<p>查看本地context</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config get-contexts
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>该操作查看的是本地记录的context，取决于当前用户目录下<code>.kube/config</code>的内容或者是KUBECONFIG变量定义的配置文件的内容</p>
</div>
<p><img alt="Get Context" src="../img/20220428160558.png" /></p>
<p>查看当前使用的Context</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config current-context
</code></pre></div>
<p><img alt="Current Context" src="../img/20220428160746.png" /></p>
<p>使用<code>kubectl config --kubeconfig=${PATH_TO_CONFIG}</code>可以新增、修改配置文件。<code>${PATH_TO_CONFIG}</code>要被替换成配置文件的路径。如果该路径不存在则会被创建</p>
<ul>
<li>
<p>添加一个cluster，名为<code>development</code>，地址是<code>https://1.2.3.4</code>，证书是<code>fake-ca-file</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config --kubeconfig<span class="o">=</span>config-demo set-cluster development --server<span class="o">=</span>https://1.2.3.4 --certificate-authority<span class="o">=</span>fake-ca-file
</code></pre></div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>证书是PEM格式的
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="gh">-----BEGIN CERTIFICATE-----</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="s">...</span><span class="w"></span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="gh">-----END CERTIFICATE-----</span><span class="w"></span>
</code></pre></div></p>
</div>
<ul>
<li>
<p>添加一个cluster，名为<code>development</code>，不验证证书</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config --kubeconfig<span class="o">=</span>config-demo set-cluster scratch <span class="se">\</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>                         --server<span class="o">=</span>https://5.6.7.8 <span class="se">\</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>                         --insecure-skip-tls-verify
</code></pre></div>
</li>
<li>
<p>添加一个credential，名为<code>developer</code>，使用公私钥认证</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config --kubeconfig<span class="o">=</span>config-demo set-credentials <span class="se">\</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>                         developer <span class="se">\</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>                         --client-certificate<span class="o">=</span>fake-cert-file <span class="se">\</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>                         --client-key<span class="o">=</span>fake-key-seefile
</code></pre></div>
</li>
<li>
<p>添加一个credential，名为<code>experimenter</code>，使用用户名-密码认证</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config --kubeconfig<span class="o">=</span>config-demo set-credentials <span class="se">\</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>                         experimenter <span class="se">\</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>                         --username<span class="o">=</span>exp <span class="se">\</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>                         --password<span class="o">=</span>some-password
</code></pre></div>
</li>
<li>
<p>添加一个context，名为<code>dev-frontend</code>，位于<code>frontend</code>命名空间下，使用用户<code>developer</code>和集群<code>development</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config --kubeconfig<span class="o">=</span>config-demo set-context <span class="se">\</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>                        dev-frontend <span class="se">\</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>                        --cluster<span class="o">=</span>development <span class="se">\</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>                        --namespace<span class="o">=</span>frontend <span class="se">\</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>                        --user<span class="o">=</span>developer
</code></pre></div>
</li>
<li>
<p>添加一个context，名为<code>dev-storage</code>，位于<code>storage</code>命名空间下，使用用户<code>developer</code>和集群<code>development</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config --kubeconfig<span class="o">=</span>config-demo set-context <span class="se">\</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>                         dev-storage <span class="se">\</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>                         --cluster<span class="o">=</span>development <span class="se">\</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>                         --namespace<span class="o">=</span>storage <span class="se">\</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>                         --user<span class="o">=</span>developer
</code></pre></div>
</li>
<li>
<p>添加一个context，名为<code>exp-scratch</code>，位于<code>default</code>命名空间下，使用用户<code>experimenter</code>和集群<code>scratch</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config --kubeconfig<span class="o">=</span>config-demo set-context <span class="se">\</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>                         exp-scratch <span class="se">\</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>                         --cluster<span class="o">=</span>scratch <span class="se">\</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>                         --namespace<span class="o">=</span>default <span class="se">\</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>                         --user<span class="o">=</span>experimenter
</code></pre></div>
</li>
</ul>
<p>我们可以看到，当第一行执行完后，目录下多出了一个config-demo文件，这是因为运行命令时指定了<code>config-demo</code>作为配置文件名</p>
<p><img alt="Step 1" src="../img/20220428161623.png" /></p>
<p>执行完所有命令后，<code>config-demo</code>中的内容会发生大幅改变</p>
<p><img alt="Step Fin" src="../img/20220428162243.png" /></p>
<p>这里放一张图描述<code>Config</code>和k8s的关系</p>
<pre class="mermaid"><code>flowchart LR
    subgraph K8S
        direction LR
        B1(contexts) --&gt; B2(context1)
        B1(contexts) --&gt; B4(...)

        B2 --&gt; C1(cluster)
        B2 --&gt; C2(user)
        B2 --&gt; C3(namespace)

    end
    subgraph $HOME/.kube/config
        direction LR
        A1(clusters) -. + .-&gt; A2[users] -- = --&gt; A3[current-contex]
        A3[current-contex] --&gt; B2

    end</code></pre>
<p>因此：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config --kubeconfig<span class="o">=</span>config-demo use-context dev-frontend
</code></pre></div>
<p>应该被解释为：</p>
<ul>
<li>修改<code>config-demo</code></li>
<li><code>use-context</code>，使用一个context</li>
<li><code>dev-frontend</code> context名字是<code>dev-frontend</code></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>config文件的权限必须是<code>$USER.$GROUP:660</code></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>个人认为<code>kubectl config</code>只是提供了更好的修改config文件的方法，完全可以通过手动修改config做到这一点</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>kubectl --insecure-skip-tls-verify</code> 选项可以跳过证书验证</p>
</div>
<h4 id="-k8s">实践 - 远程控制K8S</h4>
<p>假设我们意图从一台笔记本连接在JCloud上部署好的集群（使用<code>kubeadm</code>部署）。我们首先查看<code>/etc/kubernetes/admin.conf</code>的内容</p>
<p><img alt="admin.conf" src="../img/20220429004609.png" /></p>
<p>我们可以看到，<code>certificate-authority-data</code>，<code>client-certificate-data</code>，<code>client-key-data</code>字段的值分别为服务器证书，用户证书和密钥</p>
<p>使用以下命令可以将证书、密钥数据转化为证书、密钥，并保存在文件中</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config view --minify --raw --output <span class="s1">&#39;jsonpath={..cluster.certificate-authority-data}&#39;</span> <span class="p">|</span> base64 -d <span class="p">|</span> openssl x509 -text -out - &gt; server.crt
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config view --minify --raw --output <span class="s1">&#39;jsonpath={..user.client-certificate-data}&#39;</span> <span class="p">|</span> base64 -d <span class="p">|</span> openssl x509 -text -out - &gt; client.crt
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="o">[</span>node0<span class="o">]</span> $ kubectl config view --minify --raw --output <span class="s1">&#39;jsonpath={..user.client-key-data}&#39;</span> <span class="p">|</span> base64 -d &gt; client.key
</code></pre></div>
<p>我们将产生的<code>server.crt</code>，<code>client.crt</code>，<code>client.key</code>下载到本地，例如<code>~/.kube/certs/k8s-jcloud</code>目录，然后配置config</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>kubectl config set-cluster k8s-jcloud --server<span class="o">=</span>https://10.119.11.113:6443 --certificate-authority<span class="o">=</span>certs/k8s-jcloud/server.crt
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>kubectl config set-credentials admin@k8s-jcloud --username<span class="o">=</span>kubernetes-admin --client-certificate<span class="o">=</span>certs/k8s-jcloud/client.crt --client-key<span class="o">=</span>certs/k8s-jcloud/client.key
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>kubectl config set-context k8s-jcloud --cluster<span class="o">=</span>k8s-jcloud --user<span class="o">=</span>admin@k8s-jcloud --namespace<span class="o">=</span>default
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>kubectl config use-context k8s-jcloud
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>也可以动将admin.conf的<code>user</code>，<code>cluster</code>部分配置粘贴进本地的config配置文件中</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>https://10.119.11.113:6443</code>是K8S集群的地址:端口，<code>--certificate-authority=certs/k8s-jcloud/server.crt</code> 集群证书</p>
<p>如果不想验证服务器的身份，则需要删除<code>--certificate</code>，并添加<code>--insecure-skip-tls-verify</code></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>admin@k8s-jcloud</code>是助记名称，<code>--username=kubernetes-admin</code> 是<code>kubeadm</code>初始化时设置的用户</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>--client-key=</code>，<code>--client-certificate=</code>均填写相对<code>~/.kube</code>的路径，或者是绝对路径</p>
</div>
<p><img alt="Config" src="../img/20220429100359.png" /></p>
<p>得到的配置文件大概是这个样子</p>
<div class="highlight"><span class="filename">.kube/config</span><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nt">clusters</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cluster</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="nt">insecure-skip-tls-verify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://10.119.11.113:6443</span><span class="w"></span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-jcloud</span><span class="w"></span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="nt">contexts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">context</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-jcloud</span><span class="w"></span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"></span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin@k8s-jcloud</span><span class="w"></span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-jcloud</span><span class="w"></span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="nt">current-context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-jcloud</span><span class="w"></span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Config</span><span class="w"></span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="nt">preferences</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="nt">users</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin@k8s-jcloud</span><span class="w"></span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">    </span><span class="nt">client-certificate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certs/k8s-jcloud/client.crt</span><span class="w"></span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">    </span><span class="nt">client-key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certs/k8s-jcloud/client.key</span><span class="w"></span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-admin</span><span class="w"></span>
</code></pre></div>
<p>这时候就可以用<code>kubectl config get-contexts</code>查看所有的contexts，并用<code>kubectl config use-context k8s-jcloud</code>命令选中改context</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>如果用kubeadm初始化时，<code>--apiserver-advertise-address</code>没有设置正确，则需要使用<code>--insecure-skip-tls-verify</code>运行<code>kubectl</code>命令，或者设置跳过证书检查</p>
</div>
<h4 id="-">实践 - 新建用户并配置权限</h4>
<p>创建新用户其实就是用Root CA签发新的证书。创建一个<code>create_user.sh</code>，内容如下</p>
<div class="highlight"><span class="filename">create_user.sh</span><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nv">ROOT_CA_CRT</span><span class="o">=</span>/etc/kubernetes/pki/ca.crt
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="nv">ROOT_CA_KEY</span><span class="o">=</span>/etc/kubernetes/pki/ca.key
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -lt <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="nb">echo</span> <span class="s2">&quot;User name not provided&quot;</span><span class="p">;</span> exit<span class="p">;</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="k">fi</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="nv">USER</span><span class="o">=</span><span class="nv">$1</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="nv">ORG</span><span class="o">=</span>ice6413p
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="nv">CN</span><span class="o">=</span><span class="nv">$1</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="nv">EXPIRATION</span><span class="o">=</span><span class="m">3650</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>openssl genrsa -out <span class="nv">$USER</span>.key <span class="m">2048</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>openssl req -new -key <span class="nv">$USER</span>.key -out <span class="nv">$USER</span>.csr -subj <span class="s2">&quot;/O=</span><span class="nv">$ORG</span><span class="s2">/CN=</span><span class="nv">$CN</span><span class="s2">&quot;</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>openssl x509 -req -in <span class="nv">$USER</span>.csr -CA <span class="nv">$ROOT_CA_CRT</span> -CAkey <span class="nv">$ROOT_CA_KEY</span> -CAcreateserial <span class="se">\</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>             -out <span class="nv">$USER</span>.crt -days <span class="nv">$EXPIRATION</span>
</code></pre></div>
<p>运行该脚本，将产生<code>test.csr</code>，<code>test.key</code>，<code>test.crt</code>三个文件，我们需要<code>test.key</code>, <code>test.crt</code>用于客户端认证</p>
<p>使用<code>kubectl config</code>工具，或直接编辑<code>~/.kube/config</code>文件，新增该用户和对应的Context。方法如上节所属</p>
<div class="highlight"><span class="filename">.kube/config</span><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">context</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-jcloud</span><span class="w"></span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"></span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test@k8s-jcloud</span><span class="w"></span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-jcloud-test</span><span class="w"></span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="nn">...</span><span class="w"></span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="nt">users</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test@k8s-jcloud</span><span class="w"></span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="nt">client-certificate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">credentials/test/test.crt</span><span class="w"></span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="nt">client-key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">credentials/test/test.key</span><span class="w"></span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span><span class="w"></span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="nn">...</span><span class="w"></span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>证书一旦发布则无法吊销，该用户将在证书有效期内获得访问集群的权限，因此需要加上额外的限制（e.g. RBAC权限管理）</p>
</div>
<p><img alt="Use of test user" src="../img/20220429111435.png" /></p>
<p>此时test用户没有任何权限。一个最常见的做法是使用<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/">RBAC鉴权</a>。以下命令将赋予一个test用户节点的管理员权限</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="o">[</span>node0<span class="o">]</span> kubectl create clusterrolebinding test-cluster-admin-binding --clusterrole<span class="o">=</span>cluster-admin --user<span class="o">=</span><span class="nb">test</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>liyutong-cluster-admin-binding</code>会被创建在<code>rbac.authorization.k8s.io</code>空间下，需要全局唯一</p>
</div>
<p>以下命令将赋予test用户user.test空间下所有资源的权限</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="o">[</span>node0<span class="o">]</span> kubectl create rolebinding test-admin-binding --clusterrole<span class="o">=</span>admin --user<span class="o">=</span><span class="nb">test</span> --namespace<span class="o">=</span>user.test
</code></pre></div>
<blockquote>
<p>参考<a href="https://support.huaweicloud.com/usermanual-cce/cce_01_0189.html">云容器引擎</a></p>
</blockquote>
<h4 id="_1">检查证书并续签</h4>
<p>k8s 版本迭代很快，官方推荐一年之内至少用 kubeadm 更新一次 Kubernetes 版本，这时候会自动更新证书。</p>
<p>查看根 CA 证书的有效期</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="o">[</span>node0<span class="o">]</span> $ openssl x509 -text -in /etc/kubernetes/pki/ca.crt <span class="p">|</span> grep <span class="s2">&quot;Not After&quot;</span>
</code></pre></div>
<p>查看当前证书有效期</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubeadm certs check-expiration
</code></pre></div>
<p>重新签发证书</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubeadm certs renew all
</code></pre></div>
<p>查看当前证书有效期</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubeadm certs check-expiration
</code></pre></div>
<p>重新签发证书:续签全部证书</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="o">[</span>node0<span class="o">]</span> $ kubeadm alpha certs renew all
</code></pre></div>
<h4 id="_2">小结</h4>
<p>一旦配置好集群后，我们就为实验用的用户生成证书，并下载到本地。这时候，我们就可以从<strong>任何</strong>一台能够与控制平面所在节点通讯的计算机控制集群，而<strong>不必登陆</strong>到该节点。因此在下文中所有的kubectl命令都可以看作是在一台任意的配置了kubectl的节点的机器上执行的。</p>
<h3 id="cluster-nodes">Cluster &amp; Nodes</h3>
<h4 id="node">Node</h4>
<p>使用<code>kubectl get</code>可以查看集群的各类，使用<code>kubectl describe</code>可以进一步详查</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>kubectl get nodes
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>kubectl describe nodes NODE_ID
</code></pre></div>
<p><img alt="Describe" src="../img/20220429140529.png" />  </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>nodes 不属于namespace（可以用<code>kubectl api-resources --namespaced=false</code>命令查看不属于namespace管辖的资源</p>
</div>
<h4 id="taint-toleration">Taint &amp; Toleration</h4>
<p>Taint 的语法是</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>kubectl taint node <span class="o">[</span>node<span class="o">]</span> <span class="nv">key</span><span class="o">=</span>value<span class="o">[</span>effect<span class="o">]</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>当Node被打上Taint后，因为Pod追求“<strong>完美</strong>”，正常的Pod是不会被调度至有瑕疵的节点。如果Pod比较大度，可以容忍这些Taint，那么是可以调度到这个节点的。这也就是为什么只有key=value的pod才会调度到上面</p>
<div class="highlight"><span class="filename">spec.template.spec</span><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nt">tolerations</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;key&quot;</span><span class="w"></span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Equal&quot;</span><span class="w"></span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="w"></span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">  </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;NoSchedule&quot;</span><span class="w"></span>
</code></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>去除master节点的调度限制可以使用以下命令</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>kubectl taint nodes --all node-role.kubernetes.io/master-
</code></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>kubectl taint node [node] key=value[effect]-</code>可以用来移除对应的污点</p>
</div>
<p>给节点node1打上污点，并查看污点</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>kubectl taint node NODE_NAME <span class="nv">taint1</span><span class="o">=</span>test1:NoSchedule
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>kubectl describe nodes <span class="p">|</span> grep Taints
</code></pre></div>
<p><img alt="Taint Node" src="../img/20220429213551.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>注意这里默认的Taint</p>
</div>
<p>删除污点</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>$ kubectl taint node NODE_NAME taint1-
</code></pre></div>
<p>我们部署服务</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>$ kubectl apply -f 20_taint-pod.yaml
</code></pre></div>
<div class="highlight"><span class="filename">20_taint-pod.yaml</span><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-taint1</span><span class="w"> </span><span class="c1"># 可以自定义</span><span class="w"></span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-taint1</span><span class="w"> </span><span class="c1"># 可以自定义</span><span class="w"></span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-taint1</span><span class="w"> </span><span class="c1"># 可以自定义</span><span class="w"></span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="w">      </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30m</span><span class="w"></span>
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20Mi</span><span class="w"></span>
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20m</span><span class="w"></span>
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10Mi</span><span class="w"></span>
<a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="w">  </span><span class="nt">tolerations</span><span class="p">:</span><span class="w"> </span><span class="c1"># 自定义调度规则容忍</span><span class="w"></span>
<a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">taint1</span><span class="w"> </span><span class="c1"># 容忍taint1:test2的瑕疵</span><span class="w"></span>
<a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test2</span><span class="w"></span>
<a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Equal</span><span class="w"></span>
<a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="w">    </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NoSchedule</span><span class="w"></span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>K8S中CPU使用量的计量周期为100ms，30m即30ms/100ms，也就是30%</p>
</div>
<p><img alt="nginx-taint" src="../img/20220429215155.png" /></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>kubectl cordon node1 <span class="c1"># 节点进入维护模式</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>kubectl get nodes <span class="c1"># 查看Node</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>kubectl drain node1 --ignore-daemonsets <span class="c1"># 平滑迁移pod，忽略daemonsets管理的pod</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>kubectl uncordon node1 <span class="c1"># 取消节点的维护模式</span>
</code></pre></div>
<p><img alt="Cordon" src="../img/20220429215328.png" /></p>
<p>可以看到，进入维护模式的节点，调度将停止</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>--ignore-daemonsets</code> 是为了防止和网络有关的Pod被调走</p>
</div>
<p>小结一下，节点维护的方法是，先将其置为维护模式停止调度，然后将节点上的Pod迁移到其他节点，随后就可以进行维护了。一旦维护结束，就取消节点的维护模式</p>
<h2 id="label">Label</h2>
<p>为<code>get pods</code>操作增加Label显示</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>kubectl get pods --show-labels
</code></pre></div>
<p>为<code>$POD_NAME</code>的Pod添加<code>{key: value}</code>的Label</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>kubectl label pod <span class="nv">$POD_NAME</span> <span class="nv">key</span><span class="o">=</span>value
</code></pre></div>
<p>为<code>$POD_NAME</code>的Pod删除名称为<code>key</code>的Label</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>kubectl label pod <span class="nv">$POD_NAME</span> key-
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>kubectl label node $NODE_NAME key=value</code> 可以对node做类似操作</p>
</div>
<p>使用<code>-l key=value</code>参数可以在<code>get pods</code>的时候过滤pods</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>kubectl get pods -l key-value
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>kubectl get pods --show-labels
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>kubectl label pod nginx-taint1 <span class="nv">role</span><span class="o">=</span><span class="nb">test</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>kubectl get pods -l <span class="nv">role</span><span class="o">=</span><span class="nb">test</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>kubectl label pod nginx-taint1 role-
</code></pre></div>
<p><img alt="Label" src="../img/20220429221243.png" /></p>
<h2 id="namespaces">Namespaces</h2>
<p>我们验证namespace操作命令</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>kubectl get namespaces
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>kubectl -n kube-system get pods
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>kubectl create namespaces test-ns
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>kubectl get namespaces
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>kubeclt delete namespaces test-ns
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>也可以用<code>kubectl apply -f namespace.yaml</code>应用namespace设置</p>
<div class="highlight"><span class="filename">namespace.yaml</span><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span><span class="w"></span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span><span class="w"></span>
</code></pre></div>
</div>
<h3 id="monitor">Monitor</h3>
<p>和<code>top</code> 命令一样，kubectl可以监控节点的状态</p>
<ul>
<li><code>kubectl top node</code></li>
<li><code>kubectl -n kube-system top pod</code> 添加<code>-n</code>参数可以限定作用域</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>如果kubeadm部署，则<strong>非常</strong>可能需要手动安装metrics-server</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</code></pre></div>
修改其中的镜像为bitnami/metrics-server，注意tag的不同</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">args</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">        </span><span class="c1">#image: k8s.gcr.io/metrics-server/metrics-server:v0.6.1</span><span class="w"></span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bitnami/metrics-server:0.6.1</span><span class="w"></span>
</code></pre></div>
<p>部署metrics-server</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>kubectl apply -f components.yaml
</code></pre></div>
<p>监控<code>kubectl get pods --all-namespaces</code>，直到<code>metrics-server-xxxxxxxxx-xxxx</code>Pod运行成功</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>如果忘记修改镜像来源，第一次创建的Pod永远失败，就使用<code>kubectl delete deployment metrics-server -n kube-system</code>删除这次失败的部署，然后修改镜像源重新部署。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果遇到metrics-server容器Running而无法Ready，容器日志中出现X509错误，则需要启用serverTLSBootstrap，参考<a href="../cluster.md">部署集群</a>.</p>
<p>也可以在<code>template.containers.args</code>下添加<code>--kubelet-insecure-tls</code>参数忽略证书错误</p>
</div>
<p>总的来说，metrics-server 的正常运行依赖于：</p>
<ol>
<li>Master节点和Metrics Server Pod能够互相联通（kubeadm默认满足）</li>
<li>APIServer 启用聚合支持（kubeadm默认启用）</li>
<li>证书通过CA认证（开启serverTLSBootstrap）</li>
</ol>
<p><img alt="Top command" src="../img/20220430215338.png" /></p>
<h3 id="log">Log</h3>
<p>使用<code>kubectl logs</code>可以查看某一个resource的log</p>
<ul>
<li><code>kubectl logs $RESOURCE_ID</code>: 查看默认命名空间（default）下的<code>$RESOURCE_ID</code>的资源的log</li>
<li><code>kubectl -n $NS logs $RESOURCE_ID</code>: 查看<code>$NS</code>命名空间下的<code>$RESOURCE_ID</code>的资源的log</li>
<li><code>kubectl get event</code> 获得K8S事件</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>kubectl get all</code>可以获取命名空间下所有resource，默认是default命名空间下</p>
</div>
<p>查看一个Pod的日志</p>
<p><img alt="Pod logs" src="../img/20220430215521.png" /></p>
<p>查看集群发生的事件</p>
<p><img alt="Cluster events" src="../img/20220430215537.png" /></p>
<h2 id="pod">Pod</h2>
<p>本章节主要是完成各种Pod部署并查看不同配置文件的内容对Pod/K8S集群的影响</p>
<h3 id="pod-with-1-container">Pod with 1 Container</h3>
<p>部署提供的<code>10_pod1.yaml</code>，该文件描述了一个名为pod1的busybox服务的部署。busybox是一个linux工具集合。它提供了300多个常用的linux命令，并采取复用代码的形式节约了很多空间。容器的入口是运行了<code>/bin/sh -c echo pod1 is running!</code>这条语句，因此容器将很快退出。但是由于其<code>restartPolicy=Always</code>，容器将反复重启。</p>
<div class="highlight"><span class="filename">10_pod1.yaml</span><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod1</span><span class="w"></span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod1</span><span class="w"></span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span><span class="w"></span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-busybox</span><span class="w"></span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox:latest</span><span class="w"></span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;/bin/sh&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-c&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">pod1</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">running!&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>kubectl apply -f 10_pod1.yaml
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>kubectl logs pod1 <span class="c1"># show the echo message</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>kubectl get pods 
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>kubectl describe pod pod1 <span class="c1"># Back-off restarting failed containe</span>
</code></pre></div>
<p>我们观察到，Pod状态会从 Completed 变为 CrashLoopBackOff，原因是 pod 结束后后，因为 RestartPolicy 为 Always，pod重新启动后再次退出，循环往复。</p>
<p><img alt="RestartPolicy=Always" src="../img/20220430231947.png" /></p>
<p><code>11_pod1.yaml</code> 中，<code>restartPolicy</code>被设为了OnFailure</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>kubectl apply -f 11_pod1.yaml
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>kubectl logs pod1 <span class="c1"># show the echo message</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>kubectl get pods <span class="c1"># 状态会为 Completed</span>
</code></pre></div>
<p><img alt="RestartPolicy=OnFailure" src="../img/20220516102312.png" /></p>
<p>容器正常退出，因此不会被重启</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果遇到报错"pod updates may not change fields other than..."错误，则需要删除上一步创建的pod</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>kubectl delete pod pod1
</code></pre></div>
</div>
<p><code>12_pod1.yaml</code> 定义了<code>command: ['/bin/sh', '-c', 'echo pod1 is running! &amp; sleep 3000']</code>，即先打印一句"pod1 is running!"，然后休眠3000秒，在此期间，容器将持续运行但不占用CPU</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>kubectl apply -f 12_pod1.yaml
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>kubectl get pods <span class="c1"># 状态会为 Running</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>kubectl <span class="nb">exec</span> pod1 -- env <span class="c1"># 打印环境变量，这是busybox提供的工具</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>kubectl <span class="nb">exec</span> -it pod1 -- /bin/sh
</code></pre></div>
<p>按下<code>Ctrl-D</code>退出<code>/bin/sh</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>kubectl describe pod pod1 <span class="c1"># get IP address</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="o">[</span>node0<span class="o">]</span> ping <span class="nv">$POD1_IP</span> <span class="c1"># can ping pod1</span>
</code></pre></div>
<p><img alt="Describe pods" src="../img/20220430234401.png" /></p>
<p><img alt="Ping pods" src="../img/20220430234537.png" /></p>
<p>可以看到，由于calico插件的作用，各个node都可以ping通该Pod。其中node1的延迟最小且稳定。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>$POD1_IP 为<code>kubectl describe pod pod1</code>得到的Pod IP地址</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果节点没有配置NodePort/LoadBalancer而只有ClusterIP，那么是无法从集群外访问Pod的。这时候就必须登陆到集群才能Ping该Pod</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>由于该Pod执行的命令是<code>sleep 3000</code>，无法响应K8S给出的信号从而<em>优雅地退出</em>，因此删除容器将会等待较长时间</p>
</div>
<h3 id="pod-with-2-containers-and-shared-emptydir">Pod with 2 Containers and shared EmptyDir</h3>
<p>该文件增加了一个nginx服务。两个服务通过<code>volumeMounts</code>挂载名称为<code>name</code>的数据卷。这个卷是空的</p>
<div class="highlight"><span class="filename">13_pod2.yaml</span><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod2</span><span class="w"></span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data</span><span class="w"></span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">      </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-nginx</span><span class="w"></span>
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:latest</span><span class="w"></span>
<a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data</span><span class="w"></span>
<a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/nginx/html</span><span class="w"></span>
<a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a>
<a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-busybox</span><span class="w"></span>
<a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox:latest</span><span class="w"></span>
<a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data</span><span class="w"></span>
<a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data</span><span class="w"></span>
<a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;/bin/sh&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-c&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">Hello</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">pod2/ct-busybox</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">/data/index.html</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">3000&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>kubectl create -f 13_pod2.yaml
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>kubectl <span class="nb">exec</span> -it pod2 -c ct-nginx -- /bin/bash
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="o">[</span>ct-nginx<span class="o">]</span> $ apt update <span class="o">&amp;&amp;</span> apt install curl <span class="o">&amp;&amp;</span> curl localhost 
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="c1"># get the hello message</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>kubectl get pods -o wide <span class="p">|</span> grep pod2 <span class="c1"># get IP address</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="o">[</span>node0<span class="o">]</span> $ curl <span class="nv">$POD2_IP</span> <span class="c1"># get the hello message</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>$POD2_IP 需要修改成Pod的实际IP</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>create -f</code>等价于<code>apply -f</code>。<code>kubectl create</code>命令可创建新资源。 因此，如果再次运行该命令，则会抛出错误，因为资源名称在名称空间中应该是唯一的。<code>kubectl apply</code>命令将配置应用于资源。 如果资源不在那里，那么它将被创建。 kubectl apply命令可以第二次运行.</p>
</div>
<p>我们接下来将修改网页的内容</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>kubectl <span class="nb">exec</span> -it pod2 -c ct-busybox -- /bin/sh
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="o">[</span>ct-nginx<span class="o">]</span> $ <span class="nb">echo</span> <span class="s2">&quot;Goodbye from the pod2&quot;</span> &gt; /data/index.html
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="o">[</span>node0<span class="o">]</span> curl POD2_IP <span class="c1"># get the new message</span>
</code></pre></div>
<p>网页的内容发生了改变</p>
<p><img alt="Two containers" src="../img/20220501001137.png" />  </p>
<h3 id="pod-with-resource-limitation">Pod with resource limitation</h3>
<p><code>15_pod3.yaml</code>启动了一个<code>stress --vm 1 --vm-bytes 250M --vm-hang 1</code>进程。<code>--vm 1</code>产生一个进程，才进程不断分配和释放内存，内存大小由<code>--vm-bytes 250M</code>定为250MB。<code>--vm-hang 1</code>指定每个消耗内存的进程在分配到内存后转入睡眠状态 1秒</p>
<p>这样的命令明显超出了配置文件中的限制，因此会被杀死.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>kubectl apply -f 15_pod3.yaml 
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="c1"># 这个 pod 状态变为 OOMKilled，因为它是内存不足所以显示容器被杀死</span>
</code></pre></div>
<p><img alt="OOM" src="../img/20220501003914.png" /></p>
<h3 id="pod-with-liveness-check">Pod with Liveness Check</h3>
<p>这一系列实验测试了K8S提供的容器监控手段。</p>
<h4 id="liveness-cmd-check">Liveness CMD Check</h4>
<p><code>20_pod4-liveness-cmd.yaml</code>定义了<code>sh -c cat /tmp/healthy</code>作为监控手段</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>kubectl apply -f 20_pod4-liveness-cmd.yaml
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>kubectl get pods -w <span class="c1">#</span>
</code></pre></div>
<p>我们发现 liveness-exec 的 RESTARTS 在 20 秒后由于检测到不健康一直在重启</p>
<p><img alt="CMD running" src="../img/20220501003956.png" />
<img alt="CMD dead" src="../img/20220501003957.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>kubectl get pods -w</code> 相当于使用watch命令持续检测</p>
<p>容器的restart策略令其不断重启</p>
<p><code>kubectl delete pod pod4-liveness-cmd</code> 可以删除该Pod</p>
</div>
<h4 id="liveness-http-check">Liveness HTTP Check</h4>
<p><code>21_pod5-liveness-http.yaml</code>定义了<code>POD_IP:8080/helthz</code>作为监控手段，并且规定了<code>httpHeader</code>。<code>initialDelaySeconds： 3</code>表示第一次查询等待3秒，<code>periodSeconds: 3</code>表示每次查询间隔3s</p>
<p><code>k8s.gcr.io/liveness</code> 镜像会使 /healthz 服务时好时坏。配置文件中的<code>k8s.gcr.io/liveness</code>镜像国内几乎无法下载，可以更改为<code>registry.hub.docker.com/davidliyutong/liveness</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>kubectl apply -f 21_pod5-liveness-http.yaml
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>kubectl get pods -w
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="o">[</span>node0<span class="o">]</span> $ curl <span class="nv">$POD_IP</span>:8080/healthz
</code></pre></div>
<p><img alt="Liveness Container" src="../img/20220521100411.png" /></p>
<p>可以看到，pod不时重启，curl得到的内容时而OK时而错误</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>$POD_IP 要修改为可访问的IP</li>
<li><code>initialDelaySeconds</code> 要合理设置</li>
<li>metrics-server 就采取了这种方法通告自己存活</li>
</ul>
</div>
<h4 id="liveness-tcp-check">Liveness TCP Check</h4>
<p>TCP 存活检查的实现，和HTTP检查大同小异</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>kubectl apply -f 22_pod6-liveness-tcp.yaml
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>kubectl get pods
</code></pre></div>
<p><img alt="TCP Check" src="../img/20220501122754.png" /></p>
<h3 id="pod-with-nodeselector">Pod with NodeSelector</h3>
<p><code>30_pod7-nodeSelector.yaml</code>中定义的Pod没什么特别的，只是多了<code>nodeSelector.disktype: ssd</code>这一键值对。因此K8S在调度过程中就会寻找包含<code>{disktype: ssd}</code>这一标签的节点</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>kubectl label nodes node1 <span class="nv">disktype</span><span class="o">=</span>ssd
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>kubectl get nodes node1 --show-labels
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>kubectl apply -f 30_pod7-nodeSelector.yaml
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>kubectl get pod -o wide
</code></pre></div>
<div class="admonition node">
<p class="admonition-title">Node</p>
<ul>
<li><code>node1</code> 需要替换成节点的名称</li>
<li>可以用<code>kubectl label nodes node1 disktype-</code>清除标签</li>
<li>可以用<code>kubectl label nodes node1 disktype=hdd --overwrite</code>覆盖标签</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>如果没有节点有该标签，调度将会失败。Pod将会一直处于Pending的状态</p>
</div>
<p>如下图所示，由于没有节点有disktype=hdd标签，该Pod一直处于Pending状态</p>
<p><img alt="NodeSelector" src="../img/20220501123138.png" /></p>
<h3 id="initcontainer">InitContainer</h3>
<p><code>initContainers</code> 可以启动一个容器在主容器前做初始化工作。该容器执行完工作后将会退出，而且不会触发K8S的容器失败重启机制</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>kubectl apply -f 40_pod8-initcontainer.yaml 
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="c1"># the init CT creates the file &#39;testfile&#39;</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>kubectl <span class="nb">exec</span> pod8-initcontainer -- ls /storage/ 
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="c1"># the testfile exists</span>
</code></pre></div>
<h3 id="static-pod">Static Pod</h3>
<p>kubelet会自动启动<code>/etc/kubernetes/manifests/</code>下配置文件定义的 static pod</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="o">[</span>node0<span class="o">]</span> $ mv 42_pod9-static.yaml /etc/kubernetes/manifests/ 
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>kubectl get pod
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>kubectl delete pod pod8-static
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>kubectl get pod <span class="c1"># 看到有删除该 pod，但是不会生效</span>
</code></pre></div>
<p><img alt="Static Pod" src="../img/20220501123645.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>设置stait pod的重点是将pod配置文件存放在控制平面节点的<code>/etc/kubernetes/manifests/</code>目录下。如果是远程访问节点，就需要将该文件通过scp等工具拷贝到相应目录：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>scp 42_pod9-static.yaml root@node0:/etc/kubernetes/manifests/
</code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>切不可删除<code>/etc/kubernetes/manifests/</code>目录来取消<code>42_pod8-static.yaml</code>配置文件的加载。这是因为该目录下还有很多其他关键的staitc pod</p>
</div>
<h2 id="workload">Workload</h2>
<h3 id="replicaset">ReplicaSet</h3>
<p>对<code>10_replicaset1.yaml</code>注解如下</p>
<div class="highlight"><span class="filename">10_replicaset1.yaml</span><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReplicaSet</span><span class="w"></span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replicaset1</span><span class="w"></span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="w">    </span><span class="nt">label-rep</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">value-rep</span><span class="w"></span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"> </span><span class="c1"># 两个副本</span><span class="w"></span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c1"># 定义两个副本的策略的应用范围</span><span class="w"></span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> </span><span class="c1"># 使用matchLabel策略</span><span class="w"></span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="w">      </span><span class="nt">label-pod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">value-pod</span><span class="w"> </span><span class="c1"># 匹配spec.template.metadata.labbels</span><span class="w"></span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="w">        </span><span class="nt">label-pod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">value-pod</span><span class="w"> </span><span class="c1"># 和spec.selector.matchLabels保持一致</span><span class="w"></span>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c1"># 创建了一个nginx容器</span><span class="w"></span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.9.0</span><span class="w"></span>
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>kubectl apply -t 10_replicaset1.yaml <span class="c1"># create replicaset</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>kubectl get replicasets <span class="c1"># list replicasets</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>kubectl delete replicasets replicaset1 <span class="c1"># delete replicaset</span>
</code></pre></div>
<p><img alt="Replicaset" src="../img/20220501135939.png" /></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>kubectl delete replicasets replicaset1</code>或者<code>kubectl delete -f 10_replicaset1.yaml</code>可以撤销更改</p>
</div>
<p>对<code>12_replicaset2-node-selector.yaml</code>注解如下</p>
<div class="highlight"><span class="filename">12_replicaset2-node-selector.yaml</span><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReplicaSet</span><span class="w"></span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span><span class="w"></span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span><span class="w"></span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">nodeSelector</span><span class="p p-Indicator">:</span><span class="w"></span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="w">        </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xxx</span><span class="w"> </span><span class="c1"># 和之前的实验一样，限定这个ReplicaSet只选择带有zone=xxx标签的节点</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>kubectl label nodes <span class="nv">$NODE_ID</span> <span class="nv">zone</span><span class="o">=</span>xxx
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>kubectl apply -f 12_replicaset2-node-selector.yaml
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>kubectl label nodes <span class="nv">$NODE_ID</span> zone- <span class="c1"># unlabel zone</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>kubectl label nodes <span class="nv">$NODE_ID</span> <span class="nv">zone</span><span class="o">=</span>yyy
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>kubectl delete -f 12_replicaset2-node-selector.yaml <span class="c1"># re-deploy</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>kubectl apply -f 12_replicaset2-node-selector.yaml
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="c1"># all the pods are pending since they cannot find a node</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>kubectl label nodes <span class="nv">$NODE_ID</span> zone- <span class="c1"># unlabel zone</span>
</code></pre></div>
<p><img alt="NodeSelector" src="../img/20220501142100.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>调度完成后，删除或者修改标签，都不会使得已经调度的Node重新变为Pending。此时如果重新应用配置，kubectl将不会做出更改（因为配置文件没变）。只有删除配置文件后修改Label，再重新部署配置，Pod才会因为找不到合适的Node而变为Pending状态</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>$NODE_ID</code>要替换成集群中某一节点的实际ID
<code>zone=xxx</code>是一个标记node属于哪一个区的手段，对应<code>12_replicaset2-node-selector.yaml</code>中的<code>spec.template.spec.nodeSelector</code></p>
</div>
<h3 id="deployment">Deployment</h3>
<h4 id="by-cmd">by CMD</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>kubectl run dep-nginx --image<span class="o">=</span>nginx:1.9.0 --image-pull-policy<span class="o">=</span>IfNotPresent
</code></pre></div>
<p><img alt="Deployment by CMD" src="../img/20220501142824.png" />  </p>
<p>可以看到，<code>kubectl run</code>只是启动了一个Pod</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>K8S v1.18后，官方弃用了<code>--replicas=2</code>这一Flag，因此命令需要修改成</p>
</div>
<h4 id="scale-upgrade">Scale &amp; upgrade</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>kubectl apply -f 20_deployment1.yaml <span class="c1"># create a deployment with 2 replicas</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>kubectl get deployment
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>kubectl get pods -o wide <span class="c1"># get pod IP</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="o">[</span>node0<span class="o">]</span> $ curl <span class="m">10</span>.233.166.149 <span class="c1"># check the Nginx server</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>10.233.166.149</code>为Pod的ClusterIP，需要登陆集群访问</p>
</div>
<p><img alt="Deployment" src="../img/20220501143049.png" /></p>
<p>下列语句允许我们：</p>
<ul>
<li>将该服务拓展到三个副本</li>
<li>升级服务的镜像（滚动更新）</li>
<li>对服务的部署进行回滚</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>kubectl scale deployment deployment1 --replicas<span class="o">=</span><span class="m">3</span> <span class="c1"># scale out</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>kubectl <span class="nb">set</span> image deployment deployment1 <span class="nv">nginx</span><span class="o">=</span>nginx:stable --record 
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="c1"># upgrade image</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>kubectl get pods -o wide
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>kubectl rollout <span class="nb">history</span> deployment deployment1 <span class="c1"># 查看history</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>kubectl rollout <span class="nb">history</span> deployment deployment1 --revision<span class="o">=</span><span class="m">1</span> <span class="c1"># 查看版本1细节</span>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>kubectl rollout undo deployment deployment1 --to-revision<span class="o">=</span><span class="m">1</span> <span class="c1"># 退回到版本1</span>
</code></pre></div>
<p><img alt="Deployment revision" src="../img/20220501144552.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>v1.23.6客户端提示<code>--record</code>已经被弃用了，并且会被一种新的机制取代。详见<a href="https://github.com/kubernetes/kubernetes/pull/102873">PR#102873</a>
<code>deployment1</code>为deployment的ID</p>
</div>
<h4 id="horizontal-pod-autoscalerhpa">Horizontal Pod Autoscaler(HPA)</h4>
<p>Horizontal Pod Autoscaler(HPA) 是K8S的一种资源对象，能够根据某些指标对在statefulSet、replicaController、replicaSet等集合中的Pod数量进行动态伸缩，使运行在上面的服务对指标的变化有一定的自适应能力。</p>
<p>为了访问指标数据，需要安装<strong>metric-server</strong>，如果集群支持<code>kubectl top</code>命令，则该服务可能已经安装了</p>
<p>对<code>22_deployment2-hpa.yaml</code>解释如下：</p>
<div class="highlight"><span class="filename">22_deployment2-hpa.yaml</span><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"></span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deployment2-hpa-service</span><span class="w"></span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
</code></pre></div>
<p>和普通的Deployment相比，不仅添加了CPU/内存的限制，还新增了一个Service资源，将Pod包装成了服务。这样一来<code>kubectl autoscale</code>就可以对其操作，使其根据CPU指标进行放缩</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>kubectl apply -f 22_deployment2-hpa.yaml
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>kubectl autoscale deployments deployment2-hpa --min<span class="o">=</span><span class="m">1</span> --max<span class="o">=</span><span class="m">5</span> --cpu-percent<span class="o">=</span><span class="m">10</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>kubectl get hpa
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>kubectl run -it --rm load-generator --image<span class="o">=</span>busybox /bin/sh
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="o">[</span>ct<span class="o">]</span> $ <span class="k">while</span> true<span class="p">;</span> <span class="k">do</span> wget -q -O- http://deployment2-hpa-service<span class="p">;</span> <span class="k">done</span>
</code></pre></div>
<p><img alt="HPA" src="../img/20220501150016.png" /></p>
<p>运行一段时间后，发现TARGET发生了变化</p>
<p><img alt="HPA change" src="../img/20220501150231.png" /></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>kubectl run --rm</code>可以看做<code>docker run</code>在集群上的表现。<code>kubectl --rm</code>可以在命令结束后删除Pod，正如<code>docker --rm</code>在命令结束后删除容器一样</p>
</div>
<h3 id="daemonset">DaemonSet</h3>
<p>DaemonSet保证每个节点上都有一个此类 Pod 运行。节点可能是所有集群节点也可能是通过 nodeSelector 选定的一些特定节点。典型的后台支撑型服务包括存储、日志和监控等在每个节点上支撑 K8s 集群运行的服务。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>kubectl taint node node1 node-role.kubernetes.io/master<span class="o">=</span>:NoSchedule 
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>kubectl describe node node1 <span class="p">|</span> grep Taints
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>kubectl apply -f 20_deployment1.yaml <span class="c1"># pod不会调度到node1上</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>kubectl apply -f 24_daemonset.yaml <span class="c1"># pod可以调度到所有节点，忽略taint</span>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>kubectl get pods -o wide
</code></pre></div>
<p><img alt="DaemonSet" src="../img/20220501163324.png" /></p>
<h3 id="job">Job</h3>
<p>Job 管理的 Pod根据用户的设置把任务成功完成就自动退出了，而长期伺服业务在用户不停止的情况下永远运行。</p>
<h4 id="lab-simple-job">Lab - Simple Job</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>kubectl apply -f 30_job1.yaml
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>kubectl get <span class="nb">jobs</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>kubectl get pods
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>kubectl logs job1-xxxx
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>kubectl apply -f 31_job2.yaml
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>kubectl get <span class="nb">jobs</span>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>kubectl get pods
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>kubectl logs job2-xxxx
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>kubectl delete <span class="nb">jobs</span> --all
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>kubectl get <span class="nb">jobs</span>
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>kubectl get pods
</code></pre></div>
<p><img alt="Simple job" src="../img/20220501163927.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>job1-xxxx</code>需要替换为为具体的Job ID
<code>kubectl delete jobs.batch --all</code>可以删除所有的Jobs</p>
</div>
<h4 id="lab-completion-job">Lab - Completion Job</h4>
<p>Job 会启动多个 pod 完成completion</p>
<ul>
<li>completions：总共需要执行 job 的次数</li>
<li>parallelism：并行执行 job 数</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>kubectl apply -f 32_job3-completion.yaml
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>kubectl get pod -w
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>kubectl get job
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>kubectl logs job3-xxx
</code></pre></div>
<p><img alt="Completion job" src="../img/20220501164110.png" />  </p>
<h4 id="lab-cronjob">Lab - Cronjob</h4>
<p>CronJob 即定时任务，就类似于 Linux 系统的 crontab，在指定的时间周期运行指定的任务。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>1.21版本以前使用 CronJob 需要开启batch/v2alpha1 API。1.21版本以后，CronJob被纳入了<code>batch/v1</code>中</p>
</div>
<ul>
<li><code>.spec.schedule</code> 指定任务运行周期，格式同Cron 分  时  日  月  周</li>
<li><code>.spec.jobTemplate</code> 指定需要运行的任务，格式同Job</li>
<li><code>.spec.startingDeadlineSeconds</code> 指定任务开始的截止期限</li>
<li><code>.spec.concurrencyPolicy</code> 指定任务的并发策略，支持Allow、Forbid和Replace三个选项</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>kubectl apply -f 34_cronjob1.yaml
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>kubectl get cronjobs
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>kubectl get pod -w
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>kubectl logs cronjob1-xxxxxxxx-yyyyy
</code></pre></div>
<p><img alt="CronJobs" src="../img/20220501171347.png" /></p>
<h2 id="service">Service</h2>
<p>Service 的主要作用是作为 Pod 的代理入口，从而代替Pod对外暴露一个固定的网络地址</p>
<p>K8S集群Service类型有多种</p>
<ul>
<li>ClusterIP 分配一个集群内IP（默认）</li>
<li>NodePort 绑定到一个Node的IP</li>
<li>ExternalName 使用外部DNS</li>
<li>LoadBalancer 使用外部负载均衡</li>
</ul>
<h3 id="nodeport">NodePort</h3>
<p>一些解读：</p>
<div class="highlight"><span class="filename">10_service1-nodePort.yaml</span><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"></span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service1-node-port</span><span class="w"></span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"> </span><span class="c1"># 选择了上文定义的带有app=nginx标签的Pod</span><span class="w"></span>
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span><span class="w"> </span><span class="c1"># 指定Type</span><span class="w"></span>
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span><span class="w"> </span><span class="c1"># 转发TCP端口</span><span class="w"></span>
<a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"> </span><span class="c1"># Pod内的80</span><span class="w"></span>
<a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8888</span><span class="w"> </span><span class="c1"># Node 的 8888</span><span class="w"></span>
<a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30888</span><span class="w"> </span><span class="c1"># 集群的出口的30888</span><span class="w"></span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>为什么需要selector：因为service可以和pod分开配置。当分开配置的时候，就非常有必要制定service作用的Pod了。而这是通过selector完成的</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>kubectl apply -f 10_service1-nodePort.yaml
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>kubectl get svc -o wide  <span class="c1"># get the random node_port</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>curl k8s-jcloud.ice6413p.space:30888 <span class="c1"># it works, even with Docker-for-Desktop</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>k8s-jcloud.ice6413p.space解析到了集群节点的外部IP上</p>
</div>
<p><img alt="NodePort" src="../img/20220501193436.png" /></p>
<h3 id="clusterip">ClusterIP</h3>
<div class="highlight"><span class="filename">15_service2-clusterIP.yaml</span><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="nn">...</span><span class="w"></span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"></span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service2-cluster-ip</span><span class="w"></span>
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span><span class="w"></span>
<a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span><span class="w"></span>
<a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
<a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8889</span><span class="w"></span>
</code></pre></div>
<p>该配置文件没有在集群IP上创建端口</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>kubectl apply -f 15_service2-clusterIP.yaml
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>kubectl get svc -o wide <span class="c1"># get the clusterIP and port of the service</span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>kubectl get pods -o wide
</code></pre></div>
<p><img alt="Apply Cluster IP" src="../img/20220501194733.png" /></p>
<p>可以看到该服务被分配了<code>10.109.180.174</code>的ServiceIP，并且被调度到了node2上。使用curl/ping测试可以发现</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>curl <span class="m">10</span>.119.11.125:8889
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>curl <span class="m">10</span>.119.11.103:8889
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>curl <span class="m">10</span>.119.11.113:8889
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="o">[</span>node0<span class="o">]</span> $ curl clusterIP:clusterPort  
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="o">[</span>node0<span class="o">]</span> $ curl node2:80
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="o">[</span>node0<span class="o">]</span> $ curl node2:8889
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="o">[</span>node0<span class="o">]</span> $ ping podIP
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="o">[</span>node0<span class="o">]</span> $ ping serviceIP<span class="o">(</span>clusterIP<span class="o">)</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>clusterIP</p>
<p><code>10.119.11.125</code>、 <code>10.119.11.103</code>、 <code>10.119.11.113</code>为集群的外部IP地址</p>
</div>
<p><img alt="Curl/Ping test" src="../img/20220501200553.png" /></p>
<ul>
<li>该服务的ClusterIP/ServiceIP只能在集群内部访问</li>
<li>ClusterIP不同于NodeIP，并没有绑定到Node上，不能通过node的主机名访问</li>
<li>可以ping通ClusterIP（一般是不行的）</li>
<li>存在名为kubernetes的service，提供了10.96.0.1集群的DNS</li>
</ul>
<p><strong>总结一下</strong></p>
<ol>
<li>Cluster IP只能和K8S SVC这个对象绑定组成一个具体的通信接口。单独的Cluster IP不具备通信的基础，并且他们属于Kubernetes集群这样一个封闭的空间。</li>
<li>如果K8S使用的是iptables，Cluster IP无法被ping，他没有一个“实体网络对象”来响应。但是如果K8S使用了IPVS，则该IP可以被ping，因为IPVS创建了一个虚拟的网卡。</li>
<li>通过Cluster IP，不同SVC下的Pod节点在K8S集群间可以相互访问。</li>
</ol>
<h3 id="expose-cmd">Expose CMD</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a>kubectl apply -f 20_service3-pod-cmd.yaml
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>kubectl expose pod pod-service3 --type<span class="o">=</span>NodePort --target-port<span class="o">=</span><span class="m">80</span> --port<span class="o">=</span><span class="m">8888</span> 
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>kubectl expose</code>手动暴露了一个已经部署的Pod，类型是NodePort</p>
</div>
<p>我们试图用curl访问该服务，但是失败了</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a>curl k8s-jcloud.ice6413p.space:8888
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>curl <span class="m">10</span>.119.11.125:8888
</code></pre></div>
<p><img alt="Curl Failed" src="../img/20220501201409.png" />  </p>
<p>这是因为我们没有在expose命令中指定<code>--node-port</code>，因此K8S在node上随机选择了端口。我们使用<code>kubectl get svc -o wide</code> 查看详情</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a>$ kubectl get svc -o wide
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>NAME           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE     SELECTOR
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a>kubernetes     ClusterIP   <span class="m">10</span>.96.0.1        &lt;none&gt;        <span class="m">443</span>/TCP          28h     &lt;none&gt;
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>pod-service3   NodePort    <span class="m">10</span>.104.185.204   &lt;none&gt;        <span class="m">8888</span>:31297/TCP   6m50s   <span class="nv">app</span><span class="o">=</span>nginx
</code></pre></div>
<p>可以看到该服务<code>pod-service3</code>被转发到了node2的31297端口。测试之</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>curl <span class="m">10</span>.119.11.125:31297
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="o">[</span>node0<span class="o">]</span> $ curl <span class="m">10</span>.104.185.204:8888
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>10.119.11.125</code>是node2的IP</p>
</div>
<p><img alt="Get real port and test" src="../img/20220501201742.png" /></p>
<p>发现其正常工作</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>通过命令行指定--nodePort是很麻烦的，需要用到<code>--overrides</code>参数</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>kubectl expose pod pod-service3 --type<span class="o">=</span>NodePort --target-port<span class="o">=</span><span class="m">80</span> --port<span class="o">=</span><span class="m">8888</span> <span class="se">\</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>--overrides <span class="s1">&#39;{ &quot;apiVersion&quot;: &quot;v1&quot;,&quot;spec&quot;:{&quot;ports&quot;: [{&quot;port&quot;:8888,&quot;protocol&quot;:&quot;TCP&quot;,&quot;targetPort&quot;:80,&quot;nodePort&quot;:38888}]}}&#39;</span>
</code></pre></div>
</div>
<h3 id="health-check">Health Check</h3>
<p>如果没有 health check，有些服务会报错</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>kubectl apply -f 30_service4-health-check.yaml
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>kubectl expose deployment service4-dep-health-check
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>kubectl get svc
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="o">[</span>node0<span class="o">]</span> $ curl <span class="m">10</span>.100.97.250:8080 <span class="c1"># doesn&#39;t work with Docker-for-Desktop</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>kubectl get pods
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>10.100.97.250</code> 为clusterIP</p>
</div>
<p><img alt="Health check failed" src="../img/20220513175245.png" /></p>
<h3 id="external-service">External Service</h3>
<p>Endpoint 可以将Service和一个集群外的服务链接。</p>
<div class="highlight"><span class="filename">40_service5-endpoint.yaml</span><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"></span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service5-endpoints</span><span class="w"></span>
<a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span><span class="w"></span>
<a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30888</span><span class="w"></span>
<a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>我们没有指定该Service的type，因此创建的是ClusterIP服务</p>
<p>我们没有指定该Service的<code>selector</code>，因此该Service只能指向外部服务</p>
</div>
<div class="highlight"><span class="filename">41_endpoints.yaml</span><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Endpoints</span><span class="w"></span>
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service5-endpoints</span><span class="w">  </span><span class="c1"># should be the same as the service name</span><span class="w"></span>
<a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="nt">subsets</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">addresses</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.64.13.10</span><span class="w"> </span><span class="c1"># Node0的IP</span><span class="w"></span>
<a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"></span>
</code></pre></div>
<p>官方文档的说法是，Endpoint在一下几种情况下发挥作用：</p>
<ol>
<li>希望在生产环境中使用外部的数据库集群，但测试环境使用自己的数据库。</li>
<li>希望服务指向另一个 名字空间（Namespace） 中或其它集群中的服务。</li>
<li>你正在将工作负载迁移到 Kubernetes。 在评估该方法时，你仅在 Kubernetes 中运行一部分后端。</li>
</ol>
<p>为了达到这几个目的，我们可以：</p>
<ol>
<li>创建一个<strong>抽象的</strong>Service，约定该Service提供服务的IP和端口（clusterIP:clusterPort），供前端访问。</li>
<li>创建一个<code>Endpoint</code>，将这个Service转发到其他应用上去。通过修改Endpoint，我们可以更换这个被转发的应用。只需要修改Endpoint就可以从测试阶段转移到生产阶段，而无需修改Service。</li>
</ol>
<p>自然的，Endpoint需要和Service建立联系。因此他们的metadata.name必须一致。我们可以发现，Endpoint处理的是服务的抽象和接口</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Endpoint 中的name要和Service中的一样</p>
</div>
<p>由于我们是多节点的K8S集群，因此需要修改<code>41_endpoints.yaml</code>中的地址（一个有着多节点集群的本地回环地址是不明确的），填写一个确定的服务的IP地址。这个IP地址可以是一个ClusterIP服务的地址，也可以是一个NodePort服务的地址，甚至是集群外的地址。这里我们选择在node0（IP:10.64.13.10)）上启动一个python web server</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>kubectl apply -f 40_service5-endpoints.yaml
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>kubectl apply -f 41_endpoints.yaml
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a>kubectl get endpoints <span class="c1"># list</span>
<a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a>kubectl describe endpoints service5-endpoints <span class="c1"># ep use the same name as svc</span>
</code></pre></div>
<p><img alt="Description of endpoint" src="../img/20220501213115.png" /></p>
<p>我们可以查看服务情况</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>$ kubectl get svc
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a>NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>kubernetes           ClusterIP   <span class="m">10</span>.96.0.1      &lt;none&gt;        <span class="m">443</span>/TCP   30h
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>service5-endpoints   ClusterIP   <span class="m">10</span>.103.23.79   &lt;none&gt;        <span class="m">80</span>/TCP    5m48s
</code></pre></div>
<p>service5-endpoints的ClusterIP为<code>10.103.23.79</code>，登陆集群的节点，然后测试该服务</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="o">[</span>node0<span class="o">]</span> $ curl <span class="m">10</span>.103.23.79:80
</code></pre></div>
<p><img alt="Test endpoint" src="../img/20220501213353.png" />  </p>
<p>可以看到，我们为运行在<code>10.64.13.10:8000</code>上的python web server创建了<code>10.103.23.79:80</code>接口。在工程实践时，我们可以很快的设定一个Service的接口，然后分发给前端团队。他们可以在此基础上开发前端应用。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<ul>
<li>kubernets的DNS服务就是以这种形式存在的</li>
<li>如果需要跟踪多个IP：</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">addresses</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="w">     </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;IP&gt;</span><span class="w"></span>
<a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="w">     </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;IP&gt;</span><span class="w"></span>
<a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="w">     </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;IP&gt;</span><span class="w"></span>
</code></pre></div>
</div>
<h3 id="headless-service">Headless Service</h3>
<p>有时不需要或不想要负载均衡，以及单独的 Service IP。 遇到这种情况，可以通过指定 Cluster IP（spec.clusterIP）的值为 "None" 来创建 Headless Service。客户端通过查询集群的DNS（默认是10.96.0.10）确定Pod的IP，而不分配服务IP。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>这种Service依赖Label Selector来选择容器</p>
</div>
<p>观察配置文件。该文件定义了一个service，它将选择拥有<code>k8s-app=headless-nginx</code>的Pod。它还定义了一个Deployment，该Deployment将产生一个拥有两个副本的Nginx服务</p>
<div class="highlight"><span class="filename">50_svc-headless.yaml</span><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"></span>
<a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-headless</span><span class="w"></span>
<a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c1"># 匹配 spec.template.metadata</span><span class="w"></span>
<a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headless-nginx</span><span class="w"> </span>
<a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"> </span><span class="c1"># 代理端口</span><span class="w"></span>
<a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">None</span><span class="w"> </span><span class="c1"># 不分配clusterIP</span><span class="w"></span>
<a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>
<a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a>
<a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<a id="__codelineno-90-16" name="__codelineno-90-16" href="#__codelineno-90-16"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-17" name="__codelineno-90-17" href="#__codelineno-90-17"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-headless</span><span class="w"></span>
<a id="__codelineno-90-18" name="__codelineno-90-18" href="#__codelineno-90-18"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-19" name="__codelineno-90-19" href="#__codelineno-90-19"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"> </span><span class="c1"># 两个副本</span><span class="w"></span>
<a id="__codelineno-90-20" name="__codelineno-90-20" href="#__codelineno-90-20"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-21" name="__codelineno-90-21" href="#__codelineno-90-21"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> </span><span class="c1"># 匹配 spec.template.metadata</span><span class="w"></span>
<a id="__codelineno-90-22" name="__codelineno-90-22" href="#__codelineno-90-22"></a><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headless-nginx</span><span class="w"></span>
<a id="__codelineno-90-23" name="__codelineno-90-23" href="#__codelineno-90-23"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-24" name="__codelineno-90-24" href="#__codelineno-90-24"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-25" name="__codelineno-90-25" href="#__codelineno-90-25"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-26" name="__codelineno-90-26" href="#__codelineno-90-26"></a><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headless-nginx</span><span class="w"> </span><span class="c1"># 匹配 spec.selector.matchLabels</span><span class="w"></span>
<a id="__codelineno-90-27" name="__codelineno-90-27" href="#__codelineno-90-27"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-28" name="__codelineno-90-28" href="#__codelineno-90-28"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c1"># 启动了一个ngixn容器</span><span class="w"></span>
<a id="__codelineno-90-29" name="__codelineno-90-29" href="#__codelineno-90-29"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-90-30" name="__codelineno-90-30" href="#__codelineno-90-30"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-90-31" name="__codelineno-90-31" href="#__codelineno-90-31"></a><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-90-32" name="__codelineno-90-32" href="#__codelineno-90-32"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-90-33" name="__codelineno-90-33" href="#__codelineno-90-33"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
<a id="__codelineno-90-34" name="__codelineno-90-34" href="#__codelineno-90-34"></a><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-35" name="__codelineno-90-35" href="#__codelineno-90-35"></a><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-90-36" name="__codelineno-90-36" href="#__codelineno-90-36"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;200Mi&quot;</span><span class="w"></span>
<a id="__codelineno-90-37" name="__codelineno-90-37" href="#__codelineno-90-37"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500m&quot;</span><span class="w"></span>
</code></pre></div>
<p>应用该配置文件。我们可以看到，K8S为该Service创建了两个Endpoint，分别指向两个副本</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>kubectl create -f 50_svc-headless.yaml
<a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>kubectl describe svc svc-headless
</code></pre></div>
<p><img alt="Headless Service" src="../img/20220501224513.png" />  </p>
<p>该Service将在K8S集群的DNS中产生一条新的解析<code>svc-headless.default.svc.cluster.local</code>。我们可以用nslookup工具查询该名称在K8S的DNS服务器（10.96.0.10）的解析结果</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="o">[</span>node0<span class="o">]</span> $ nslookup svc-headless.default.svc.cluster.local <span class="m">10</span>.96.0.10
</code></pre></div>
<p><img alt="DNS Lookup" src="../img/20220501224621.png" /></p>
<p>可以看到DNS服务返回了两个IP地址</p>
<h2 id="storage">Storage</h2>
<p>一些名词的解释</p>
<ul>
<li>PersistentVolume（PV）: 持久卷</li>
<li>PersistentVolumeClaim（PVC）: 持久化卷声明</li>
</ul>
<h3 id="etcd-based-storage">etcd-based Storage</h3>
<p>主要有两种基于ETCD的存储</p>
<ol>
<li>ConfigMap，保存配置文件等非敏感信息</li>
<li>Secret，保存敏感信息</li>
</ol>
<h4 id="configmap">ConfigMap</h4>
<blockquote>
<p>ConfigMap is an API object used to store non-confidential data in key-value pairs</p>
</blockquote>
<p>ConfigMap 是一个持久化的KV数据库，用来保存<strong>非敏感信息</strong>。Pod可以讲ConfigMap用于环境变量、命令行参数，也可以当作卷中的一个配置文件</p>
<p>创建ConfigMap的初中时讲配置数据和程序代码分开存放</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ConfigMap保存的数据量不能超过1MiB</p>
</div>
<p>有两种使用ConfigMap的方法</p>
<ul>
<li>变量 (key-value): 如果挂载ConfigMap，则卷中会多出以key为名称的文件，内容是value</li>
<li>文件: ConfigMap显示成一个完整的文件</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>ConfigMap 常用<code>cm</code>代替</p>
</div>
<p><strong>实验</strong></p>
<ol>
<li>
<p>从yaml创建ConfigMap。首先是对<code>10_cm1-pod-env.yaml</code>的一些解读</p>
<div class="highlight"><span class="filename">10_cm1-pod-env.yaml</span><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span><span class="w"></span>
<a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1</span><span class="w"> </span><span class="c1"># 名称，独一无二的</span><span class="w"></span>
<a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a><span class="nt">data</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a><span class="nt">special.how</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">very</span><span class="w"></span>
<a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a><span class="nt">special.type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">charm</span><span class="w"></span>
<a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a>
<a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a>
<a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-93-12" name="__codelineno-93-12" href="#__codelineno-93-12"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-93-13" name="__codelineno-93-13" href="#__codelineno-93-13"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-93-14" name="__codelineno-93-14" href="#__codelineno-93-14"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1-pod-env</span><span class="w"></span>
<a id="__codelineno-93-15" name="__codelineno-93-15" href="#__codelineno-93-15"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-93-16" name="__codelineno-93-16" href="#__codelineno-93-16"></a><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<a id="__codelineno-93-17" name="__codelineno-93-17" href="#__codelineno-93-17"></a><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-93-18" name="__codelineno-93-18" href="#__codelineno-93-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-debian</span><span class="w"></span>
<a id="__codelineno-93-19" name="__codelineno-93-19" href="#__codelineno-93-19"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">debian:latest</span><span class="w"></span>
<a id="__codelineno-93-20" name="__codelineno-93-20" href="#__codelineno-93-20"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;env</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">3000&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># 模拟一个持续运行的服务</span><span class="w"></span>
<a id="__codelineno-93-21" name="__codelineno-93-21" href="#__codelineno-93-21"></a><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c1"># 设定容器的环境变量</span><span class="w"></span>
<a id="__codelineno-93-22" name="__codelineno-93-22" href="#__codelineno-93-22"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SPECIAL_LEVEL_KEY</span><span class="w"> </span><span class="c1"># 环境变量的名称</span><span class="w"></span>
<a id="__codelineno-93-23" name="__codelineno-93-23" href="#__codelineno-93-23"></a><span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"> </span><span class="c1"># 值的来源</span><span class="w"></span>
<a id="__codelineno-93-24" name="__codelineno-93-24" href="#__codelineno-93-24"></a><span class="w">            </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-93-25" name="__codelineno-93-25" href="#__codelineno-93-25"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1</span><span class="w"> </span><span class="c1"># 和ConfigMap的名字一样</span><span class="w"></span>
<a id="__codelineno-93-26" name="__codelineno-93-26" href="#__codelineno-93-26"></a><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">special.how</span><span class="w"> </span><span class="c1"># ConfigMap对应的键值</span><span class="w"></span>
<a id="__codelineno-93-27" name="__codelineno-93-27" href="#__codelineno-93-27"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SPECIAL_TYPE_KEY</span><span class="w"></span>
<a id="__codelineno-93-28" name="__codelineno-93-28" href="#__codelineno-93-28"></a><span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-93-29" name="__codelineno-93-29" href="#__codelineno-93-29"></a><span class="w">            </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-93-30" name="__codelineno-93-30" href="#__codelineno-93-30"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1</span><span class="w"></span>
<a id="__codelineno-93-31" name="__codelineno-93-31" href="#__codelineno-93-31"></a><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">special.type</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a>kubectl apply -f 10_cm1-pod-env.yaml 
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a>kubectl <span class="nb">exec</span> cm1-pod-env -- env <span class="c1"># display the env variables</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>kubectl delete -f 10_cm1-pod-env.yaml <span class="c1"># 删除部署的Pod和ConfigMap</span>
</code></pre></div>
<p><img alt="Create from YAML" src="../img/20220502132431.png" />  </p>
</li>
<li>
<p>从一个主机目录创建ConfigMap。<code>./configs</code>中的内容如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a>$ tree .
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a>.
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a>├── db.conf
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>├── key1
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a>└── key2
</code></pre></div>
<p>```conf title="./configs/db.conf
key3=value3
key4=value4
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>```text title=&quot;./configs/key1&quot;
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a>value1
</code></pre></div></p>
<div class="highlight"><span class="filename">./configs/key2</span><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a>value2
</code></pre></div>
<p>创建命令你如下，其中<code>cm2</code>为ConfigMap的识别名称</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a>kubectl create configmap cm2 --from-file<span class="o">=</span>./configs
</code></pre></div>
<p>从该目录创建ConfigMap后，使用<code>kubectl describe cm cm2</code>可以得到ConfigMap的值</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a>kubectl describe cm cm2
</code></pre></div>
<p><img alt="Create form path" src="../img/20220502132644.png" /></p>
</li>
<li>
<p>从文件创建ConfigMap同理</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a>kubectl create configmap cm3 --from-file<span class="o">=</span>./configs/db.conf
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a>kubectl describe cm cm3
</code></pre></div>
<p><img alt="Create from file" src="../img/20220502133143.png" /></p>
</li>
<li>
<p>从一个键值对创建ConfigMap</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a>kubectl create configmap cm4 --from-literal<span class="o">=</span><span class="nv">key5</span><span class="o">=</span>value5 
<a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a>kubectl describe cm cm4
</code></pre></div>
<p><img alt="Create from KV" src="../img/20220502133342.png" /></p>
</li>
<li>
<p>可以将ConfigMap的键值对映射成环境变量。对<code>12_cm1-pod2-env.yaml</code>的注解如下</p>
<div class="highlight"><span class="filename">12_cm1-pod2-env.yaml</span><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1-pod2-env</span><span class="w"></span>
<a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-busybox</span><span class="w"> </span><span class="c1"># 容器名称</span><span class="w"></span>
<a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">radial/busyboxplus:latest</span><span class="w"></span>
<a id="__codelineno-102-10" name="__codelineno-102-10" href="#__codelineno-102-10"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-102-11" name="__codelineno-102-11" href="#__codelineno-102-11"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;env</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000000&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span>
<a id="__codelineno-102-12" name="__codelineno-102-12" href="#__codelineno-102-12"></a><span class="w">    </span><span class="c1"># 调用容器内的env命令输出环境变量，保存到输出</span><span class="w"></span>
<a id="__codelineno-102-13" name="__codelineno-102-13" href="#__codelineno-102-13"></a><span class="w">    </span><span class="nt">envFrom</span><span class="p">:</span><span class="w"> </span><span class="c1"># 环境变量的来源</span><span class="w"></span>
<a id="__codelineno-102-14" name="__codelineno-102-14" href="#__codelineno-102-14"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">configMapRef</span><span class="p">:</span><span class="w"> </span><span class="c1"># 引用一个ConfigMap</span><span class="w"></span>
<a id="__codelineno-102-15" name="__codelineno-102-15" href="#__codelineno-102-15"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1</span><span class="w"> </span><span class="c1"># ConfigMap的名称</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a>kubectl apply -f 12_cm1-pod2-env.yaml
<a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a>kubectl logs cm1-pod2-env <span class="c1"># 查看容器的输出</span>
</code></pre></div>
<p><img alt="Pass ConfigMap as ENV" src="../img/20220502133939.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>可以看到很多<code>KUBERNETES</code>开头的环境变量，这些变量可以让容器知道自己运行在K8S集群中，并且访问集群服务</p>
</div>
</li>
<li>
<p>将ConfigMap等内容以环境变量的形式传递，可以选择传递哪些值、以怎样的名称传递。</p>
<div class="highlight"><span class="filename">14_cm1-pod3-env</span><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1-pod3-env</span><span class="w"></span>
<a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-busybox</span><span class="w"></span>
<a id="__codelineno-104-9" name="__codelineno-104-9" href="#__codelineno-104-9"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">radial/busyboxplus:latest</span><span class="w"></span>
<a id="__codelineno-104-10" name="__codelineno-104-10" href="#__codelineno-104-10"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-104-11" name="__codelineno-104-11" href="#__codelineno-104-11"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;env</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">3000&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-104-12" name="__codelineno-104-12" href="#__codelineno-104-12"></a><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-104-13" name="__codelineno-104-13" href="#__codelineno-104-13"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SPECIAL_LEVEL_KEY</span><span class="w"> </span><span class="c1"># 环境变量名</span><span class="w"></span>
<a id="__codelineno-104-14" name="__codelineno-104-14" href="#__codelineno-104-14"></a><span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-104-15" name="__codelineno-104-15" href="#__codelineno-104-15"></a><span class="w">            </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-104-16" name="__codelineno-104-16" href="#__codelineno-104-16"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1</span><span class="w"></span>
<a id="__codelineno-104-17" name="__codelineno-104-17" href="#__codelineno-104-17"></a><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">special.how</span><span class="w"></span>
<a id="__codelineno-104-18" name="__codelineno-104-18" href="#__codelineno-104-18"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SPECIAL_TYPE_KEY</span><span class="w"></span>
<a id="__codelineno-104-19" name="__codelineno-104-19" href="#__codelineno-104-19"></a><span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-104-20" name="__codelineno-104-20" href="#__codelineno-104-20"></a><span class="w">            </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-104-21" name="__codelineno-104-21" href="#__codelineno-104-21"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1</span><span class="w"></span>
<a id="__codelineno-104-22" name="__codelineno-104-22" href="#__codelineno-104-22"></a><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">special.type</span><span class="w"></span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>和<code>10_cm1-pod-env.yaml</code>中的配置大同小异，但是引用了先前创建的ConfigMap，而非同一个YAML配置文件中的ConfigMap</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a>kubectl create -f 14_cm1-pod3-env.yaml
<a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a>kubectl logs cm1-pod3-env
</code></pre></div>
<p><img alt="Map config to pod" src="../img/20220502135320.png" />  </p>
</li>
<li>
<p>将ConfigMap的内容以文件的形式传递, key--&gt;文件名，value--&gt;文件的内容</p>
<div class="highlight"><span class="filename">16_cm1-pod4-vol.yaml</span><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1-pod4-vol</span><span class="w"></span>
<a id="__codelineno-106-5" name="__codelineno-106-5" href="#__codelineno-106-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-106-6" name="__codelineno-106-6" href="#__codelineno-106-6"></a><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-106-7" name="__codelineno-106-7" href="#__codelineno-106-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config-vol</span><span class="w"> </span><span class="c1"># 新建卷的名字</span><span class="w"></span>
<a id="__codelineno-106-8" name="__codelineno-106-8" href="#__codelineno-106-8"></a><span class="w">    </span><span class="nt">configMap</span><span class="p">:</span><span class="w"> </span><span class="c1"># 卷的内容由ConfigMap决定</span><span class="w"></span>
<a id="__codelineno-106-9" name="__codelineno-106-9" href="#__codelineno-106-9"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm1</span><span class="w"> </span><span class="c1"># 内容来自cm1</span><span class="w"></span>
<a id="__codelineno-106-10" name="__codelineno-106-10" href="#__codelineno-106-10"></a>
<a id="__codelineno-106-11" name="__codelineno-106-11" href="#__codelineno-106-11"></a><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<a id="__codelineno-106-12" name="__codelineno-106-12" href="#__codelineno-106-12"></a><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-106-13" name="__codelineno-106-13" href="#__codelineno-106-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-busybox</span><span class="w"></span>
<a id="__codelineno-106-14" name="__codelineno-106-14" href="#__codelineno-106-14"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">radial/busyboxplus:latest</span><span class="w"></span>
<a id="__codelineno-106-15" name="__codelineno-106-15" href="#__codelineno-106-15"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-106-16" name="__codelineno-106-16" href="#__codelineno-106-16"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;sleep</span><span class="nv"> </span><span class="s">3000&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-106-17" name="__codelineno-106-17" href="#__codelineno-106-17"></a><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"> </span><span class="c1"># 创建了一个卷的挂载点</span><span class="w"></span>
<a id="__codelineno-106-18" name="__codelineno-106-18" href="#__codelineno-106-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config-vol</span><span class="w"> </span><span class="c1"># 挂载的卷名称，和volume.name一致</span><span class="w"></span>
<a id="__codelineno-106-19" name="__codelineno-106-19" href="#__codelineno-106-19"></a><span class="w">        </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/config</span><span class="w"> </span><span class="c1"># 容器内的路径</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a>kubectl create -f 16_cm1-pod4-vol.yaml
<a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a>kubectl <span class="nb">exec</span> cm1-pod4-vol -- ls /etc/config
</code></pre></div>
<p><img alt="Pass as file" src="../img/20220502135406.png" /></p>
<p>使用<code>kubectl describe pods cm1-pod4-vol</code>可以看到该Pod包含一个Volume</p>
<p><img alt="Volume in cm1-pod4-vol" src="../img/20220502135816.png" /></p>
</li>
</ol>
<h4 id="secret">Secret</h4>
<p>Secret 是用来保存和传递密码、密钥、认证凭证这些敏感信息的对象。使用 Secret 的好处是可以避免把敏感信息明文写在配置文件（常常是用版本控制软件管理的，且其访问的权限设定的较为宽泛）里。而在配置文件中通过 Secret 对象引用这些敏感信息。kubeadm默认生成的admin.conf中，证书数据就是被base64编码过的</p>
<p>这种方式的好处包括：</p>
<ol>
<li>意图明确</li>
<li>避免重复</li>
<li>减少机密信息暴露机会</li>
</ol>
<p>创建 Secret 时，K8S会用 base64 编码之后以与 ConfigMap 相同的方式存到 etcd Secret mount 到一个 Pod 时会先解密再挂载。</p>
<blockquote>
<p>Q: 为什么不写在配置文件里？A: 对于很多项目，配置文件。将Secret记录在配置文件中不是一个好想法</p>
</blockquote>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Base64 编码/解码可以使用Linux自带的<code>base64</code>工具</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="nb">echo</span> -n <span class="s1">&#39;admin&#39;</span> <span class="p">|</span> base64 <span class="c1"># --&gt; YWRtaW4=</span>
<a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="nb">echo</span> <span class="s1">&#39;YWRtaW4=&#39;</span> <span class="p">|</span> base64 --decode <span class="c1"># --&gt; admin</span>
</code></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>这种编码只是起到一个混淆的作用，并没有真正的<strong>加密</strong></p>
<p>v1.13后，K8S引入了加密的Secrets</p>
<pre class="mermaid"><code>graph LR
    S[Secretes] -- cleartext --&gt; A[(kube-apiserver)]
    subgraph Master Node
        K[local key] -- encrypt with --&gt; A
        A -- cipher --&gt; E[etcd]
    end</code></pre>
<p>可以看到，加密是在Master节点上进行的。由此可见，此架构仅解决了etcd数据泄露风险。但攻破Master节点后，可以在本地拿到key，仍然意味着可以接管整个集群的数据</p>
</div>
<p><strong>实验</strong></p>
<p>对几个配置文件的注解如下</p>
<div class="highlight"><span class="filename">20_secret1.yaml</span><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span><span class="w"></span>
<a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-109-4" name="__codelineno-109-4" href="#__codelineno-109-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret1</span><span class="w"></span>
<a id="__codelineno-109-5" name="__codelineno-109-5" href="#__codelineno-109-5"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;kubernetes.io/rbd&quot;</span><span class="w"> </span><span class="c1"># Generic type</span><span class="w"></span>
<a id="__codelineno-109-6" name="__codelineno-109-6" href="#__codelineno-109-6"></a><span class="nt">data</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-109-7" name="__codelineno-109-7" href="#__codelineno-109-7"></a><span class="w">  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">QVFBOWF3dFg1UjlPRkJBQWhrbzZPNGxJRGVTTndLeFo4dUNkUHc9PQ==</span><span class="w"></span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>该文件是为了挂载Ceph RBD创建的，储存的是Ceph的Secret。详见<a href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">Ceph Storage Class</a></p>
</div>
<div class="highlight"><span class="filename">22_secret2-pod-env.yaml</span><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span><span class="w"></span>
<a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret2</span><span class="w"></span>
<a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span><span class="w"> </span><span class="c1"># 默认类型</span><span class="w"></span>
<a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a><span class="nt">data</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-110-7" name="__codelineno-110-7" href="#__codelineno-110-7"></a><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">YWRtaW4=</span><span class="w"> </span><span class="c1"># Base64 编码后的值（原始值是admin）</span><span class="w"></span>
<a id="__codelineno-110-8" name="__codelineno-110-8" href="#__codelineno-110-8"></a><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MWYyZDFlMmU2N2Rm</span><span class="w"> </span><span class="c1"># Base64 编码后的值（原始值是1f2d1e2e67df）</span><span class="w"></span>
<a id="__codelineno-110-9" name="__codelineno-110-9" href="#__codelineno-110-9"></a>
<a id="__codelineno-110-10" name="__codelineno-110-10" href="#__codelineno-110-10"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-110-11" name="__codelineno-110-11" href="#__codelineno-110-11"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-110-12" name="__codelineno-110-12" href="#__codelineno-110-12"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-110-13" name="__codelineno-110-13" href="#__codelineno-110-13"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-110-14" name="__codelineno-110-14" href="#__codelineno-110-14"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret2-pod-env</span><span class="w"></span>
<a id="__codelineno-110-15" name="__codelineno-110-15" href="#__codelineno-110-15"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-110-16" name="__codelineno-110-16" href="#__codelineno-110-16"></a><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-110-17" name="__codelineno-110-17" href="#__codelineno-110-17"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-busybox</span><span class="w"></span>
<a id="__codelineno-110-18" name="__codelineno-110-18" href="#__codelineno-110-18"></a><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">radial/busyboxplus</span><span class="w"></span>
<a id="__codelineno-110-19" name="__codelineno-110-19" href="#__codelineno-110-19"></a><span class="w">  </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-110-20" name="__codelineno-110-20" href="#__codelineno-110-20"></a><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;env</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000000&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-110-21" name="__codelineno-110-21" href="#__codelineno-110-21"></a><span class="w">  </span><span class="nt">env</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-110-22" name="__codelineno-110-22" href="#__codelineno-110-22"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SECRET_USERNAME</span><span class="w"> </span><span class="c1"># 环境变量名称</span><span class="w"></span>
<a id="__codelineno-110-23" name="__codelineno-110-23" href="#__codelineno-110-23"></a><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-110-24" name="__codelineno-110-24" href="#__codelineno-110-24"></a><span class="w">      </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w"> </span><span class="c1"># 引用了Secret</span><span class="w"></span>
<a id="__codelineno-110-25" name="__codelineno-110-25" href="#__codelineno-110-25"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret2</span><span class="w"> </span><span class="c1"># 需要指定Secret的名称，和secret.name相同</span><span class="w"></span>
<a id="__codelineno-110-26" name="__codelineno-110-26" href="#__codelineno-110-26"></a><span class="w">      </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username</span><span class="w"> </span><span class="c1"># 需要指定secret存储中的一个key</span><span class="w"></span>
<a id="__codelineno-110-27" name="__codelineno-110-27" href="#__codelineno-110-27"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SECRET_PASSWORD</span><span class="w"></span>
<a id="__codelineno-110-28" name="__codelineno-110-28" href="#__codelineno-110-28"></a><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-110-29" name="__codelineno-110-29" href="#__codelineno-110-29"></a><span class="w">      </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-110-30" name="__codelineno-110-30" href="#__codelineno-110-30"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret2</span><span class="w"></span>
<a id="__codelineno-110-31" name="__codelineno-110-31" href="#__codelineno-110-31"></a><span class="w">      </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><span class="filename">24_secret3-pod-volume.yaml</span><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret3-pod-volume</span><span class="w"></span>
<a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-busybox</span><span class="w"></span>
<a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">radial/busyboxplus</span><span class="w"></span>
<a id="__codelineno-111-9" name="__codelineno-111-9" href="#__codelineno-111-9"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-111-10" name="__codelineno-111-10" href="#__codelineno-111-10"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ls</span><span class="nv"> </span><span class="s">/xxx</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000000&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-111-11" name="__codelineno-111-11" href="#__codelineno-111-11"></a><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"> </span><span class="c1"># 挂载secret2-vol 卷，见下方定义</span><span class="w"></span>
<a id="__codelineno-111-12" name="__codelineno-111-12" href="#__codelineno-111-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret2-vol</span><span class="w"></span>
<a id="__codelineno-111-13" name="__codelineno-111-13" href="#__codelineno-111-13"></a><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/xxx&quot;</span><span class="w"></span>
<a id="__codelineno-111-14" name="__codelineno-111-14" href="#__codelineno-111-14"></a><span class="w">      </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-111-15" name="__codelineno-111-15" href="#__codelineno-111-15"></a><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"> </span><span class="c1"># 创建secret2-vol卷</span><span class="w"></span>
<a id="__codelineno-111-16" name="__codelineno-111-16" href="#__codelineno-111-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret2-vol</span><span class="w"></span>
<a id="__codelineno-111-17" name="__codelineno-111-17" href="#__codelineno-111-17"></a><span class="w">    </span><span class="nt">secret</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-111-18" name="__codelineno-111-18" href="#__codelineno-111-18"></a><span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret2</span><span class="w"></span>
</code></pre></div>
<p>我们可以看到，Secret可以作为环境变量，也可以作为Pod的Volume传入Pod</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a>kubectl apply -f 20_secret1.yaml
<a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a>kubectl get secret
<a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a>kubectl apply -f 22_secret2-pod-env.yaml
<a id="__codelineno-112-4" name="__codelineno-112-4" href="#__codelineno-112-4"></a>kubectl logs secret2-pod-env <span class="c1"># username, password decoded already</span>
<a id="__codelineno-112-5" name="__codelineno-112-5" href="#__codelineno-112-5"></a>kubectl apply -f 24_secret3-pod-volume.yaml
<a id="__codelineno-112-6" name="__codelineno-112-6" href="#__codelineno-112-6"></a>kubectl <span class="nb">exec</span> secret3-pod-volume -- cat /xxx/username
</code></pre></div>
<p><img alt="Secrets" src="../img/20220502140252.png" />  </p>
<h3 id="volume-based">Volume-based</h3>
<blockquote>
<p>PV 和 PVC 使得 K8s 集群具备了存储的逻辑抽象能力，使得在<em>配置 Pod 的逻辑里可以忽略对实际后台存储技术的配置，而把这项配置的工作交给 PV 的配置者，即集群的管理者</em>。存储的 PV 和 PVC 的这种关系，跟计算的 Node 和 Pod 的关系是非常类似的：PV 和 Node 是资源的<strong>提供者</strong>，根据集群的基础设施变化而变化，由 K8s <strong>集群管理员</strong>配置；而 PVC 和 Pod 是资源的<strong>使用者</strong>，根据业务服务的需求变化而变化，由 K8s 集群的使用者即<strong>服务的管理员</strong>来配置。</p>
</blockquote>
<h4 id="pod-volume">Pod Volume</h4>
<p>必须在定义Pod的时候同时定义Pod Volume，其与Pod同生共死，因此生命周期是Pod中所有对象中最长的。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Pod Volume会在Pod结束后销毁，正如Docker容器的Volume那样。</p>
</div>
<ol>
<li>
<p>emptyDir - 创建一个空的目录作为卷</p>
<p>配置文件创建了一个emptyDir卷，挂载到了容器内</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a>kubectl apply -f 30_vol1-pod-emptydir.yaml
<a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a>kubectl <span class="nb">exec</span> vol1-emptydir -- ls /data
</code></pre></div>
</li>
<li>
<p>hostPath - 挂载一个Node上存在的目录</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vol2-pod-hostpath</span><span class="w"></span>
<a id="__codelineno-114-5" name="__codelineno-114-5" href="#__codelineno-114-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-114-6" name="__codelineno-114-6" href="#__codelineno-114-6"></a><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-114-7" name="__codelineno-114-7" href="#__codelineno-114-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vol-data</span><span class="w"> </span><span class="c1"># 卷名称vol-data</span><span class="w"></span>
<a id="__codelineno-114-8" name="__codelineno-114-8" href="#__codelineno-114-8"></a><span class="w">    </span><span class="nt">hostPath</span><span class="p">:</span><span class="w"> </span><span class="c1"># 类型是hostPath</span><span class="w"></span>
<a id="__codelineno-114-9" name="__codelineno-114-9" href="#__codelineno-114-9"></a><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp</span><span class="w"> </span><span class="c1"># 需要修改成一个存在的目录</span><span class="w"></span>
<a id="__codelineno-114-10" name="__codelineno-114-10" href="#__codelineno-114-10"></a><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Directory</span><span class="w"> </span><span class="c1"># 除了挂载Directory，还可以挂载单个文件</span><span class="w"></span>
<a id="__codelineno-114-11" name="__codelineno-114-11" href="#__codelineno-114-11"></a>
<a id="__codelineno-114-12" name="__codelineno-114-12" href="#__codelineno-114-12"></a><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<a id="__codelineno-114-13" name="__codelineno-114-13" href="#__codelineno-114-13"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-114-14" name="__codelineno-114-14" href="#__codelineno-114-14"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-busybox</span><span class="w"></span>
<a id="__codelineno-114-15" name="__codelineno-114-15" href="#__codelineno-114-15"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox:latest</span><span class="w"></span>
<a id="__codelineno-114-16" name="__codelineno-114-16" href="#__codelineno-114-16"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-114-17" name="__codelineno-114-17" href="#__codelineno-114-17"></a><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-114-18" name="__codelineno-114-18" href="#__codelineno-114-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vol-data</span><span class="w"></span>
<a id="__codelineno-114-19" name="__codelineno-114-19" href="#__codelineno-114-19"></a><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data</span><span class="w"></span>
<a id="__codelineno-114-20" name="__codelineno-114-20" href="#__codelineno-114-20"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ls</span><span class="nv"> </span><span class="s">/data</span><span class="nv"> </span><span class="s">&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">3000&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>spec.volumes.hostPah.path</code> 需要存在</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a>kubectl apply -f 32_vol2-pod-hostpath.yaml
<a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a>kubectl <span class="nb">exec</span> vol2-pod-hostpath -- ls /data 
</code></pre></div>
<p><img alt="Host Path" src="../img/20220502153840.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>考虑到容器会在节点间被迁移/驱逐，挂载Node上的一个目录对于并非总是个很好的主意。但对于有些容器，hostPath可以让容器能够与Node通过文件套接字沟通（例如/var/lib/docker.sock）</p>
</div>
</li>
</ol>
<h3 id="persistent-volume">Persistent Volume</h3>
<p>Persistent Volume包括PV和PVC两部分</p>
<h4 id="persistent-volume-pv">Persistent Volume (PV)</h4>
<p>PV对底层共享存储的抽象。它于Pod独立，与K8S集群同寿。其从属于整个集群</p>
<p>根据服务的不同，PV有三种访问模式：</p>
<ol>
<li>ReadWriteOnce (RWO) – 单node的读写</li>
<li>ReadOnlyMany  (ROM) – 多node的只读</li>
<li>ReadWriteMany (RWM) – 多node的读写</li>
</ol>
<p>用户删除PVC后，PV回收策略有</p>
<ol>
<li>Retain 保留策略  - 允许人工处理保留的数据。（默认）</li>
<li>Delete 删除策略  - 将删除pv和外部关联的存储资源，需要插件支持。</li>
<li>Recycle 回收策略 - 将执行清除操作，之后可以被新的PVC使用，需要插件支持。</li>
</ol>
<p>总体来说PV有以下几种状态</p>
<ol>
<li>Available – 资源尚未被claim使用</li>
<li>Bound     – 卷已经被绑定到claim了</li>
<li>Released  – claim被删除，卷处于释放状态，但未被集群回收。</li>
<li>Failed    – 卷自动回收失败</li>
</ol>
<p>一般PV的常用配置参数有</p>
<ul>
<li><code>Capaciity</code> PV的存储能力</li>
<li><code>Access Modes</code> 读写权限</li>
<li><code>storageClassName</code> 存储类别</li>
<li><code>persistentVolumeReclaimPolicy</code> 回收策略</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>PV 可以设定其存储的类别，通过 <code>storageClassName</code> 参数指定一个 <code>StorageClass</code> 资源对象的名称。具有特定类别的 <code>PV</code> 只能与请求了该类别的 <code>PVC</code> 进行绑定。未设定类别的 <code>PV</code> 则只能与不请求任何类别的 <code>PVC</code> 进行绑定。</p>
</div>
<p><strong>实验</strong></p>
<div class="highlight"><span class="filename">40_pv1.yaml</span><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span><span class="w"></span>
<a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-116-4" name="__codelineno-116-4" href="#__codelineno-116-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pv1</span><span class="w"> </span><span class="c1"># 独一无二的名称</span><span class="w"></span>
<a id="__codelineno-116-5" name="__codelineno-116-5" href="#__codelineno-116-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-116-6" name="__codelineno-116-6" href="#__codelineno-116-6"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local 本地</span><span class="w"></span>
<a id="__codelineno-116-7" name="__codelineno-116-7" href="#__codelineno-116-7"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-116-8" name="__codelineno-116-8" href="#__codelineno-116-8"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span><span class="w"> </span><span class="c1"># 该名称将用于将 PVC 请求绑定到此</span><span class="w"></span>
<a id="__codelineno-116-9" name="__codelineno-116-9" href="#__codelineno-116-9"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-116-10" name="__codelineno-116-10" href="#__codelineno-116-10"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2Gi</span><span class="w"> </span><span class="c1"># 大小2G</span><span class="w"></span>
<a id="__codelineno-116-11" name="__codelineno-116-11" href="#__codelineno-116-11"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-116-12" name="__codelineno-116-12" href="#__codelineno-116-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span><span class="w"> </span><span class="c1"># 单个容器读写</span><span class="w"></span>
<a id="__codelineno-116-13" name="__codelineno-116-13" href="#__codelineno-116-13"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-116-14" name="__codelineno-116-14" href="#__codelineno-116-14"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/tmp/storage/pv1&quot;</span><span class="w"> </span><span class="c1"># 存放目录</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a>kubectl apply -f 40_pv1.yaml
<a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a>kubectl get pv
</code></pre></div>
<p><img alt="PV Creation" src="../img/20220502155812.png" /></p>
<p>该命令创建了一个<code>2GiB</code>大小的PV，类型是<code>manual</code>，策略是<code>ReadWriteOnce</code>。<strong>记住这一点</strong></p>
<h4 id="persistentvolumeclaim-pvc">PersistentVolumeClaim (PVC)</h4>
<p>用户对于存储资源的申请被称为PVC</p>
<p><strong>实验</strong></p>
<p>以下一些解读。该配置文件分为两部分，第一部分：</p>
<div class="highlight"><span class="filename">42_pvc1-pod.yaml</span><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span><span class="w"></span>
<a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pvc1</span><span class="w"> </span><span class="c1"># Claim的名称</span><span class="w"></span>
<a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span><span class="w"> </span><span class="c1"># K8S将寻找此类型的PV进行绑定，要和40_pv1.yaml中相同</span><span class="w"></span>
<a id="__codelineno-118-7" name="__codelineno-118-7" href="#__codelineno-118-7"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-118-8" name="__codelineno-118-8" href="#__codelineno-118-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span><span class="w"> </span><span class="c1"># 单节点读写，同样的K8S将寻找此类型的PV绑定</span><span class="w"></span>
<a id="__codelineno-118-9" name="__codelineno-118-9" href="#__codelineno-118-9"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-118-10" name="__codelineno-118-10" href="#__codelineno-118-10"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c1"># 向PV请求1G</span><span class="w"></span>
<a id="__codelineno-118-11" name="__codelineno-118-11" href="#__codelineno-118-11"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span><span class="w"></span>
</code></pre></div>
<p>可以看到，这部分创建了一个PVC，类型是<code>manual</code>，容量需求是<code>1GiB</code>，权限是<code>ReadWriteOnce</code>。由于类型和权限都<strong>匹配</strong><code>pv1</code>，因此<code>pv1</code>这个PV，将用于服务<code>pvc1</code>。</p>
<p>第二部分：</p>
<div class="highlight"><span class="filename">42_pvc1-pod.yaml</span><pre><span></span><code><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pvc1-pod</span><span class="w"></span>
<a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"> </span><span class="c1"># Pod Volume</span><span class="w"></span>
<a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vol-data</span><span class="w"> </span><span class="c1"># 自定义名称</span><span class="w"></span>
<a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a><span class="w">      </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w"> </span><span class="c1"># Volume的存储后端来自PVC</span><span class="w"></span>
<a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a><span class="w">        </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pvc1</span><span class="w"> </span><span class="c1"># PVC的名称</span><span class="w"></span>
<a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-busybox</span><span class="w"></span>
<a id="__codelineno-119-12" name="__codelineno-119-12" href="#__codelineno-119-12"></a><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox:latest</span><span class="w"></span>
<a id="__codelineno-119-13" name="__codelineno-119-13" href="#__codelineno-119-13"></a><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-119-14" name="__codelineno-119-14" href="#__codelineno-119-14"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;touch</span><span class="nv"> </span><span class="s">/data/xxx</span><span class="nv"> </span><span class="s">&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">60000&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span>
<a id="__codelineno-119-15" name="__codelineno-119-15" href="#__codelineno-119-15"></a><span class="w">      </span><span class="c1"># 在Data下创建xxx文件</span><span class="w"></span>
<a id="__codelineno-119-16" name="__codelineno-119-16" href="#__codelineno-119-16"></a><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-119-17" name="__codelineno-119-17" href="#__codelineno-119-17"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vol-data</span><span class="w"> </span><span class="c1"># 把卷挂载到/data</span><span class="w"></span>
<a id="__codelineno-119-18" name="__codelineno-119-18" href="#__codelineno-119-18"></a><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data</span><span class="w"></span>
<a id="__codelineno-119-19" name="__codelineno-119-19" href="#__codelineno-119-19"></a><span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
</code></pre></div>
<p>第二部分创建了一个Pod，该Pod配置文件定义了一个Pod Volume. 这个Volume需要<code>pvc1</code>提供存储。</p>
<p>我们可以发现，K8S服务用户<strong>不需要</strong>考虑PV是怎么实现的。用户只需要提出PVC，然后用这些PVC为定义的卷提供存储能力。至于安排这些PVC，用户也只需要为它们贴上<code>storageClass</code>、<code>accessModes</code>等标签，然后依靠集群进行调度。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a>kubectl apply -f 42_pvc1-pod.yaml 
<a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="c1"># create a PVC which will bound to the PV1, and create a pod</span>
<a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a>kubectl <span class="nb">exec</span> pvc1-pod -- ls /data
<a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a>kubectl get pvc
<a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a>kubectl get pv
</code></pre></div>
<p><img alt="Bond PVC" src="../img/20220502160458.png" /></p>
<p>可以看到，这个2GiB的PV变成了Bond状态，PVC的容量变成了2GiB。这表明其已经与PVC绑定。K8S不允许一个PV绑定多个PVC，因此该PV<strong>不能</strong>和更多的PVC绑定了（能力的浪费？）。其他的PVC只有等待该PV变成Available的时候才能和它绑定</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>如果PVC里面设置的容量超过PV里面定义的容量，那么PVC是创建不成功的，会一直处于Pending状态。</p>
</div>
<p>我们登陆<code>pvc1-pod</code>所在的节点查看一下</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a>kubectl get pods -o wide <span class="c1"># 查看Pod被调度到了哪个节点（答案：node2）</span>
<a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a><span class="o">[</span>node2<span class="o">]</span> $ ls /tmp/storage/pv1/
<a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a>xxx
</code></pre></div>
<p><img alt="Inspect PV" src="../img/20220502161118.png" /></p>
<p>可以看到PV的存储能力由node2节点的本地存储提供。</p>
<p>现在，我们删除PVC后，再次查看PV的状态</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a>$ kubectl delete -f 42_pvc1-pod.yaml
<a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a>persistentvolumeclaim <span class="s2">&quot;pvc1&quot;</span> deleted
<a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a>pod <span class="s2">&quot;pvc1-pod&quot;</span> deleted
<a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a>$ kubectl get pv
<a id="__codelineno-122-5" name="__codelineno-122-5" href="#__codelineno-122-5"></a>NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM          STORAGECLASS   REASON   AGE
<a id="__codelineno-122-6" name="__codelineno-122-6" href="#__codelineno-122-6"></a>pv1    2Gi        RWO            Retain           Released   default/pvc1   manual                  26m
</code></pre></div>
<p>发现其状态为<code>Released</code>. 我们必须将该PV回复成<code>Available</code>状态，才能再次绑定PVC到该PV。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>kubectl patch pv &lt;pv-name&gt; -p '{"spec":{"claimRef": null}}'</code>命令可以将一个Release状态的PV恢复可用</p>
</div>
<h4 id="storage-class">Storage Class</h4>
<p>PV 和 PVC 模式需要运维人员先创建好 PV，然后开发人员定义 PVC 进行Bond,维护成本很高。K8s 提供一种自动创建 PV 的机制，叫 StorageClass，它的作用就是创建 PV 的模板。</p>
<p>具体来说，StorageClass 会定义一下两部分：</p>
<ol>
<li>PV 的属性 ：比如存储的大小、类型等；</li>
<li>创建这种 PV 需要用到的存储插件：比如 Ceph 等；</li>
</ol>
<p>有了这两部分信息，K8s 就能根据用户提交的 PVC 找到对应的 StorageClass，然后 K8s 就会调用 StorageClass 声明的存储插件创建需要的 PV。</p>
<p><strong>实验</strong></p>
<div class="highlight"><span class="filename">50_sc1-hostpath.yaml</span><pre><span></span><code><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span><span class="w"> </span><span class="c1"># 使用storage.k8s.io API</span><span class="w"></span>
<a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StorageClass</span><span class="w"> </span><span class="c1"># 定义了一个StorageClass</span><span class="w"></span>
<a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostpath2</span><span class="w"> </span><span class="c1"># 名称</span><span class="w"></span>
<a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a><span class="c1"># 存储能力的提供方是docker.io/hostpath，自动存在于DockerDesktopc创建的集群中</span><span class="w"></span>
<a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/hostpath</span><span class="w"></span>
<a id="__codelineno-123-7" name="__codelineno-123-7" href="#__codelineno-123-7"></a><span class="nt">reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Delete</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><span class="filename">52_sc1-pvc-pod.yaml</span><pre><span></span><code><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span><span class="w"> </span><span class="c1"># 普通地申请了1GiB大容量</span><span class="w"></span>
<a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-4" name="__codelineno-124-4" href="#__codelineno-124-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage-sc</span><span class="w"></span>
<a id="__codelineno-124-5" name="__codelineno-124-5" href="#__codelineno-124-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-6" name="__codelineno-124-6" href="#__codelineno-124-6"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostpath2</span><span class="w"></span>
<a id="__codelineno-124-7" name="__codelineno-124-7" href="#__codelineno-124-7"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-8" name="__codelineno-124-8" href="#__codelineno-124-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span><span class="w"></span>
<a id="__codelineno-124-9" name="__codelineno-124-9" href="#__codelineno-124-9"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-10" name="__codelineno-124-10" href="#__codelineno-124-10"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-11" name="__codelineno-124-11" href="#__codelineno-124-11"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span><span class="w"></span>
<a id="__codelineno-124-12" name="__codelineno-124-12" href="#__codelineno-124-12"></a>
<a id="__codelineno-124-13" name="__codelineno-124-13" href="#__codelineno-124-13"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-124-14" name="__codelineno-124-14" href="#__codelineno-124-14"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-124-15" name="__codelineno-124-15" href="#__codelineno-124-15"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-124-16" name="__codelineno-124-16" href="#__codelineno-124-16"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-17" name="__codelineno-124-17" href="#__codelineno-124-17"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage-pvc-sc</span><span class="w"></span>
<a id="__codelineno-124-18" name="__codelineno-124-18" href="#__codelineno-124-18"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-19" name="__codelineno-124-19" href="#__codelineno-124-19"></a><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-20" name="__codelineno-124-20" href="#__codelineno-124-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data-vol</span><span class="w"></span>
<a id="__codelineno-124-21" name="__codelineno-124-21" href="#__codelineno-124-21"></a><span class="w">      </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-22" name="__codelineno-124-22" href="#__codelineno-124-22"></a><span class="w">        </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage-sc</span><span class="w"></span>
<a id="__codelineno-124-23" name="__codelineno-124-23" href="#__codelineno-124-23"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-24" name="__codelineno-124-24" href="#__codelineno-124-24"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox-pvc-sc</span><span class="w"></span>
<a id="__codelineno-124-25" name="__codelineno-124-25" href="#__codelineno-124-25"></a><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<a id="__codelineno-124-26" name="__codelineno-124-26" href="#__codelineno-124-26"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;sleep</span><span class="nv"> </span><span class="s">60000&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-124-27" name="__codelineno-124-27" href="#__codelineno-124-27"></a><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-124-28" name="__codelineno-124-28" href="#__codelineno-124-28"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data-vol</span><span class="w"></span>
<a id="__codelineno-124-29" name="__codelineno-124-29" href="#__codelineno-124-29"></a><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/busybox</span><span class="w"> </span><span class="c1"># 卷被挂载的路径</span><span class="w"></span>
<a id="__codelineno-124-30" name="__codelineno-124-30" href="#__codelineno-124-30"></a><span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a>kubectl apply -f 50_sc1-hostpath.yaml <span class="c1"># create a default storage class</span>
<a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a>kubectl get storageClass <span class="c1"># a new class should appear</span>
<a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a>kubectl apply -f 52_sc1-pvc-pod.yaml <span class="c1"># create a PVC and a pod</span>
<a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a>kubectl get pv
<a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a>kubectl get pvc
</code></pre></div>
<p>理论上，应该有一个PV被自动创建。实际上，没有PV被创建，Pod没有被部署，PVC停在了ExternalProvisioning阶段。这是因为kubeadm创建的集群中不存在<code>docker.io/hostpath</code>这个provisioner</p>
<p>因此下方的实验注定是失败的</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a>kubectl <span class="nb">exec</span> -it storage-pvc-sc -- /bin/sh 
<a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a><span class="c1"># access to the pod and test the storage</span>
</code></pre></div>
<p>在kubeadm部署的集群上，需要自定义一个host-path provisioner才能进行实验。可以参考<a href="https://github.com/samisalkosuo/k8s-dynamic-hostpath-provisioner">这个项目</a></p>
<h3 id="third-party-drivers">Third-party Drivers</h3>
<p>假设说我们要使用NFS，我们就需要一个nfs-client的自动装载程序，我们称之为Provisioner，这个程序会使用我们已经配置好的NFS服务器自动创建持久卷，也就是自动帮我们创建PV。</p>
<h4 id="custom">Custom</h4>
<blockquote>
<p>把大象放进冰箱需要三步：1. 把冰箱打开；2. 把大象放进去；3. 把冰箱门关上</p>
</blockquote>
<p>创建一个自定义的Provisioner也需要三步</p>
<p>首先，创建一个rbac权限绑定，对<code>ServiceAccount: hostpath-provisioner-account</code>授予<code>hostpath-provisioner-rule</code>权限，主要是允许该账户创建PV</p>
<div class="highlight"><span class="filename">rbac.yaml</span><pre><span></span><code><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span><span class="w"></span>
<a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span><span class="w"></span>
<a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VAR-provisioner-rule</span><span class="w"> </span><span class="c1"># 规则名称，可定制</span><span class="w"></span>
<a id="__codelineno-127-5" name="__codelineno-127-5" href="#__codelineno-127-5"></a><span class="nt">rules</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-127-6" name="__codelineno-127-6" href="#__codelineno-127-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># 给予创建PV的权利</span><span class="w"></span>
<a id="__codelineno-127-7" name="__codelineno-127-7" href="#__codelineno-127-7"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;persistentvolumes&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-127-8" name="__codelineno-127-8" href="#__codelineno-127-8"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;delete&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-127-9" name="__codelineno-127-9" href="#__codelineno-127-9"></a>
<a id="__codelineno-127-10" name="__codelineno-127-10" href="#__codelineno-127-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># 给予监控、修改PVC的权利</span><span class="w"></span>
<a id="__codelineno-127-11" name="__codelineno-127-11" href="#__codelineno-127-11"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;persistentvolumeclaims&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-127-12" name="__codelineno-127-12" href="#__codelineno-127-12"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-127-13" name="__codelineno-127-13" href="#__codelineno-127-13"></a>
<a id="__codelineno-127-14" name="__codelineno-127-14" href="#__codelineno-127-14"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;storage.k8s.io&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># 给予获取storageClasses的权利</span><span class="w"></span>
<a id="__codelineno-127-15" name="__codelineno-127-15" href="#__codelineno-127-15"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;storageclasses&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-127-16" name="__codelineno-127-16" href="#__codelineno-127-16"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-127-17" name="__codelineno-127-17" href="#__codelineno-127-17"></a>
<a id="__codelineno-127-18" name="__codelineno-127-18" href="#__codelineno-127-18"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># 给予监控事件的权利</span><span class="w"></span>
<a id="__codelineno-127-19" name="__codelineno-127-19" href="#__codelineno-127-19"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;events&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-127-20" name="__codelineno-127-20" href="#__codelineno-127-20"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;patch&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-127-21" name="__codelineno-127-21" href="#__codelineno-127-21"></a>
<a id="__codelineno-127-22" name="__codelineno-127-22" href="#__codelineno-127-22"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-127-23" name="__codelineno-127-23" href="#__codelineno-127-23"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span><span class="w"></span>
<a id="__codelineno-127-24" name="__codelineno-127-24" href="#__codelineno-127-24"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span><span class="w"></span>
<a id="__codelineno-127-25" name="__codelineno-127-25" href="#__codelineno-127-25"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-127-26" name="__codelineno-127-26" href="#__codelineno-127-26"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VAR-provisioner-binding</span><span class="w"> </span><span class="c1"># binding的名称，可定制</span><span class="w"></span>
<a id="__codelineno-127-27" name="__codelineno-127-27" href="#__codelineno-127-27"></a><span class="nt">roleRef</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-127-28" name="__codelineno-127-28" href="#__codelineno-127-28"></a><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span><span class="w"></span>
<a id="__codelineno-127-29" name="__codelineno-127-29" href="#__codelineno-127-29"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span><span class="w"></span>
<a id="__codelineno-127-30" name="__codelineno-127-30" href="#__codelineno-127-30"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VAR-provisioner-rule</span><span class="w"> </span><span class="c1"># 引用上面的规则，不能更改</span><span class="w"></span>
<a id="__codelineno-127-31" name="__codelineno-127-31" href="#__codelineno-127-31"></a><span class="nt">subjects</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-127-32" name="__codelineno-127-32" href="#__codelineno-127-32"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span><span class="w"> </span><span class="c1"># 创建的是ServiceAccount</span><span class="w"></span>
<a id="__codelineno-127-33" name="__codelineno-127-33" href="#__codelineno-127-33"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VAR-provisioner-account</span><span class="w"> </span><span class="c1"># ServiceAcount的名称</span><span class="w"></span>
<a id="__codelineno-127-34" name="__codelineno-127-34" href="#__codelineno-127-34"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span><span class="w"> </span><span class="c1"># 命名空间选择系统命名空间，因为这属于运维范畴</span><span class="w"></span>
</code></pre></div>
<p>然后需要创建一个自定义的storageClass，名称和provissioner名称可以定义</p>
<div class="highlight"><span class="filename">storageclass.yaml</span><pre><span></span><code><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StorageClass</span><span class="w"></span>
<a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span><span class="w"></span>
<a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VAR</span><span class="w"> </span><span class="c1"># 自定义的storageClass名称</span><span class="w"></span>
<a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a><span class="w">    </span><span class="c1">#是否为默认的storageClass</span><span class="w"></span>
<a id="__codelineno-128-7" name="__codelineno-128-7" href="#__codelineno-128-7"></a><span class="w">    </span><span class="nt">storageclass.kubernetes.io/is-default-class</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="w"></span>
<a id="__codelineno-128-8" name="__codelineno-128-8" href="#__codelineno-128-8"></a><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DOMAIN/VAR-PROVISIONER</span><span class="w">  </span><span class="c1"># 自定义的provisioner名称</span><span class="w"></span>
<a id="__codelineno-128-9" name="__codelineno-128-9" href="#__codelineno-128-9"></a><span class="nt">reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span><span class="w"> </span><span class="c1"># 自定义策略</span><span class="w"></span>
<a id="__codelineno-128-10" name="__codelineno-128-10" href="#__codelineno-128-10"></a><span class="nt">parameters</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-11" name="__codelineno-128-11" href="#__codelineno-128-11"></a><span class="w">    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="w"> </span><span class="c1"># 一些其他参数 </span><span class="w"></span>
<a id="__codelineno-128-12" name="__codelineno-128-12" href="#__codelineno-128-12"></a>
<a id="__codelineno-128-13" name="__codelineno-128-13" href="#__codelineno-128-13"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span><span class="w"></span>
<a id="__codelineno-128-14" name="__codelineno-128-14" href="#__codelineno-128-14"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<a id="__codelineno-128-15" name="__codelineno-128-15" href="#__codelineno-128-15"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-16" name="__codelineno-128-16" href="#__codelineno-128-16"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">VAR-provisioner</span><span class="w"> </span><span class="c1"># 自定义名称</span><span class="w"></span>
<a id="__codelineno-128-17" name="__codelineno-128-17" href="#__codelineno-128-17"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span><span class="w"></span>
<a id="__codelineno-128-18" name="__codelineno-128-18" href="#__codelineno-128-18"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-19" name="__codelineno-128-19" href="#__codelineno-128-19"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"> </span><span class="c1"># 保持一个副本</span><span class="w"></span>
<a id="__codelineno-128-20" name="__codelineno-128-20" href="#__codelineno-128-20"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-21" name="__codelineno-128-21" href="#__codelineno-128-21"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-22" name="__codelineno-128-22" href="#__codelineno-128-22"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VAR-provisioner</span><span class="w"> </span><span class="c1"># 自定义的label，和spec.template.metadata.labels匹配</span><span class="w"></span>
<a id="__codelineno-128-23" name="__codelineno-128-23" href="#__codelineno-128-23"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-24" name="__codelineno-128-24" href="#__codelineno-128-24"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Recreate</span><span class="w"> </span><span class="c1"># 这个Pod是无状态的，Recreate就完事了</span><span class="w"></span>
<a id="__codelineno-128-25" name="__codelineno-128-25" href="#__codelineno-128-25"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-26" name="__codelineno-128-26" href="#__codelineno-128-26"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-27" name="__codelineno-128-27" href="#__codelineno-128-27"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-28" name="__codelineno-128-28" href="#__codelineno-128-28"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">VAR-provisioner# 和spec.selector.matchLabels匹配</span><span class="w"></span>
<a id="__codelineno-128-29" name="__codelineno-128-29" href="#__codelineno-128-29"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-30" name="__codelineno-128-30" href="#__codelineno-128-30"></a><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VAR-provisioner-account</span><span class="w"> </span><span class="c1"># ServiceAcount的名称</span><span class="w"></span>
<a id="__codelineno-128-31" name="__codelineno-128-31" href="#__codelineno-128-31"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-128-32" name="__codelineno-128-32" href="#__codelineno-128-32"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VAR-provisioner</span><span class="w"> </span><span class="c1"># 自定义名称</span><span class="w"></span>
<a id="__codelineno-128-33" name="__codelineno-128-33" href="#__codelineno-128-33"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DOMAIN/VAR-PROVISIONER</span><span class="w"> </span><span class="c1"># 和storageClass中的provisioner匹配</span><span class="w"></span>
<a id="__codelineno-128-34" name="__codelineno-128-34" href="#__codelineno-128-34"></a><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"> </span><span class="c1"># 允许特权执行</span><span class="w"></span>
<a id="__codelineno-128-35" name="__codelineno-128-35" href="#__codelineno-128-35"></a><span class="w">          </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-128-36" name="__codelineno-128-36" href="#__codelineno-128-36"></a><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
<a id="__codelineno-128-37" name="__codelineno-128-37" href="#__codelineno-128-37"></a><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
<a id="__codelineno-128-38" name="__codelineno-128-38" href="#__codelineno-128-38"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
</code></pre></div>
<p>你设计的这个容器接受的参数是</p>
<ul>
<li>K8S集群的状态、实践</li>
<li>StorageClass传入的参数</li>
<li>你定义的其他存储资源（快存储、本地映射的volume、NFS端点）</li>
</ul>
<p>你的容器需要完成的工作是</p>
<ul>
<li>监听PVC的创建</li>
<li>在自己管理的存储资源中，根据PVC的请求为PVC保留资源</li>
<li>操作K8S集群，使用为该PVC保留的资源创建PV</li>
<li>将PVC与PV相绑定</li>
<li>监听PVC的回收</li>
<li>根据回收策略，释放存储资源</li>
</ul>
<h4 id="nfs">NFS</h4>
<p>NFS是非常常见的网络存储协议。Kubernetes 不包含内部 NFS 驱动。你需要使用外部驱动为 NFS 创建 StorageClass.</p>
<p><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">kubernets-sigs/nfs-subdir-external-provisioner</a>是一个流行的为K8S集群提供NFS的项目</p>
<p>首先，需要创建一个有NFS能力的节点。这里我们选择创建一台独立的节点用于提供NFS服务。该节点的主机名为<code>storage0</code>。我们需要在<code>storage0</code>节点上安装<code>nfs-common</code>, <code>nfs-kernel-server</code>套件</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a><span class="o">[</span>speit@storage0<span class="o">]</span> $ sudo apt-get install nfs-common nfs-kernel-server
</code></pre></div>
<p>该节点还需要配置<code>/etc/exports</code>，添加以下选项：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a>/path/to/server_data  [cidr]([rw|ro],sync) # 注意(,)没有空格
</code></pre></div>
<p>例如</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a>/data 10.64.13.0/24(rw,sync)
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>该命令将会允许来自<code>[cidr]</code>的客户端以<code>rw</code>或者<code>ro</code>的方式访问<code>/path/to/server_data</code>目录。<code>CIDR</code>即形如<code>192.168.1.0/24</code>的无类域间路由描述</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>/path/to/server_data</code>必须手动创建，并且赋予"NFS映射的用户"读写权限。一般来说NFS会把用户映射到root组的other，因此需要使用<code>chmod go+w /path/to/server_data</code>修改权限</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>nfs-kernel-server</code> 受<code>systemd</code>管理</p>
</div>
<p>所有的K8S节点都是NFS客户端，需要安装<code>nfs-common</code>组件。客户端挂载NFS存储有两种方式</p>
<ul>
<li>单次挂载</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a>mount -tnfs server_ip:/path/to/server_data /path/to/client_data
</code></pre></div>
<p>其中<code>server_ip</code>是NFS服务器IP(<code>storage0</code>节点IP)，<code>/path/to/server_data</code>为NFS服务器的共享路径。<code>/path/to/client_data</code>为本地挂载路径</p>
<ul>
<li>开机启动挂载</li>
</ul>
<p>需要修改<code>/etc/fstab</code>，添加挂载配置</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a>server_ip:/path/to/server_data  /path/to/client_data nfs rsize=8192,wsize=8192,timeo=14,intr
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>使用<code>/etc/fstab</code>挂载方法时，非常有必要用<code>charttr +i /path/to/client_data</code>命令为<code>/path/to/client_data</code>添加不可变选项。防止其意外产生读写行为</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>mount -a</code>可以挂载所有的挂载点</p>
</div>
<p>首先将该项目克隆到本地</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a>git clone https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner
<a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a><span class="nb">cd</span> nfs-subdir-external-provisioner
<a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a>git checkout nfs-subdir-external-provisioner-4.0.16 <span class="c1"># 使用4.0.16</span>
</code></pre></div>
<p>根据官网的提示，修改并创建对应的rbac角色</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a><span class="nv">NS</span><span class="o">=</span><span class="k">$(</span>kubectl config get-contexts<span class="p">|</span>grep -e <span class="s2">&quot;^\*&quot;</span> <span class="p">|</span>awk <span class="s1">&#39;{print $5}&#39;</span><span class="k">)</span>
<a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a><span class="nv">NAMESPACE</span><span class="o">=</span><span class="si">${</span><span class="nv">NS</span><span class="k">:-</span><span class="nv">default</span><span class="si">}</span>
<a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a>sed -i <span class="s1">&#39;&#39;</span> <span class="s2">&quot;s/namespace:.*/namespace: </span><span class="nv">$NAMESPACE</span><span class="s2">/g&quot;</span> ./deploy/rbac.yaml ./deploy/deployment.yaml
<a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a>kubectl create -f deploy/rbac.yaml
</code></pre></div>
<p>然后修改<code>deploy/deployment.yaml</code>和<code>class.yaml</code>，添加NFS服务器的地址和目录</p>
<div class="highlight"><span class="filename">deployment.yaml</span><pre><span></span><code><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-client-provisioner</span><span class="w"></span>
<a id="__codelineno-136-5" name="__codelineno-136-5" href="#__codelineno-136-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-6" name="__codelineno-136-6" href="#__codelineno-136-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-client-provisioner</span><span class="w"></span>
<a id="__codelineno-136-7" name="__codelineno-136-7" href="#__codelineno-136-7"></a><span class="w">  </span><span class="c1"># replace with namespace where provisioner is deployed</span><span class="w"></span>
<a id="__codelineno-136-8" name="__codelineno-136-8" href="#__codelineno-136-8"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOUR_NAMESPACE&gt;</span><span class="w">  </span><span class="c1"># provisioner 的 namespace, 默认为default</span><span class="w"></span>
<a id="__codelineno-136-9" name="__codelineno-136-9" href="#__codelineno-136-9"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-10" name="__codelineno-136-10" href="#__codelineno-136-10"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<a id="__codelineno-136-11" name="__codelineno-136-11" href="#__codelineno-136-11"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-12" name="__codelineno-136-12" href="#__codelineno-136-12"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Recreate</span><span class="w"></span>
<a id="__codelineno-136-13" name="__codelineno-136-13" href="#__codelineno-136-13"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-14" name="__codelineno-136-14" href="#__codelineno-136-14"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-15" name="__codelineno-136-15" href="#__codelineno-136-15"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-client-provisioner</span><span class="w"></span>
<a id="__codelineno-136-16" name="__codelineno-136-16" href="#__codelineno-136-16"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-17" name="__codelineno-136-17" href="#__codelineno-136-17"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-18" name="__codelineno-136-18" href="#__codelineno-136-18"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-19" name="__codelineno-136-19" href="#__codelineno-136-19"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-client-provisioner</span><span class="w"></span>
<a id="__codelineno-136-20" name="__codelineno-136-20" href="#__codelineno-136-20"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-21" name="__codelineno-136-21" href="#__codelineno-136-21"></a><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-client-provisioner</span><span class="w"></span>
<a id="__codelineno-136-22" name="__codelineno-136-22" href="#__codelineno-136-22"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-23" name="__codelineno-136-23" href="#__codelineno-136-23"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-client-provisioner</span><span class="w"></span>
<a id="__codelineno-136-24" name="__codelineno-136-24" href="#__codelineno-136-24"></a><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2</span><span class="w"> </span>
<a id="__codelineno-136-25" name="__codelineno-136-25" href="#__codelineno-136-25"></a><span class="w">          </span><span class="c1"># 可能需要换一个镜像</span><span class="w"></span>
<a id="__codelineno-136-26" name="__codelineno-136-26" href="#__codelineno-136-26"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-27" name="__codelineno-136-27" href="#__codelineno-136-27"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-client-root</span><span class="w"></span>
<a id="__codelineno-136-28" name="__codelineno-136-28" href="#__codelineno-136-28"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/persistentvolumes</span><span class="w"></span>
<a id="__codelineno-136-29" name="__codelineno-136-29" href="#__codelineno-136-29"></a><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-30" name="__codelineno-136-30" href="#__codelineno-136-30"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PROVISIONER_NAME</span><span class="w"></span>
<a id="__codelineno-136-31" name="__codelineno-136-31" href="#__codelineno-136-31"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-sigs.io/nfs-subdir-external-provisioner</span><span class="w"> </span><span class="c1"># 或者Storage class的provisioner匹配</span><span class="w"></span>
<a id="__codelineno-136-32" name="__codelineno-136-32" href="#__codelineno-136-32"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NFS_SERVER</span><span class="w"></span>
<a id="__codelineno-136-33" name="__codelineno-136-33" href="#__codelineno-136-33"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOUR NFS SERVER HOSTNAME&gt;</span><span class="w"> </span><span class="c1"># NFS 地址</span><span class="w"></span>
<a id="__codelineno-136-34" name="__codelineno-136-34" href="#__codelineno-136-34"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NFS_PATH</span><span class="w"></span>
<a id="__codelineno-136-35" name="__codelineno-136-35" href="#__codelineno-136-35"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOUR NFS SERVER PATH&gt;</span><span class="w"> </span><span class="c1"># NFS 目录</span><span class="w"></span>
<a id="__codelineno-136-36" name="__codelineno-136-36" href="#__codelineno-136-36"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-37" name="__codelineno-136-37" href="#__codelineno-136-37"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-client-root</span><span class="w"></span>
<a id="__codelineno-136-38" name="__codelineno-136-38" href="#__codelineno-136-38"></a><span class="w">          </span><span class="nt">nfs</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-136-39" name="__codelineno-136-39" href="#__codelineno-136-39"></a><span class="w">            </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOUR NFS SERVER HOSTNAME&gt;</span><span class="w"> </span><span class="c1"># NFS 地址</span><span class="w"></span>
<a id="__codelineno-136-40" name="__codelineno-136-40" href="#__codelineno-136-40"></a><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOUR NFS SERVER PATH&gt;</span><span class="w"> </span><span class="c1"># NFS 目录</span><span class="w"></span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner</code>镜像可能无法轻松下载。可以用<code>registry.hub.docker.com/davidliyutong/nfs-subdir-external-provisioner</code>替代</p>
</div>
<div class="highlight"><span class="filename">class.yaml</span><pre><span></span><code><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span><span class="w"></span>
<a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StorageClass</span><span class="w"></span>
<a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-137-4" name="__codelineno-137-4" href="#__codelineno-137-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-client</span><span class="w"></span>
<a id="__codelineno-137-5" name="__codelineno-137-5" href="#__codelineno-137-5"></a><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-sigs.io/nfs-subdir-external-provisioner</span><span class="w"> </span>
<a id="__codelineno-137-6" name="__codelineno-137-6" href="#__codelineno-137-6"></a><span class="c1"># 匹配 deployment&#39;s env PROVISIONER_NAME</span><span class="w"></span>
<a id="__codelineno-137-7" name="__codelineno-137-7" href="#__codelineno-137-7"></a><span class="nt">parameters</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-137-8" name="__codelineno-137-8" href="#__codelineno-137-8"></a><span class="w">  </span><span class="c1"># pathPattern: &quot;${.PVC.namespace}-${.PVC.name}&quot; </span><span class="w"></span>
<a id="__codelineno-137-9" name="__codelineno-137-9" href="#__codelineno-137-9"></a><span class="w">  </span><span class="c1"># waits for nfs.io/storage-path annotation, default is empty string.</span><span class="w"></span>
<a id="__codelineno-137-10" name="__codelineno-137-10" href="#__codelineno-137-10"></a><span class="w">  </span><span class="c1"># onDelete: delete</span><span class="w"></span>
<a id="__codelineno-137-11" name="__codelineno-137-11" href="#__codelineno-137-11"></a><span class="w">  </span><span class="c1"># archiveOnDelete: false</span><span class="w"></span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>onDelete</td>
<td><code>delete</code> 在PVC删除后删除数据, <code>retain</code>在PVC删除后保留数据；默认是保存在<code>archived-&lt;volume.Name&gt;</code>目录下</td>
</tr>
<tr>
<td>archiveOnDelete</td>
<td><code>false</code> 在PVC删除后删除数据, 否则进行归档。如果有<code>onDelete</code>，<code>archiveOnDelete</code> 将会被忽略。</td>
</tr>
<tr>
<td>pathPattern</td>
<td>卷目录的命名方式，例如 <code>${.PVC.namespace}-${.PVC.name}</code>可以创建<code>&lt;pvc-namespace&gt;-&lt;pvc-name&gt;</code></td>
</tr>
</tbody>
</table>
<p>对修改后的配置进行应用</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a>kubectl apply -f deploy/deployment.yaml
<a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a>kubectl apply -f deploy/class.yaml
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>设置一个storageClass为默认</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a>kubectl patch storageclass &lt;storageClass&gt; -p <span class="s1">&#39;{&quot;metadata&quot;: {&quot;annotations&quot;:{&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;}}}&#39;</span>
</code></pre></div>
<p>取消一个storageClass的默认设置</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a>kubectl patch storageclass &lt;storageClass&gt; -p <span class="s1">&#39;{&quot;metadata&quot;: {&quot;annotations&quot;:{&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;false&quot;}}}&#39;</span>
</code></pre></div>
</div>
<p><code>nfs-subdir-external-provisioner</code>项目提供了一个测试用例。该测试用例由<code>test-claim.yaml</code>和<code>test-pod.yaml</code>构成</p>
<div class="highlight"><span class="filename">test-claim.yaml</span><pre><span></span><code><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span><span class="w"></span>
<a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-claim</span><span class="w"></span>
<a id="__codelineno-141-5" name="__codelineno-141-5" href="#__codelineno-141-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-141-6" name="__codelineno-141-6" href="#__codelineno-141-6"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-client</span><span class="w"></span>
<a id="__codelineno-141-7" name="__codelineno-141-7" href="#__codelineno-141-7"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-141-8" name="__codelineno-141-8" href="#__codelineno-141-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span><span class="w"></span>
<a id="__codelineno-141-9" name="__codelineno-141-9" href="#__codelineno-141-9"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-141-10" name="__codelineno-141-10" href="#__codelineno-141-10"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-141-11" name="__codelineno-141-11" href="#__codelineno-141-11"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Mi</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><span class="filename">test-pod.yaml</span><pre><span></span><code><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-142-4" name="__codelineno-142-4" href="#__codelineno-142-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-pod</span><span class="w"></span>
<a id="__codelineno-142-5" name="__codelineno-142-5" href="#__codelineno-142-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-142-6" name="__codelineno-142-6" href="#__codelineno-142-6"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-142-7" name="__codelineno-142-7" href="#__codelineno-142-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-pod</span><span class="w"></span>
<a id="__codelineno-142-8" name="__codelineno-142-8" href="#__codelineno-142-8"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox:stable</span><span class="w"></span>
<a id="__codelineno-142-9" name="__codelineno-142-9" href="#__codelineno-142-9"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-142-10" name="__codelineno-142-10" href="#__codelineno-142-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/bin/sh&quot;</span><span class="w"></span>
<a id="__codelineno-142-11" name="__codelineno-142-11" href="#__codelineno-142-11"></a><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-142-12" name="__codelineno-142-12" href="#__codelineno-142-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="w"></span>
<a id="__codelineno-142-13" name="__codelineno-142-13" href="#__codelineno-142-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;touch</span><span class="nv"> </span><span class="s">/mnt/SUCCESS</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">exit</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">exit</span><span class="nv"> </span><span class="s">1&quot;</span><span class="w"></span>
<a id="__codelineno-142-14" name="__codelineno-142-14" href="#__codelineno-142-14"></a><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-142-15" name="__codelineno-142-15" href="#__codelineno-142-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-pvc</span><span class="w"></span>
<a id="__codelineno-142-16" name="__codelineno-142-16" href="#__codelineno-142-16"></a><span class="w">        </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/mnt&quot;</span><span class="w"></span>
<a id="__codelineno-142-17" name="__codelineno-142-17" href="#__codelineno-142-17"></a><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Never&quot;</span><span class="w"></span>
<a id="__codelineno-142-18" name="__codelineno-142-18" href="#__codelineno-142-18"></a><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-142-19" name="__codelineno-142-19" href="#__codelineno-142-19"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-pvc</span><span class="w"></span>
<a id="__codelineno-142-20" name="__codelineno-142-20" href="#__codelineno-142-20"></a><span class="w">      </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-142-21" name="__codelineno-142-21" href="#__codelineno-142-21"></a><span class="w">        </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-claim</span><span class="w"></span>
</code></pre></div>
<p>解释:</p>
<p>该测试用例将申请一个容量为1MiB的PVC，并且在这个PVC挂载到容器的<code>/mnt</code>中。容器将尝试在<code>/mnt</code>中创建一个<code>SUCCESS</code>文件</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a>kubectl apply -f deploy/test-claim.yaml -f deploy/test-pod.yaml
</code></pre></div>
<p><img alt="CI Test" src="../img/20220510161831.png" /></p>
<p>当容器运行完毕后，我们应该能在NFS目录中看到新创建的文件</p>
<p>当我们删除测试用例的时候，PVC和PV将一并删除（因为<code>storageClass.yaml</code>中的<code>onDelete</code>设置为了<code>delete</code>）</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a>kubectl delete -f deploy/test-claim.yaml -f deploy/test-pod.yaml
</code></pre></div>
<h4 id="ceph">Ceph</h4>
<div class="admonition todo">
<p class="admonition-title">Todo</p>
<p>这一部分的实验有待改进</p>
</div>
<p>Ceph是一个统一的分布式存储系统，设计初衷是提供较好的性能、可靠性和可扩展性。K8S通过cephfs支持Ceph。</p>
<p>如果要部署Ceph，可以参考官方的教程<a href="https://docs.ceph.com/en/quincy/cephadm/services/mds/#orchestrator-cli-cephfs">Ceph</a></p>
<p>Ceph的部署思路基本上是</p>
<ol>
<li>首先在单主机上引导一个Ceph集群，只有一个节点</li>
<li>随后将其他节点加入集群</li>
<li>节点和节点之间用SSH免密码管理</li>
</ol>
<p>一些Ceph的概念</p>
<ul>
<li><code>MON</code> Monitor，Ceph守护进程，所有节点都向Monitor报告。一个集群中应该有3-5个<code>MON</code></li>
<li><code>RBD</code> Ceph对外提供的块存储服务（Block Storage）</li>
<li><code>RGW</code> Ceph对外提供的对象存储服务，兼容Amazon S3和OpenStac Swift （Object Storage）</li>
<li><code>MDS</code> 元数据服务器</li>
<li><code>OSD</code> Object Storage Device，提供存储能力的设备</li>
<li><code>RADOS``MON</code>,<code>OSD</code> 的集合</li>
</ul>
<p><a href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">Ceph RBD</a>介绍了管理员应该如何为K8S添加Ceph</p>
<pre class="mermaid"><code>flowchart TD
    subgraph APPS
    end
    APPS --&gt; RADOS
    subgraph S3/Swift
    end
    S3/Swift --&gt; radosgw --&gt; RADOS
    subgraph VMs
    end
    VMs --&gt; librd --&gt; RADOS
    subgraph libcephfs
    end
    libcephfs --&gt; MDS --&gt; RADOS
    subgraph RADOS
        direction LR
        subgraph Librados
        end
        subgraph MON
            M0((Mon))
            M1((Mon))
            M2((Mon))
        end

        subgraph OSD
            subgraph OSD1
               direction LR
                O10(OSD)
                O11(Filesystem)
                O12(Disk)
            end
            subgraph OSD2
                direction LR
                O20(OSD)
                O21(Filesystem)
                O22(Disk)
            end
        end
    end</code></pre>
<p>首先创建一些虚拟存储设备并且将它们挂载到虚拟机（storage0）中。Ceph只能利用满足以下条件的设备：</p>
<ol>
<li>没有文件系统</li>
<li>没有分区</li>
<li>设备没有被mount</li>
<li>设备没有LVM状态</li>
<li>设备大于5GB</li>
<li>设备不能包括Ceph BlueStore OSD</li>
</ol>
<p>因此我们不需要格式化这些存储设备。本次试验使用了3块10G的虚拟硬盘，他们分别是<code>storage:/dev/vdb</code>、<code>storage:/dev/vdc</code>和<code>storage:/dev/vdd</code>。</p>
<p><img alt="Virtual Disks" src="../img/20220516113703.png" /></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>fdisk -l</code>命令可以查看计算机上的存储设备
<img alt="Disks" src="../img/20220516133119.png" /></p>
</div>
<p>配置Ceph节点，完成以下设置</p>
<ol>
<li>设置hostname和/etc/hosts。本机的主机名也需要添加到/etc/hosts中</li>
<li>设置SSH免密码登陆</li>
<li>关闭selinux。iptables放行ceph-monitor和ceph-osd的端口（6800-7300）</li>
<li>节点配置NTP时间同步并获取一致的时间。Ceph是分布式集群，对时间很敏感，如果时间不正确可能会导致集群崩溃。</li>
<li>节点安装Docker, Python3</li>
</ol>
<p>如果是多节点的集群，需要在每个节点上重复配置。处于节约成本的考虑，本次实验只使用一个节点挂载多个磁盘。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a>curl --silent --remote-name --location https://github.com/ceph/ceph/raw/octopus/src/cephadm/cephadm
<a id="__codelineno-145-2" name="__codelineno-145-2" href="#__codelineno-145-2"></a>sudo install cephadm /usr/local/bin/cephadm
</code></pre></div>
<p>现在，应该可以在终端中使用<code>cephadm</code>命令。我们使用<code>cephadm</code>引导集群</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a><span class="nb">export</span> <span class="nv">IP</span><span class="o">=</span><span class="m">10</span>.64.13.100
<a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a><span class="nb">export</span> <span class="nv">ADMIN_USER</span><span class="o">=</span>admin
<a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a><span class="nb">export</span> <span class="nv">ADMIN_PASSWD</span><span class="o">=</span>admin
<a id="__codelineno-146-4" name="__codelineno-146-4" href="#__codelineno-146-4"></a>sudo cephadm bootstrap --mon-ip <span class="nv">$IP</span> --initial-dashboard-user <span class="nv">$ADMIN_USER</span> --initial-dashboard-password <span class="nv">$ADMIN_PASSWD</span> --dashboard-password-noupdate --skip-mon-network
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>$IP</code>为第一个mon节点的IP，<code>ADMIN_USER</code>，<code>ADMIN_PASSWD</code>为初始用户名和密码</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This command will:</p>
<ul>
<li>Create a monitor and manager daemon for the new cluster on the local host.</li>
<li>Generate a new SSH key for the Ceph cluster and add it to the root user’s /root/.ssh/authorized_keys file.</li>
<li>Write a copy of the public key to /etc/ceph/ceph.pub.</li>
<li>Write a minimal configuration file to /etc/ceph/ceph.conf. This file is needed to communicate with the new cluster.</li>
<li>Write a copy of the client.admin administrative (privileged!) secret key to /etc/ceph/ceph.client.admin.keyring.</li>
<li>Add the _admin label to the bootstrap host. By default, any host with this label will (also) get a copy of /etc/ceph/ceph.conf and /etc/ceph/ceph.client.admin.keyring.</li>
</ul>
</div>
<p><img alt="Ceph bootstrap success" src="../img/20220516133434.png" /></p>
<p>如图所示，成功启动集群后，我们就可以通过Web面板查看集群状态。</p>
<p>由于采用了容器化的理念。Ceph不在主机上安装Ceph工具，而是使用Docker容器提供管理用的工具：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a>sudo cephadm shell
</code></pre></div>
<p>该命令将会启动一个Docker容器来使用ceph工具。</p>
<p>我们略过添加mon节点的部分，因为这个Ceph集群只有一个mon节点。我们需要将创建的3块硬盘添加进Ceph集群</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph orch device ls
<a id="__codelineno-148-2" name="__codelineno-148-2" href="#__codelineno-148-2"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph orch daemon add osd storage0:/dev/vdb
<a id="__codelineno-148-3" name="__codelineno-148-3" href="#__codelineno-148-3"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph orch daemon add osd storage0:/dev/vdc
<a id="__codelineno-148-4" name="__codelineno-148-4" href="#__codelineno-148-4"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph orch daemon add osd storage0:/dev/vdd
<a id="__codelineno-148-5" name="__codelineno-148-5" href="#__codelineno-148-5"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph status
</code></pre></div>
<p><img alt="Ceph add storage" src="../img/20220516134324.png" /></p>
<p>我们可以发现，Ceph集群的状态变成了HEALTH_OK</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><a href="https://www.cnblogs.com/sanduzxcvbnm/p/14842496.html">这篇文章</a>介绍了如何用Rook在K8S集群上部署Ceph。它支持从K8S集群节点上的磁盘设备组成Ceph集群</p>
</div>
<p>我们需要为K8S创建一个OSD池，命名为<code>kube</code>，以及一个client认证，命名为<code>client.kube</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph osd pool create rbd <span class="c1"># rbd 默认pool</span>
<a id="__codelineno-149-2" name="__codelineno-149-2" href="#__codelineno-149-2"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph osd pool create kube <span class="m">128</span>
<a id="__codelineno-149-3" name="__codelineno-149-3" href="#__codelineno-149-3"></a>pool <span class="s1">&#39;kube&#39;</span> created
<a id="__codelineno-149-4" name="__codelineno-149-4" href="#__codelineno-149-4"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph auth get-or-create client.kube mon <span class="s1">&#39;allow r&#39;</span> osd <span class="s1">&#39;allow class-read object_prefix rbd_children, allow rwx pool=kube&#39;</span> -o ceph.client.kube.keyring
<a id="__codelineno-149-5" name="__codelineno-149-5" href="#__codelineno-149-5"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph auth get-key client.admin <span class="p">|</span> base64
<a id="__codelineno-149-6" name="__codelineno-149-6" href="#__codelineno-149-6"></a><span class="nv">QVFDOTRZRmlCa00rTHhBQUxrUGpnQjZLOERGR1lxeHNQRU5NbWc9PQ</span><span class="o">==</span>
<a id="__codelineno-149-7" name="__codelineno-149-7" href="#__codelineno-149-7"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph auth get-key client.kube <span class="p">|</span> base64
<a id="__codelineno-149-8" name="__codelineno-149-8" href="#__codelineno-149-8"></a><span class="nv">QVFBbDdZRmlJRjB5TFJBQStWK1ZTbjBzWUtNZ2U5Y1dnNk5TY3c9PQ</span><span class="o">==</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>128</code> 为PlaceGroup（PG）数量，建议设置为为2的整数幂。该值上限取决于存储能力</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>若要删除pool，须先开启删除选项后才可删除</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph config <span class="nb">set</span> mon mon_allow_pool_delete <span class="nb">true</span>
<a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph osd pool delete kube kube --yes-i-really-really-mean-it
</code></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Ceph默认Pool的size是3，最小值是2，这意味着每个pool都会分布在三台节点上。我们只有一个OSD节点，因此需要将pool的size设置成1</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph config <span class="nb">set</span> mon mon_allow_pool_size_one <span class="nb">true</span>
<a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a><span class="o">[</span>ceph<span class="o">]</span> $ ceph osd pool <span class="nb">set</span> &lt;pool&gt; size <span class="m">1</span> --yes-i-really-mean-it
</code></pre></div>
以设置pool的size为1</p>
</div>
<p>若要让K8S集群能够挂载Ceph存储，需要在所有的节点上安装<code>ceph-common</code>软件包</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a><span class="o">[</span>all<span class="o">]</span> $ apt-get update <span class="o">&amp;&amp;</span> apt-get install -y ceph-common
</code></pre></div>
<p>我们将上一步创建的Ceph密钥添加进K8S的Secret存储区中。可以通过配置文件或命令做到这一点</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">配置文件</label><label for="__tabbed_1_2">命令</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">ceph-secret.yaml</span><pre><span></span><code><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a>apiVersion: v1
<a id="__codelineno-153-2" name="__codelineno-153-2" href="#__codelineno-153-2"></a>kind: Secret
<a id="__codelineno-153-3" name="__codelineno-153-3" href="#__codelineno-153-3"></a>metadata:
<a id="__codelineno-153-4" name="__codelineno-153-4" href="#__codelineno-153-4"></a>  name: ceph-secret
<a id="__codelineno-153-5" name="__codelineno-153-5" href="#__codelineno-153-5"></a>  namespace: kube-system
<a id="__codelineno-153-6" name="__codelineno-153-6" href="#__codelineno-153-6"></a>data:
<a id="__codelineno-153-7" name="__codelineno-153-7" href="#__codelineno-153-7"></a>  key: QVFDOTRZRmlCa00rTHhBQUxrUGpnQjZLOERGR1lxeHNQRU5NbWc9PQ==
<a id="__codelineno-153-8" name="__codelineno-153-8" href="#__codelineno-153-8"></a>type:
<a id="__codelineno-153-9" name="__codelineno-153-9" href="#__codelineno-153-9"></a>  kubernetes.io/rbd
<a id="__codelineno-153-10" name="__codelineno-153-10" href="#__codelineno-153-10"></a>---
<a id="__codelineno-153-11" name="__codelineno-153-11" href="#__codelineno-153-11"></a>apiVersion: v1
<a id="__codelineno-153-12" name="__codelineno-153-12" href="#__codelineno-153-12"></a>kind: Secret
<a id="__codelineno-153-13" name="__codelineno-153-13" href="#__codelineno-153-13"></a>metadata:
<a id="__codelineno-153-14" name="__codelineno-153-14" href="#__codelineno-153-14"></a>  name: ceph-secret-user
<a id="__codelineno-153-15" name="__codelineno-153-15" href="#__codelineno-153-15"></a>  namespace: default
<a id="__codelineno-153-16" name="__codelineno-153-16" href="#__codelineno-153-16"></a>data:
<a id="__codelineno-153-17" name="__codelineno-153-17" href="#__codelineno-153-17"></a>  key: QVFBbDdZRmlJRjB5TFJBQStWK1ZTbjBzWUtNZ2U5Y1dnNk5TY3c9PQ==
<a id="__codelineno-153-18" name="__codelineno-153-18" href="#__codelineno-153-18"></a>type:
<a id="__codelineno-153-19" name="__codelineno-153-19" href="#__codelineno-153-19"></a>  kubernetes.io/rbd
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a>kubectl create secret generic ceph-secret --type<span class="o">=</span><span class="s2">&quot;kubernetes.io/rbd&quot;</span> <span class="se">\</span>
<a id="__codelineno-154-2" name="__codelineno-154-2" href="#__codelineno-154-2"></a>--from-literal<span class="o">=</span><span class="nv">key</span><span class="o">=</span><span class="s1">&#39;QVFDOTRZRmlCa00rTHhBQUxrUGpnQjZLOERGR1lxeHNQRU5NbWc9PQ==&#39;</span> <span class="se">\</span>
<a id="__codelineno-154-3" name="__codelineno-154-3" href="#__codelineno-154-3"></a>--namespace<span class="o">=</span>kube-system
<a id="__codelineno-154-4" name="__codelineno-154-4" href="#__codelineno-154-4"></a>kubectl create secret generic ceph-secret-user --type<span class="o">=</span><span class="s2">&quot;kubernetes.io/rbd&quot;</span> <span class="se">\</span>
<a id="__codelineno-154-5" name="__codelineno-154-5" href="#__codelineno-154-5"></a>--from-literal<span class="o">=</span><span class="nv">key</span><span class="o">=</span><span class="s1">&#39;QVFBbDdZRmlJRjB5TFJBQStWK1ZTbjBzWUtNZ2U5Y1dnNk5TY3c9PQ==&#39;</span> <span class="se">\</span>
<a id="__codelineno-154-6" name="__codelineno-154-6" href="#__codelineno-154-6"></a>--namespace<span class="o">=</span>default
</code></pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>需要替换具体的Key</p>
</div>
<p>K8S自带的容器不包含ceph客户端，因此即使在所有的节点上都安装了<code>ceph-common</code>，K8S也无法和Ceph集群通讯。此时可以手动在Ceph集群中使用<code>rbd create &lt;image&gt;</code>，然后手动创建PV/PVC给Pod使用，但是绝无可能实现StorageClass.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ceph-common的版本最好和Ceph集群的版本匹配</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>需要从cephadm创建的集群拷贝<code>/etc/ceph/ceph.conf</code>和<code>/etc/ceph/ceph.client.admin.keyring</code>到K8S集群各个节点对应目录</p>
</div>
<p>我们创建一个测试用例</p>
<div class="highlight"><span class="filename">test-pv-pvc.yaml</span><pre><span></span><code><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-155-2" name="__codelineno-155-2" href="#__codelineno-155-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span><span class="w"></span>
<a id="__codelineno-155-3" name="__codelineno-155-3" href="#__codelineno-155-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-4" name="__codelineno-155-4" href="#__codelineno-155-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph-pv</span><span class="w"></span>
<a id="__codelineno-155-5" name="__codelineno-155-5" href="#__codelineno-155-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-6" name="__codelineno-155-6" href="#__codelineno-155-6"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-7" name="__codelineno-155-7" href="#__codelineno-155-7"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100M</span><span class="w"></span>
<a id="__codelineno-155-8" name="__codelineno-155-8" href="#__codelineno-155-8"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-9" name="__codelineno-155-9" href="#__codelineno-155-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span><span class="w"></span>
<a id="__codelineno-155-10" name="__codelineno-155-10" href="#__codelineno-155-10"></a><span class="w">  </span><span class="nt">rbd</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-11" name="__codelineno-155-11" href="#__codelineno-155-11"></a><span class="w">    </span><span class="nt">monitors</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-12" name="__codelineno-155-12" href="#__codelineno-155-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.64.13.100:6789</span><span class="w"></span>
<a id="__codelineno-155-13" name="__codelineno-155-13" href="#__codelineno-155-13"></a><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube</span><span class="w"></span>
<a id="__codelineno-155-14" name="__codelineno-155-14" href="#__codelineno-155-14"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-pv</span><span class="w"></span>
<a id="__codelineno-155-15" name="__codelineno-155-15" href="#__codelineno-155-15"></a><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span><span class="w"></span>
<a id="__codelineno-155-16" name="__codelineno-155-16" href="#__codelineno-155-16"></a><span class="w">    </span><span class="nt">secretRef</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-17" name="__codelineno-155-17" href="#__codelineno-155-17"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph-secret-user</span><span class="w"></span>
<a id="__codelineno-155-18" name="__codelineno-155-18" href="#__codelineno-155-18"></a><span class="w">    </span><span class="nt">fsType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ext4</span><span class="w"></span>
<a id="__codelineno-155-19" name="__codelineno-155-19" href="#__codelineno-155-19"></a><span class="w">    </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<a id="__codelineno-155-20" name="__codelineno-155-20" href="#__codelineno-155-20"></a><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Recycle</span><span class="w"></span>
<a id="__codelineno-155-21" name="__codelineno-155-21" href="#__codelineno-155-21"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-155-22" name="__codelineno-155-22" href="#__codelineno-155-22"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span><span class="w"></span>
<a id="__codelineno-155-23" name="__codelineno-155-23" href="#__codelineno-155-23"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-155-24" name="__codelineno-155-24" href="#__codelineno-155-24"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-25" name="__codelineno-155-25" href="#__codelineno-155-25"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph-pvc</span><span class="w"></span>
<a id="__codelineno-155-26" name="__codelineno-155-26" href="#__codelineno-155-26"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-27" name="__codelineno-155-27" href="#__codelineno-155-27"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-28" name="__codelineno-155-28" href="#__codelineno-155-28"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span><span class="w"></span>
<a id="__codelineno-155-29" name="__codelineno-155-29" href="#__codelineno-155-29"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-30" name="__codelineno-155-30" href="#__codelineno-155-30"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-155-31" name="__codelineno-155-31" href="#__codelineno-155-31"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100M</span><span class="w"></span>
</code></pre></div>
<p><img alt="PVC Bound" src="../img/20220516223556.png" /></p>
<p>PVC成功绑定</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在使用StorageClass的过程中，有可能会出现PVC一直Pending，rbd-provisioner日志输出"unexpected error getting claim reference: selfLink was empty, can't make reference"。这时候需要修改K8S主节点的<code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>。添加<code>--feature-gates=RemoveSelfLink=false</code>参数。最后应用<code>kubectl apply -f /etc/kubernetes/manifests/kube-apiserver.yaml</code>
<a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/issues/25">Ref</a></p>
</div>
<h2 id="network">Network</h2>
<p>k8s的网络模型特点如下：</p>
<ol>
<li>每个 Pod 都拥有一个独立 IP 地址。Pod 内所有容器共享一个网络命名空间</li>
<li>扁平网络：集群内所有 Pod 都在一个直接连通的扁平网络中，可通过 IP 直接访问。这意味着：<ul>
<li>所有容器实现了基于iptables的无 NAT 访问</li>
<li>所有 Node 和所有容器之间的无 NAT 访问</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>这意味着容器自己看到的 IP 跟其他容器看到的一样</p>
</div>
</li>
<li>内网分离。Service/Cluster IP 只可以在集群内部访问(实现 LB)。外部请求需要通过 NodePort（无LB)、LoadBalance（云厂商实现LB） 或者 Ingress（插件实现LB) 来访问</li>
</ol>
<p>大部分有关网络的概念都在Service章节中提到了，本部分进行了一些补充实验</p>
<h3 id="hostport">hostPort</h3>
<p>hostPort 相当于<code>docker run -p &lt;hsotPort&gt;:&lt;containerPort&gt;</code>，为容器在主机上做个 NAT 映射，不用创建 SVC，因此端口只在容器运行的Node上监听，其无法负载多Pod。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a>kubectl apply -f 10_pod1-host-pod.yaml
</code></pre></div>
<p>我们需要定位到该Pod调度的节点</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a>$ kubectl get pods -o wide <span class="p">|</span> grep pod1-host
<a id="__codelineno-157-2" name="__codelineno-157-2" href="#__codelineno-157-2"></a>pod1-host-port <span class="m">0</span>/1  ContainerCreating  <span class="m">0</span> 4s &lt;none&gt; node2 &lt;none&gt;  &lt;none&gt;
</code></pre></div>
<p>因此，我们登陆集群，然后用curl测试该Pod的访问性</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a><span class="o">[</span>node0<span class="o">]</span> $ curl node2:30890
</code></pre></div>
<p><img alt="hostPort" src="../img/20220511223803.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Docker-Desktop 搭建的集群无法在宿主机上使用这种方法测试，而是需要Attach到对应的容器中</p>
</div>
<h3 id="hostnetwork">hostNetwork</h3>
<p>hostNetwork相当于 <code>docker run --net=host</code>，与主机共享 network 网络栈，不用创建SVC，因此端口只在容器运行的node上监听。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a>kubectl apply -f 12_pod2-host-network.yaml
</code></pre></div>
<p>Pod的80端口被映射到了主机。我们可以用<code>http://node2:80</code>访问该服务</p>
<p><img alt="hostNetwork" src="../img/20220511224138.png" /></p>
<h3 id="nodeport_1">nodePort</h3>
<p>在nodePort下，由 kube-proxy 操控为所有节点统一配置 iptables 规则。因此，SVC 上的 nodePort 会监听在所有的节点上。即使只有 1 个 Pod/服务副本，用户也可以通过访问任意节点的 nodePort 使用到这个服务。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a>kubectl apply -f 20_service1-node-port.yaml
</code></pre></div>
<p>我们可以尝试在外部直接访问该服务</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a>curl <span class="m">10</span>.119.11.103:30888
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>10.119.11.103</code>是node0的外部IP</p>
</div>
<p><img alt="nodePort" src="../img/20220511224829.png" /></p>
<h3 id="externalip">externalIP</h3>
<p>nodeport会监听在所有的节点上，有时候我们不想要这样。这时候可以通过SVC来实现pod间的负载，实现只监听某台指定node上的节点。</p>
<div class="highlight"><span class="filename">22_service2-external-ip.yaml</span><pre><span></span><code><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<a id="__codelineno-162-2" name="__codelineno-162-2" href="#__codelineno-162-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<a id="__codelineno-162-3" name="__codelineno-162-3" href="#__codelineno-162-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-4" name="__codelineno-162-4" href="#__codelineno-162-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service1-dep-external-ip</span><span class="w"></span>
<a id="__codelineno-162-5" name="__codelineno-162-5" href="#__codelineno-162-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-6" name="__codelineno-162-6" href="#__codelineno-162-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-162-7" name="__codelineno-162-7" href="#__codelineno-162-7"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-8" name="__codelineno-162-8" href="#__codelineno-162-8"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"> </span><span class="c1"># 创建了两个副本</span><span class="w"></span>
<a id="__codelineno-162-9" name="__codelineno-162-9" href="#__codelineno-162-9"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-10" name="__codelineno-162-10" href="#__codelineno-162-10"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-11" name="__codelineno-162-11" href="#__codelineno-162-11"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-162-12" name="__codelineno-162-12" href="#__codelineno-162-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-13" name="__codelineno-162-13" href="#__codelineno-162-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-14" name="__codelineno-162-14" href="#__codelineno-162-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-15" name="__codelineno-162-15" href="#__codelineno-162-15"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-162-16" name="__codelineno-162-16" href="#__codelineno-162-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-17" name="__codelineno-162-17" href="#__codelineno-162-17"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-18" name="__codelineno-162-18" href="#__codelineno-162-18"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-162-19" name="__codelineno-162-19" href="#__codelineno-162-19"></a><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.9.0</span><span class="w"></span>
<a id="__codelineno-162-20" name="__codelineno-162-20" href="#__codelineno-162-20"></a><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-162-21" name="__codelineno-162-21" href="#__codelineno-162-21"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-22" name="__codelineno-162-22" href="#__codelineno-162-22"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
<a id="__codelineno-162-23" name="__codelineno-162-23" href="#__codelineno-162-23"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-162-24" name="__codelineno-162-24" href="#__codelineno-162-24"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-162-25" name="__codelineno-162-25" href="#__codelineno-162-25"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"></span>
<a id="__codelineno-162-26" name="__codelineno-162-26" href="#__codelineno-162-26"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-27" name="__codelineno-162-27" href="#__codelineno-162-27"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service2-external-ip</span><span class="w"></span>
<a id="__codelineno-162-28" name="__codelineno-162-28" href="#__codelineno-162-28"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-29" name="__codelineno-162-29" href="#__codelineno-162-29"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-30" name="__codelineno-162-30" href="#__codelineno-162-30"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-162-31" name="__codelineno-162-31" href="#__codelineno-162-31"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-32" name="__codelineno-162-32" href="#__codelineno-162-32"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span><span class="w"></span>
<a id="__codelineno-162-33" name="__codelineno-162-33" href="#__codelineno-162-33"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
<a id="__codelineno-162-34" name="__codelineno-162-34" href="#__codelineno-162-34"></a><span class="w">  </span><span class="nt">externalIPs</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-162-35" name="__codelineno-162-35" href="#__codelineno-162-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOUR_NODE_IP&gt;</span><span class="w"> </span><span class="c1"># 需要替换成一个Node的IP</span><span class="w"></span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>&lt;YOUR_NODE_IP&gt;</code>部分需要替换成Node的外部IP（即从集群外访问Node使用的IP）这个IP是为了设置iptables用的。如果使用了内部IP，则来自外部的通讯会被iptables拒绝，服务就只能在集群内访问了。
另一方面如果<code>&lt;YOUR_NODE_IP&gt;</code>被设置成了集群节点网卡获得的IP，而Replica数量又大于1，最终导致多个Pod调度到了同一个节点。则会发生重复绑定的问题。如果它们没有调度到一个节点，就会出现不在改网卡节点的Pod无法启动的问题。
因此，我们需要将<code>&lt;YOUR_NODE_IP&gt;</code>替换成一个外部浮动IP</p>
</div>
<p>我们将该地址设置为<code>node2</code>的外部浮动IP，即<code>10.119.11.125</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a>kubectl apply -f 22_service2-external-ip.yaml
</code></pre></div>
<p>在集群外，通过<code>10.119.11.125</code>访问失败。这可能是因为我们节点托管的云主机在浮动IP的处理上的问题。</p>
<p><img alt="Cannot Assign IP" src="../img/20220511233524.png" />  </p>
<p>在集群内，我们使用<code>10.64.13.12</code>访问该服务失败，但是通过<code>10.119.11.125</code>访问成功。</p>
<p><img alt="Strange Access" src="../img/20220511235413.png" /></p>
<h3 id="ingress-controller">Ingress Controller</h3>
<blockquote>
<p><a href="https://ingress.fandom.com/wiki/Ingress">Ingress</a> is <strong>also</strong> an augmented reality massively multiplayer online role-playing location-based game created by Niantic Labs.</p>
</blockquote>
<p>Ingress Controller首先是一种特殊的、独立的Pod资源，而不是和DaemonSet 、Deployment等同的概念。一般来说，Ingress Controller就是一个运行着有七层代理能力或调度能力的应用，比如：<a href="https://nginx.org/en">NGINX</a>、<a href="https://www.haproxy.org">HAproxy</a>、<a href="https://traefik.io">Traefik</a>、<a href="https://www.envoyproxy.io">Envoy</a>。Ingress应该使用DaemonSet部署在每一个节点上，并且位于kube-system命名空间</p>
<pre class="mermaid"><code>graph LR
  C0([Client]) -.-&gt; |LB| I0
  subgraph K8S Cluster
    I0[Ingress] --&gt; |Ingress Routing&lt;br&gt; L7| S[Service]
    S --&gt; |L4| P0[Pod]
    S --&gt; |L4| P1[Pod]
  end</code></pre>
<p>Serviced的缺陷是它的工作基于iptables或ipvs的，<strong>只是工作在TCP/IP协议栈</strong>。Service是无法调度外部的HTTPS请求到内部的HTTP服务，并实现负载均衡（证书和私钥的配置问题）。另一个例子是SSO认证问题。外部DNS解析一般是基于域名解析，解析到的地址也是负载均衡调度器的地址。而SSO会话是微服务的后端服务器建立的连接，因此需要每一台后端服务器都配置证书，增大开销。如果我们认为内部网络是安全的，就可以在接入层卸载SSO会话。这时候，集群外部使用HTTPS通信，内部使用HTTP通信。调度器Pod运行一个<strong>七层的应用代理</strong>。当用户请求时，先到达这个独特的调度器，而不是直接到达后端的Pod，Pod和Pod之间由于是在同一网段可以直接通信，无需经过Service。这个Pod就叫做Ingress Controller。</p>
<p>Ingress则是K8S对象的一员，它负责生命Ingress需求。例如</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span><span class="w"></span>
<a id="__codelineno-164-2" name="__codelineno-164-2" href="#__codelineno-164-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span><span class="w"></span>
<a id="__codelineno-164-3" name="__codelineno-164-3" href="#__codelineno-164-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-164-4" name="__codelineno-164-4" href="#__codelineno-164-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span><span class="w"></span>
<a id="__codelineno-164-5" name="__codelineno-164-5" href="#__codelineno-164-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-164-6" name="__codelineno-164-6" href="#__codelineno-164-6"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-164-7" name="__codelineno-164-7" href="#__codelineno-164-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo.bar.com</span><span class="w"></span>
<a id="__codelineno-164-8" name="__codelineno-164-8" href="#__codelineno-164-8"></a><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-164-9" name="__codelineno-164-9" href="#__codelineno-164-9"></a><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-164-10" name="__codelineno-164-10" href="#__codelineno-164-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/foo</span><span class="w"> </span><span class="c1"># 可以省略代表`/`根路径</span><span class="w"></span>
<a id="__codelineno-164-11" name="__codelineno-164-11" href="#__codelineno-164-11"></a><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-164-12" name="__codelineno-164-12" href="#__codelineno-164-12"></a><span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s1</span><span class="w"></span>
<a id="__codelineno-164-13" name="__codelineno-164-13" href="#__codelineno-164-13"></a><span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
<a id="__codelineno-164-14" name="__codelineno-164-14" href="#__codelineno-164-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bar</span><span class="w"></span>
<a id="__codelineno-164-15" name="__codelineno-164-15" href="#__codelineno-164-15"></a><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-164-16" name="__codelineno-164-16" href="#__codelineno-164-16"></a><span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s2</span><span class="w"></span>
<a id="__codelineno-164-17" name="__codelineno-164-17" href="#__codelineno-164-17"></a><span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
</code></pre></div>
<p>就定义了两条Path（<code>/foo</code>, <code>/bar</code>）的Ingress需求</p>
<p>我们主要实验Ingress的集中较为常见的使用场景：</p>
<ul>
<li>外部HTTPS流量进入集群后，卸载为HTTP流量</li>
<li>外部HTTPS流量，在Ingress Controller卸载，然后重新加密为SSL</li>
<li>外部HTTPS流量，不进行卸载，直接定向到后端</li>
</ul>
<p>HTTPS需要证书。我们可以用openssl工具生成一个</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a>openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:2048 <span class="se">\ </span>
<a id="__codelineno-165-2" name="__codelineno-165-2" href="#__codelineno-165-2"></a>                  -keyout &lt;KEY_FILENAME&gt; -out &lt;CERT_FILENAME&gt; <span class="se">\</span>
<a id="__codelineno-165-3" name="__codelineno-165-3" href="#__codelineno-165-3"></a>                  -subj <span class="s2">&quot;/CN=*.xxx.com/O=xxx.com&quot;</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>-days</code> 是证书的有效期
<code>CN=*.xxx.com</code>代表一个通配符证书，<code>O=xxx.com</code>是组织名。<code>/</code>分割。还有很多其他的信息可以附加到这个参数重
<code>&lt;KEY_FILENAME&gt;</code>是密钥的输出路径
<code>&lt;CERT_FILENAME&gt;</code> 是证书的输出路径</p>
</div>
<p>在测试Ingress的时候，我们需要让客户端的请求带上合适的请求头<code>curl -H</code>可以做到这一点</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a>curl -H <span class="s2">&quot;Host:svc.xxx.com&quot;</span>
</code></pre></div>
<p>会让请求报头指定的服务器的域名设置为<code>svc.xxx.com</code>，这就模拟了通过域名浏览的行为，而不必真正购买域名设置解析。</p>
<h4 id="-ingress-nginx">实验 - 安装ingress-nginx</h4>
<p>Ingress Controller需要安装在集群上。推荐的方法是通过Helm安装，但不完全通过Helm安装</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>可以通过<a href="https://helm.sh/zh/docs/intro/install/">Helm-Install</a>获取安装Helm安装的方法。</p>
</div>
<p>Helm安装K8S应用有如下阶段</p>
<ol>
<li>向Helm添加Repo。一个Repo就像是一个静态的站点</li>
<li>Helm从Report下载Charts（tgz格式）</li>
<li>Helm解压Charts，根据Charts部署APP</li>
</ol>
<p>由于网络原因，我们显然需要对这个过程加以改动:</p>
<ol>
<li>使用代理下载Charts</li>
<li>修改Charts中引用的镜像，替换成可以下载的</li>
</ol>
<p>执行以下命令</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-167-1" name="__codelineno-167-1" href="#__codelineno-167-1"></a>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx <span class="c1"># 添加Repo</span>
<a id="__codelineno-167-2" name="__codelineno-167-2" href="#__codelineno-167-2"></a>helm repo update
<a id="__codelineno-167-3" name="__codelineno-167-3" href="#__codelineno-167-3"></a>helm fetch ingress-nginx/ingress-nginx
<a id="__codelineno-167-4" name="__codelineno-167-4" href="#__codelineno-167-4"></a>tar -xvf ingress-nginx-x.xx.x.tgz
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>x.xx.x</code>为下载的ingress-nginx版本</p>
</div>
<p>将会把ingress-nginx的Charts解压到当前目录的ingress-nginx子目录下。我们需要修改其中的<code>values.yaml</code>以适应我们的集群。我们的集群有如下特点：</p>
<ol>
<li>没有外部的LB设施</li>
<li>没有安装内部的LB设施（例如MetalLB）</li>
<li>存在多个出口节点</li>
<li><code>k8s.gcr.io/ingress-nginx/kube-webhook-certgen</code>和<code>k8s.gcr.io/ingress-nginx/controller</code>镜像可能会无法下载，因此需要替换</li>
</ol>
<p>修改values.yaml如下</p>
<div class="highlight"><span class="filename">values.yaml</span><pre><span></span><code><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a><span class="c1"># values-prod.yaml</span><span class="w"></span>
<a id="__codelineno-168-2" name="__codelineno-168-2" href="#__codelineno-168-2"></a><span class="nt">controller</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-168-3" name="__codelineno-168-3" href="#__codelineno-168-3"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">controller</span><span class="w"></span>
<a id="__codelineno-168-4" name="__codelineno-168-4" href="#__codelineno-168-4"></a><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-168-5" name="__codelineno-168-5" href="#__codelineno-168-5"></a><span class="w">    </span><span class="nt">registry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">registry.hub.docker.com</span><span class="w"></span>
<a id="__codelineno-168-6" name="__codelineno-168-6" href="#__codelineno-168-6"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">davidliyutong/ingress-nginx-controller</span><span class="w"> </span><span class="c1"># 镜像替换</span><span class="w"></span>
<a id="__codelineno-168-7" name="__codelineno-168-7" href="#__codelineno-168-7"></a><span class="w">    </span><span class="nt">digest</span><span class="p">:</span><span class="w"> </span><span class="c1"># 需要把digest清零或者修改成正确的值</span><span class="w"></span>
<a id="__codelineno-168-8" name="__codelineno-168-8" href="#__codelineno-168-8"></a>
<a id="__codelineno-168-9" name="__codelineno-168-9" href="#__codelineno-168-9"></a><span class="w">  </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterFirstWithHostNet</span><span class="w"> </span><span class="c1"># 使用K8S的DNS</span><span class="w"></span>
<a id="__codelineno-168-10" name="__codelineno-168-10" href="#__codelineno-168-10"></a>
<a id="__codelineno-168-11" name="__codelineno-168-11" href="#__codelineno-168-11"></a><span class="w">  </span><span class="nt">extraArgs</span><span class="p">:</span><span class="w"> </span><span class="c1"># SSL-Passthrough 实验中需要的功能</span><span class="w"></span>
<a id="__codelineno-168-12" name="__codelineno-168-12" href="#__codelineno-168-12"></a><span class="w">    </span><span class="nt">enable-ssl-passthrough</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-168-13" name="__codelineno-168-13" href="#__codelineno-168-13"></a>
<a id="__codelineno-168-14" name="__codelineno-168-14" href="#__codelineno-168-14"></a><span class="w">  </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># 使用宿主网络，这将会占用所有出口的80/443端口</span><span class="w"></span>
<a id="__codelineno-168-15" name="__codelineno-168-15" href="#__codelineno-168-15"></a>
<a id="__codelineno-168-16" name="__codelineno-168-16" href="#__codelineno-168-16"></a><span class="w">  </span><span class="nt">publishService</span><span class="p">:</span><span class="w">  </span>
<a id="__codelineno-168-17" name="__codelineno-168-17" href="#__codelineno-168-17"></a><span class="w">  </span><span class="c1"># hostNetwork 模式下设置为false，通过节点IP地址上报ingress status数据，不创建服务</span><span class="w"></span>
<a id="__codelineno-168-18" name="__codelineno-168-18" href="#__codelineno-168-18"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<a id="__codelineno-168-19" name="__codelineno-168-19" href="#__codelineno-168-19"></a>
<a id="__codelineno-168-20" name="__codelineno-168-20" href="#__codelineno-168-20"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span><span class="w"></span>
<a id="__codelineno-168-21" name="__codelineno-168-21" href="#__codelineno-168-21"></a>
<a id="__codelineno-168-22" name="__codelineno-168-22" href="#__codelineno-168-22"></a><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-168-23" name="__codelineno-168-23" href="#__codelineno-168-23"></a><span class="w">    </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lb</span><span class="w"> </span><span class="c1"># 如果添加该选项，则只有存在role=lb的节点上才会有Pod</span><span class="w"></span>
<a id="__codelineno-168-24" name="__codelineno-168-24" href="#__codelineno-168-24"></a>
<a id="__codelineno-168-25" name="__codelineno-168-25" href="#__codelineno-168-25"></a><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">  </span><span class="c1"># HostNetwork 模式不需要创建service</span><span class="w"></span>
<a id="__codelineno-168-26" name="__codelineno-168-26" href="#__codelineno-168-26"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<a id="__codelineno-168-27" name="__codelineno-168-27" href="#__codelineno-168-27"></a>
<a id="__codelineno-168-28" name="__codelineno-168-28" href="#__codelineno-168-28"></a><span class="w">  </span><span class="nt">admissionWebhooks</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-168-29" name="__codelineno-168-29" href="#__codelineno-168-29"></a><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-168-30" name="__codelineno-168-30" href="#__codelineno-168-30"></a><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-168-31" name="__codelineno-168-31" href="#__codelineno-168-31"></a><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-168-32" name="__codelineno-168-32" href="#__codelineno-168-32"></a><span class="w">        </span><span class="nt">registry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">registry.hub.docker.com</span><span class="w"></span>
<a id="__codelineno-168-33" name="__codelineno-168-33" href="#__codelineno-168-33"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">davidliyutong/ingress-nginx-kube-webhook-certgen</span><span class="w"> </span><span class="c1"># 镜像替换</span><span class="w"></span>
<a id="__codelineno-168-34" name="__codelineno-168-34" href="#__codelineno-168-34"></a><span class="w">        </span><span class="nt">digest</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-168-35" name="__codelineno-168-35" href="#__codelineno-168-35"></a>
<a id="__codelineno-168-36" name="__codelineno-168-36" href="#__codelineno-168-36"></a><span class="nt">defaultBackend</span><span class="p">:</span><span class="w"> </span><span class="c1"># 路由没有命中时候的404页面提供方</span><span class="w"></span>
<a id="__codelineno-168-37" name="__codelineno-168-37" href="#__codelineno-168-37"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-168-38" name="__codelineno-168-38" href="#__codelineno-168-38"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">defaultbackend</span><span class="w"></span>
<a id="__codelineno-168-39" name="__codelineno-168-39" href="#__codelineno-168-39"></a><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-168-40" name="__codelineno-168-40" href="#__codelineno-168-40"></a><span class="w">    </span><span class="nt">registry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">registry.hub.docker.com</span><span class="w"></span>
<a id="__codelineno-168-41" name="__codelineno-168-41" href="#__codelineno-168-41"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">davidliyutong/ingress-nginx-defaultbackend-amd64</span><span class="w">  </span><span class="c1"># 镜像替换</span><span class="w"></span>
<a id="__codelineno-168-42" name="__codelineno-168-42" href="#__codelineno-168-42"></a><span class="w">    </span><span class="nt">digest</span><span class="p">:</span><span class="w"> </span>
</code></pre></div>
<p>我们需要创建一个ingress-nginx的命名空间，然后在该命名空间内安装<code>ingress-nginx</code>。这样的好处是卸载的时候只需要删除该命名空间，就可以删除所有的安装。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a>kubectl create ns ingress-nginx
</code></pre></div>
<p>最后，手动安装ingrex-nginx</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-170-1" name="__codelineno-170-1" href="#__codelineno-170-1"></a>helm install --namespace ingress-nginx ingress-nginx ./ingress-nginx <span class="se">\</span>
<a id="__codelineno-170-2" name="__codelineno-170-2" href="#__codelineno-170-2"></a>             -f ./ingress-nginx/values.yaml
</code></pre></div>
<p>所有Controller都READY标志着部署成功</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-171-1" name="__codelineno-171-1" href="#__codelineno-171-1"></a>$ kubectl get pods -n ingress-nginx -o wide
<a id="__codelineno-171-2" name="__codelineno-171-2" href="#__codelineno-171-2"></a>NAME                                            READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
<a id="__codelineno-171-3" name="__codelineno-171-3" href="#__codelineno-171-3"></a>ingress-nginx-controller-sht2v                  <span class="m">1</span>/1     Running   <span class="m">0</span>          22m   <span class="m">10</span>.64.13.11      node1   &lt;none&gt;           &lt;none&gt;
<a id="__codelineno-171-4" name="__codelineno-171-4" href="#__codelineno-171-4"></a>ingress-nginx-controller-wjb5j                  <span class="m">1</span>/1     Running   <span class="m">0</span>          22m   <span class="m">10</span>.64.13.12      node2   &lt;none&gt;           &lt;none&gt;
<a id="__codelineno-171-5" name="__codelineno-171-5" href="#__codelineno-171-5"></a>ingress-nginx-defaultbackend-8657d58dfc-hvx7s   <span class="m">1</span>/1     Running   <span class="m">0</span>          22m   <span class="m">10</span>.233.166.150   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>helm uninstall ingress-nginx</code> 可以反安装
<code>kubectl delete namespace ingress-nginx</code> 也可以，这是因为所有的ingress-nginx组件都安装在<code>ingress-nginx</code>命名空间下</p>
</div>
<h4 id="-_1">实验 - 编译镜像</h4>
<p>我们首先创建一系列的自签名证书</p>
<div class="highlight"><span class="filename">bootstrap_keys.sh</span><pre><span></span><code><a id="__codelineno-172-1" name="__codelineno-172-1" href="#__codelineno-172-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-172-2" name="__codelineno-172-2" href="#__codelineno-172-2"></a><span class="nb">cd</span> 12_svc2/
<a id="__codelineno-172-3" name="__codelineno-172-3" href="#__codelineno-172-3"></a>openssl genrsa -out ca.key <span class="m">1024</span>
<a id="__codelineno-172-4" name="__codelineno-172-4" href="#__codelineno-172-4"></a>openssl req -new -key ca.key -out ca.csr <span class="se">\</span>
<a id="__codelineno-172-5" name="__codelineno-172-5" href="#__codelineno-172-5"></a>            -subj <span class="s2">&quot;/C=CN/ST=Zhejiang/L=Hangzhou/O=My\ CA/CN=localhost&quot;</span> <span class="c1"># 替换</span>
<a id="__codelineno-172-6" name="__codelineno-172-6" href="#__codelineno-172-6"></a>openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt
<a id="__codelineno-172-7" name="__codelineno-172-7" href="#__codelineno-172-7"></a>openssl genrsa -out server.key <span class="m">1024</span>
<a id="__codelineno-172-8" name="__codelineno-172-8" href="#__codelineno-172-8"></a>openssl req -new -key server.key -out server.csr <span class="se">\</span>
<a id="__codelineno-172-9" name="__codelineno-172-9" href="#__codelineno-172-9"></a>            -subj <span class="s2">&quot;/C=CN/ST=Zhejiang/L=Hangzhou/O=My\ CA/CN=localhost&quot;</span> <span class="c1"># 替换</span>
<a id="__codelineno-172-10" name="__codelineno-172-10" href="#__codelineno-172-10"></a>openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial <span class="se">\</span>
<a id="__codelineno-172-11" name="__codelineno-172-11" href="#__codelineno-172-11"></a>             -in server.csr -out server.crt
<a id="__codelineno-172-12" name="__codelineno-172-12" href="#__codelineno-172-12"></a>rm ca.csr ca.srl server.csr
<a id="__codelineno-172-13" name="__codelineno-172-13" href="#__codelineno-172-13"></a>mv server.key ./src/
<a id="__codelineno-172-14" name="__codelineno-172-14" href="#__codelineno-172-14"></a>mv server.crt ./src/
<a id="__codelineno-172-15" name="__codelineno-172-15" href="#__codelineno-172-15"></a><span class="nb">cd</span> ..
<a id="__codelineno-172-16" name="__codelineno-172-16" href="#__codelineno-172-16"></a>
<a id="__codelineno-172-17" name="__codelineno-172-17" href="#__codelineno-172-17"></a>openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:2048 -keyout 14_svc3/ic.key <span class="se">\</span>
<a id="__codelineno-172-18" name="__codelineno-172-18" href="#__codelineno-172-18"></a>            -out 14_svc3/ic.crt -subj <span class="s2">&quot;/CN=*.xxx.com/O=xxx.com&quot;</span>
<a id="__codelineno-172-19" name="__codelineno-172-19" href="#__codelineno-172-19"></a>
<a id="__codelineno-172-20" name="__codelineno-172-20" href="#__codelineno-172-20"></a>openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:2048 -keyout 16_svc4/ic.key <span class="se">\</span>
<a id="__codelineno-172-21" name="__codelineno-172-21" href="#__codelineno-172-21"></a>            -out 16_svc4/ic.crt -subj <span class="s2">&quot;/CN=*.xxx.com/O=xxx.com&quot;</span>
<a id="__codelineno-172-22" name="__codelineno-172-22" href="#__codelineno-172-22"></a>
<a id="__codelineno-172-23" name="__codelineno-172-23" href="#__codelineno-172-23"></a>openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:2048 -keyout 18_svc5/ic.key <span class="se">\</span>
<a id="__codelineno-172-24" name="__codelineno-172-24" href="#__codelineno-172-24"></a>            -out 18_svc5/ic.crt -subj <span class="s2">&quot;/CN=*.xxx.com/O=xxx.com&quot;</span>
</code></pre></div>
<p>编译Ingress实验中使用的Docker镜像并且打标签。我们使用一个脚本来交互式地完成这项过程</p>
<div class="highlight"><span class="filename">build_images.sh</span><pre><span></span><code><a id="__codelineno-173-1" name="__codelineno-173-1" href="#__codelineno-173-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-173-2" name="__codelineno-173-2" href="#__codelineno-173-2"></a><span class="nb">read</span> -r -p <span class="s2">&quot;Input your docker username:&quot;</span> DOCKER_USERNAME
<a id="__codelineno-173-3" name="__codelineno-173-3" href="#__codelineno-173-3"></a>
<a id="__codelineno-173-4" name="__codelineno-173-4" href="#__codelineno-173-4"></a><span class="k">if</span> <span class="o">[</span> ! <span class="nv">$DOCKER_USERNAME</span><span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<a id="__codelineno-173-5" name="__codelineno-173-5" href="#__codelineno-173-5"></a><span class="nb">echo</span> <span class="s2">&quot;Username not provided&quot;</span>
<a id="__codelineno-173-6" name="__codelineno-173-6" href="#__codelineno-173-6"></a><span class="nb">exit</span> <span class="m">1</span><span class="p">;</span>
<a id="__codelineno-173-7" name="__codelineno-173-7" href="#__codelineno-173-7"></a><span class="k">fi</span>
<a id="__codelineno-173-8" name="__codelineno-173-8" href="#__codelineno-173-8"></a>
<a id="__codelineno-173-9" name="__codelineno-173-9" href="#__codelineno-173-9"></a><span class="nb">cd</span> 10_svc1/src
<a id="__codelineno-173-10" name="__codelineno-173-10" href="#__codelineno-173-10"></a>docker build -t <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc1:0.1 .
<a id="__codelineno-173-11" name="__codelineno-173-11" href="#__codelineno-173-11"></a><span class="nb">cd</span> ../..
<a id="__codelineno-173-12" name="__codelineno-173-12" href="#__codelineno-173-12"></a>
<a id="__codelineno-173-13" name="__codelineno-173-13" href="#__codelineno-173-13"></a><span class="nb">cd</span> 12_svc2/src
<a id="__codelineno-173-14" name="__codelineno-173-14" href="#__codelineno-173-14"></a>docker build -t <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc2:0.1 .
<a id="__codelineno-173-15" name="__codelineno-173-15" href="#__codelineno-173-15"></a><span class="nb">cd</span> ../..
<a id="__codelineno-173-16" name="__codelineno-173-16" href="#__codelineno-173-16"></a>
<a id="__codelineno-173-17" name="__codelineno-173-17" href="#__codelineno-173-17"></a><span class="nb">cd</span> 14_svc3/src
<a id="__codelineno-173-18" name="__codelineno-173-18" href="#__codelineno-173-18"></a>docker build -t <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc3:0.1 .
<a id="__codelineno-173-19" name="__codelineno-173-19" href="#__codelineno-173-19"></a><span class="nb">cd</span> ../..
<a id="__codelineno-173-20" name="__codelineno-173-20" href="#__codelineno-173-20"></a>
<a id="__codelineno-173-21" name="__codelineno-173-21" href="#__codelineno-173-21"></a><span class="nb">cd</span> 16_svc4/src
<a id="__codelineno-173-22" name="__codelineno-173-22" href="#__codelineno-173-22"></a>docker build -t <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc4:0.1 .
<a id="__codelineno-173-23" name="__codelineno-173-23" href="#__codelineno-173-23"></a><span class="nb">cd</span> ../..
<a id="__codelineno-173-24" name="__codelineno-173-24" href="#__codelineno-173-24"></a>
<a id="__codelineno-173-25" name="__codelineno-173-25" href="#__codelineno-173-25"></a><span class="nb">cd</span> 18_svc5/src
<a id="__codelineno-173-26" name="__codelineno-173-26" href="#__codelineno-173-26"></a>docker build -t <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc5:0.1 .
<a id="__codelineno-173-27" name="__codelineno-173-27" href="#__codelineno-173-27"></a><span class="nb">cd</span> ../..
<a id="__codelineno-173-28" name="__codelineno-173-28" href="#__codelineno-173-28"></a>
<a id="__codelineno-173-29" name="__codelineno-173-29" href="#__codelineno-173-29"></a><span class="nb">cd</span> svc6/src
<a id="__codelineno-173-30" name="__codelineno-173-30" href="#__codelineno-173-30"></a>docker build -t <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc6:0.1 .
<a id="__codelineno-173-31" name="__codelineno-173-31" href="#__codelineno-173-31"></a><span class="nb">cd</span> ../..
<a id="__codelineno-173-32" name="__codelineno-173-32" href="#__codelineno-173-32"></a>
<a id="__codelineno-173-33" name="__codelineno-173-33" href="#__codelineno-173-33"></a><span class="nb">read</span> -r -p <span class="s2">&quot;Push images ? [y/N]:&quot;</span> PUSH
<a id="__codelineno-173-34" name="__codelineno-173-34" href="#__codelineno-173-34"></a>
<a id="__codelineno-173-35" name="__codelineno-173-35" href="#__codelineno-173-35"></a><span class="k">case</span> <span class="nv">$PUSH</span> <span class="k">in</span> 
<a id="__codelineno-173-36" name="__codelineno-173-36" href="#__codelineno-173-36"></a>    <span class="o">[</span>yY<span class="o">][</span>eE<span class="o">][</span>sS<span class="o">]</span><span class="p">|</span><span class="o">[</span>yY<span class="o">])</span>
<a id="__codelineno-173-37" name="__codelineno-173-37" href="#__codelineno-173-37"></a>        docker login
<a id="__codelineno-173-38" name="__codelineno-173-38" href="#__codelineno-173-38"></a>        docker push <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc1:0.1
<a id="__codelineno-173-39" name="__codelineno-173-39" href="#__codelineno-173-39"></a>        docker push <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc2:0.1
<a id="__codelineno-173-40" name="__codelineno-173-40" href="#__codelineno-173-40"></a>        docker push <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc3:0.1
<a id="__codelineno-173-41" name="__codelineno-173-41" href="#__codelineno-173-41"></a>        docker push <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc4:0.1
<a id="__codelineno-173-42" name="__codelineno-173-42" href="#__codelineno-173-42"></a>        docker push <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc5:0.1
<a id="__codelineno-173-43" name="__codelineno-173-43" href="#__codelineno-173-43"></a>        docker push <span class="nv">$DOCKER_USERNAME</span>/nginx-ingress-demo-svc6:0.1
<a id="__codelineno-173-44" name="__codelineno-173-44" href="#__codelineno-173-44"></a>        <span class="nb">echo</span> <span class="s2">&quot;Done&quot;</span>
<a id="__codelineno-173-45" name="__codelineno-173-45" href="#__codelineno-173-45"></a>        <span class="p">;;</span>
<a id="__codelineno-173-46" name="__codelineno-173-46" href="#__codelineno-173-46"></a>
<a id="__codelineno-173-47" name="__codelineno-173-47" href="#__codelineno-173-47"></a>    <span class="o">[</span>nN<span class="o">][</span>oO<span class="o">]</span><span class="p">|</span><span class="o">[</span>nN<span class="o">])</span>
<a id="__codelineno-173-48" name="__codelineno-173-48" href="#__codelineno-173-48"></a>        <span class="nb">echo</span> <span class="s2">&quot;Done&quot;</span>
<a id="__codelineno-173-49" name="__codelineno-173-49" href="#__codelineno-173-49"></a>           <span class="p">;;</span>
<a id="__codelineno-173-50" name="__codelineno-173-50" href="#__codelineno-173-50"></a>
<a id="__codelineno-173-51" name="__codelineno-173-51" href="#__codelineno-173-51"></a>    *<span class="o">)</span>
<a id="__codelineno-173-52" name="__codelineno-173-52" href="#__codelineno-173-52"></a>        <span class="nb">echo</span> <span class="s2">&quot;Invalid input...&quot;</span>
<a id="__codelineno-173-53" name="__codelineno-173-53" href="#__codelineno-173-53"></a>        <span class="nb">exit</span> <span class="m">1</span>
<a id="__codelineno-173-54" name="__codelineno-173-54" href="#__codelineno-173-54"></a>        <span class="p">;;</span>
<a id="__codelineno-173-55" name="__codelineno-173-55" href="#__codelineno-173-55"></a><span class="k">esac</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>该脚本需要在<code>25_network/30_ingress</code>目录下执行。脚本首先询问需要使用的Docker用户名，然后将其打上相应的TAG。最后，脚本会询问用户要不要将镜像PUSH到Docker Registry上</p>
</div>
<h4 id="http-ingress-http">HTTP-Ingress-HTTP</h4>
<p>我们首先分析这个配置文件</p>
<div class="highlight"><span class="filename">10_svc1/ingress.yaml</span><pre><span></span><code><a id="__codelineno-174-1" name="__codelineno-174-1" href="#__codelineno-174-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<a id="__codelineno-174-2" name="__codelineno-174-2" href="#__codelineno-174-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<a id="__codelineno-174-3" name="__codelineno-174-3" href="#__codelineno-174-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-174-4" name="__codelineno-174-4" href="#__codelineno-174-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc1-deployment</span><span class="w"></span>
<a id="__codelineno-174-5" name="__codelineno-174-5" href="#__codelineno-174-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-174-6" name="__codelineno-174-6" href="#__codelineno-174-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress-demo</span><span class="w"> </span><span class="c1"># 和Service.spec.selector匹配</span><span class="w"></span>
<a id="__codelineno-174-7" name="__codelineno-174-7" href="#__codelineno-174-7"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-174-8" name="__codelineno-174-8" href="#__codelineno-174-8"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>
<a id="__codelineno-174-9" name="__codelineno-174-9" href="#__codelineno-174-9"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-174-10" name="__codelineno-174-10" href="#__codelineno-174-10"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> </span><span class="c1"># 和spec.template.metadata.labels匹配</span><span class="w"></span>
<a id="__codelineno-174-11" name="__codelineno-174-11" href="#__codelineno-174-11"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress-demo</span><span class="w"></span>
<a id="__codelineno-174-12" name="__codelineno-174-12" href="#__codelineno-174-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-174-13" name="__codelineno-174-13" href="#__codelineno-174-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-174-14" name="__codelineno-174-14" href="#__codelineno-174-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-174-15" name="__codelineno-174-15" href="#__codelineno-174-15"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress-demo</span><span class="w"> </span><span class="c1"># 和spec.selector.matchLabels匹配</span><span class="w"></span>
<a id="__codelineno-174-16" name="__codelineno-174-16" href="#__codelineno-174-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-174-17" name="__codelineno-174-17" href="#__codelineno-174-17"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-174-18" name="__codelineno-174-18" href="#__codelineno-174-18"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ct-go-server</span><span class="w"></span>
<a id="__codelineno-174-19" name="__codelineno-174-19" href="#__codelineno-174-19"></a><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wukongsun/nginx-ingress-demo-svc1:0.1</span><span class="w"></span>
<a id="__codelineno-174-20" name="__codelineno-174-20" href="#__codelineno-174-20"></a><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<a id="__codelineno-174-21" name="__codelineno-174-21" href="#__codelineno-174-21"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-174-22" name="__codelineno-174-22" href="#__codelineno-174-22"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span><span class="w"></span>
</code></pre></div>
<p>第一部分，启动了一个Go语言编写的服务器</p>
<div class="highlight"><span class="filename">main.go</span><pre><span></span><code><a id="__codelineno-175-1" name="__codelineno-175-1" href="#__codelineno-175-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
<a id="__codelineno-175-2" name="__codelineno-175-2" href="#__codelineno-175-2"></a>
<a id="__codelineno-175-3" name="__codelineno-175-3" href="#__codelineno-175-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-175-4" name="__codelineno-175-4" href="#__codelineno-175-4"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span><span class="w"></span>
<a id="__codelineno-175-5" name="__codelineno-175-5" href="#__codelineno-175-5"></a><span class="w">    </span><span class="s">&quot;log&quot;</span><span class="w"></span>
<a id="__codelineno-175-6" name="__codelineno-175-6" href="#__codelineno-175-6"></a><span class="w">    </span><span class="s">&quot;net/http&quot;</span><span class="w"></span>
<a id="__codelineno-175-7" name="__codelineno-175-7" href="#__codelineno-175-7"></a><span class="p">)</span><span class="w"></span>
<a id="__codelineno-175-8" name="__codelineno-175-8" href="#__codelineno-175-8"></a>
<a id="__codelineno-175-9" name="__codelineno-175-9" href="#__codelineno-175-9"></a><span class="kd">func</span><span class="w"> </span><span class="nx">handler</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-175-10" name="__codelineno-175-10" href="#__codelineno-175-10"></a><span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;receive a request&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-175-11" name="__codelineno-175-11" href="#__codelineno-175-11"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello, I am svc1 for ingress-controller demo!&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-175-12" name="__codelineno-175-12" href="#__codelineno-175-12"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-175-13" name="__codelineno-175-13" href="#__codelineno-175-13"></a>
<a id="__codelineno-175-14" name="__codelineno-175-14" href="#__codelineno-175-14"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-175-15" name="__codelineno-175-15" href="#__codelineno-175-15"></a><span class="w">    </span><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">handler</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-175-16" name="__codelineno-175-16" href="#__codelineno-175-16"></a><span class="w">    </span><span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-175-17" name="__codelineno-175-17" href="#__codelineno-175-17"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>这个服务器是一个普通的HTTP服务器，运行在8080端口</p>
<p>第二部分，定义了一个服务。该服务类型是ClusterIP，只能在集群内部访问。服务的端口是8888。</p>
<div class="highlight"><span class="filename">10_svc1/ingress.yaml</span><pre><span></span><code><a id="__codelineno-176-1" name="__codelineno-176-1" href="#__codelineno-176-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-176-2" name="__codelineno-176-2" href="#__codelineno-176-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"></span>
<a id="__codelineno-176-3" name="__codelineno-176-3" href="#__codelineno-176-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-176-4" name="__codelineno-176-4" href="#__codelineno-176-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc1-cluster-ip</span><span class="w"></span>
<a id="__codelineno-176-5" name="__codelineno-176-5" href="#__codelineno-176-5"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-176-6" name="__codelineno-176-6" href="#__codelineno-176-6"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-176-7" name="__codelineno-176-7" href="#__codelineno-176-7"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress-demo</span><span class="w"> </span><span class="c1"># 和Deployment.metadata.labels匹配</span><span class="w"></span>
<a id="__codelineno-176-8" name="__codelineno-176-8" href="#__codelineno-176-8"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span><span class="w"></span>
<a id="__codelineno-176-9" name="__codelineno-176-9" href="#__codelineno-176-9"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-176-10" name="__codelineno-176-10" href="#__codelineno-176-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span><span class="w"></span>
<a id="__codelineno-176-11" name="__codelineno-176-11" href="#__codelineno-176-11"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span><span class="w"></span>
<a id="__codelineno-176-12" name="__codelineno-176-12" href="#__codelineno-176-12"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8888</span><span class="w"></span>
</code></pre></div>
<p>第三部分定义了一个Ingress</p>
<div class="highlight"><span class="filename">10_svc1/ingress.yaml</span><pre><span></span><code><a id="__codelineno-177-1" name="__codelineno-177-1" href="#__codelineno-177-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span><span class="w"></span>
<a id="__codelineno-177-2" name="__codelineno-177-2" href="#__codelineno-177-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span><span class="w"></span>
<a id="__codelineno-177-3" name="__codelineno-177-3" href="#__codelineno-177-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-177-4" name="__codelineno-177-4" href="#__codelineno-177-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc1-ingress</span><span class="w"></span>
<a id="__codelineno-177-5" name="__codelineno-177-5" href="#__codelineno-177-5"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-177-6" name="__codelineno-177-6" href="#__codelineno-177-6"></a><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-177-7" name="__codelineno-177-7" href="#__codelineno-177-7"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-177-8" name="__codelineno-177-8" href="#__codelineno-177-8"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-177-9" name="__codelineno-177-9" href="#__codelineno-177-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc1.xxx.com</span><span class="w"></span>
<a id="__codelineno-177-10" name="__codelineno-177-10" href="#__codelineno-177-10"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-177-11" name="__codelineno-177-11" href="#__codelineno-177-11"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-177-12" name="__codelineno-177-12" href="#__codelineno-177-12"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span><span class="w"></span>
<a id="__codelineno-177-13" name="__codelineno-177-13" href="#__codelineno-177-13"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span><span class="w"></span>
<a id="__codelineno-177-14" name="__codelineno-177-14" href="#__codelineno-177-14"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-177-15" name="__codelineno-177-15" href="#__codelineno-177-15"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-177-16" name="__codelineno-177-16" href="#__codelineno-177-16"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc1-cluster-ip</span><span class="w"></span>
<a id="__codelineno-177-17" name="__codelineno-177-17" href="#__codelineno-177-17"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-177-18" name="__codelineno-177-18" href="#__codelineno-177-18"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8888</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-178-1" name="__codelineno-178-1" href="#__codelineno-178-1"></a>kubectl apply -f 10_svc1/ingress.yaml <span class="c1"># launch ingress, service and deployment</span>
</code></pre></div>
<p>我们现在可以通过集群的任意一个节点的IP来访问该服务</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-179-1" name="__codelineno-179-1" href="#__codelineno-179-1"></a>curl -H <span class="s1">&#39;Host:svc1.xxx.com&#39;</span> http://10.64.13.11:80
<a id="__codelineno-179-2" name="__codelineno-179-2" href="#__codelineno-179-2"></a>curl -H <span class="s1">&#39;Host:svc1.xxx.com&#39;</span> http://10.64.13.12:80
<a id="__codelineno-179-3" name="__codelineno-179-3" href="#__codelineno-179-3"></a>curl -H <span class="s1">&#39;Host:svc1.xxx.com&#39;</span> http://10.119.11.103:80
<a id="__codelineno-179-4" name="__codelineno-179-4" href="#__codelineno-179-4"></a>curl -H <span class="s1">&#39;Host:svc1.xxx.com&#39;</span> http://10.119.11.125:80
</code></pre></div>
<p><img alt="Ingress SVC1" src="../img/20220513232041.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>我们设置了不允许Pod调度到master节点（node0:10.64.13.10:10.119.11.12），因此无法通过该节点访问ingress-nginx</p>
</div>
<p>删除</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-180-1" name="__codelineno-180-1" href="#__codelineno-180-1"></a>kubectl delete -f 10_svc1/ingress.yaml
</code></pre></div>
<h4 id="-http-ingress-https">实验 - HTTP-Ingress-HTTPS</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-181-1" name="__codelineno-181-1" href="#__codelineno-181-1"></a>kubectl apply -f ./12_svc2/ingress.yaml <span class="c1"># launch ingress, service and deployment</span>
<a id="__codelineno-181-2" name="__codelineno-181-2" href="#__codelineno-181-2"></a>curl -H <span class="s1">&#39;Host:svc2.xxx.com&#39;</span> http://10.119.11.125:80
<a id="__codelineno-181-3" name="__codelineno-181-3" href="#__codelineno-181-3"></a>kubectl delete -f ./12_svc2/ingress.yaml
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>10.119.11.125</code>为集群出口之一的IP</p>
</div>
<p><img alt="Ingress SVC2" src="../img/20220514002708.png" /></p>
<h4 id="-https-ingress-http">实验 - HTTPS-Ingress-HTTP</h4>
<p>证书的生成已经在<code>bootstrap_keys.sh</code>中完成了</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-182-1" name="__codelineno-182-1" href="#__codelineno-182-1"></a>openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:2048 -keyout 14_svc3/ic.key <span class="se">\</span>
<a id="__codelineno-182-2" name="__codelineno-182-2" href="#__codelineno-182-2"></a>            -out 14_svc3/ic.crt -subj <span class="s2">&quot;/CN=*.xxx.com/O=xxx.com&quot;</span> <span class="se">\</span>
<a id="__codelineno-182-3" name="__codelineno-182-3" href="#__codelineno-182-3"></a>            -addext <span class="s2">&quot;subjectAltName = DNS:*.xxx.com&quot;</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>-addext</code>是新版GO对证书的要求（必须含有subjectAltName）</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-183-1" name="__codelineno-183-1" href="#__codelineno-183-1"></a>kubectl create secret tls secret-tls-svc3 <span class="se">\</span>
<a id="__codelineno-183-2" name="__codelineno-183-2" href="#__codelineno-183-2"></a>        --key 14_svc3/ic.key --cert 14_svc3/ic.crt <span class="c1"># create k8s secret</span>
<a id="__codelineno-183-3" name="__codelineno-183-3" href="#__codelineno-183-3"></a>kubectl apply -f ./14_svc3/ingress.yaml <span class="c1"># launch ingress, service and deployment</span>
</code></pre></div>
<p>我们忽略证书校验来访问服务</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-184-1" name="__codelineno-184-1" href="#__codelineno-184-1"></a>curl -H <span class="s2">&quot;Host:svc3.xxx.com&quot;</span> https://10.119.11.125 -k <span class="c1"># curl insecure mode</span>
</code></pre></div>
<p>接下来，我们尝试让curl正确验证证书后访问服务。curl 使用证书的时候需要把key和cert合并。可以使用cat命令做到这一点</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-185-1" name="__codelineno-185-1" href="#__codelineno-185-1"></a>cat 14_svc3/ic.key &gt;&gt; 14_svc3/ic.crt <span class="c1"># Merge key and cert</span>
<a id="__codelineno-185-2" name="__codelineno-185-2" href="#__codelineno-185-2"></a>curl --cert 14_svc3/ic.crt -H <span class="s2">&quot;host:svc3.xxx.com&quot;</span> https://10.119.11.125 
<a id="__codelineno-185-3" name="__codelineno-185-3" href="#__codelineno-185-3"></a><span class="c1"># doesn&#39;t work since the signer isn&#39;t authorized</span>
</code></pre></div>
<p>可以发现，这时候curl<strong>仍然无法正常工作</strong>。深入研究后发现，要想让curl能够正常验证服务器的自签名证书，服务器的证书必须构成一条完整的信任链。这意味需要满足以下两点之中的一个：</p>
<ol>
<li>服务器使用购买的证书。该证书是证书机构颁发的</li>
<li>自己在本地搭建证书服务，创建CA证书后用该证书签发中间证书，然后再签发服务器证书（<code>ic.crt</code>/<code>ic.key</code>。最后在curl命令中添加<code>--cacert</code>选项使用自己的证书链验证服务器证书（需要将CA根证书和中间证书合并到同一个文件中</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>阅读以下机制以了解更多:</p>
<ul>
<li><a href="https://shocksolution.com/2018/12/14/creating-kubernetes-secrets-using-tls-ssl-as-an-example/">Creating Kubernetes Secrets Using TLS/SSL as an Example</a></li>
<li><a href="https://shocksolution.com/2020/03/10/curl-or-libcurl-ssl-unable-to-get-local-issuer-certificate/">curl or libcurl: SSL certificate problem: unable to get local issuer certificate</a></li>
<li><a href="https://crypto.stackexchange.com/questions/63907/why-does-curl-need-both-root-and-intermediate-certificates-in-order-to-securely">Why does curl need both root and intermediate certificates in order to securely connect to an HTTP server?</a></li>
<li><a href="https://www.digac.cc/2020/06/use_openssl_to_create_root_certificate_intermediate_certificate_and_server_certificate.html">在Linux下使用openssl创建根证书，中间证书和服务端证书</a></li>
<li><a href="https://stackoverflow.com/questions/24611640/curl-60-ssl-certificate-problem-unable-to-get-local-issuer-certificate">curl: (60) SSL certificate problem: unable to get local issuer certificate</a></li>
<li><a href="https://stackoverflow.com/questions/26759550/how-to-create-own-self-signed-root-certificate-and-intermediate-ca-to-be-importe">How to create own self-signed root certificate and intermediate CA to be imported in Java keystore?</a></li>
</ul>
</div>
<p><img alt="Ingress SVC3" src="../img/20220514014056.png" /></p>
<p>删除资源</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-186-1" name="__codelineno-186-1" href="#__codelineno-186-1"></a>kubectl delete -f ./14_svc3/ingress.yaml
<a id="__codelineno-186-2" name="__codelineno-186-2" href="#__codelineno-186-2"></a>kubectl delete secret secret-tls-svc3
</code></pre></div>
<h4 id="-https-ingress-https-ssl-termination">实验 - HTTPS-Ingress-HTTPS (ssl-termination)</h4>
<p><code>16_svc4/src</code> 中存储了一对证书<code>server.crt</code>/<code>server.key</code>用于加密Ingress和后端间通讯的流量</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-187-1" name="__codelineno-187-1" href="#__codelineno-187-1"></a>kubectl create secret tls secret-tls-svc4 <span class="se">\</span>
<a id="__codelineno-187-2" name="__codelineno-187-2" href="#__codelineno-187-2"></a>        --key 16_svc4/ic.key --cert 16_svc4/ic.crt <span class="c1"># create secret</span>
<a id="__codelineno-187-3" name="__codelineno-187-3" href="#__codelineno-187-3"></a>kubectl apply -f ./16_svc4/ingress.yaml <span class="c1"># launch ingress, service and deployment</span>
<a id="__codelineno-187-4" name="__codelineno-187-4" href="#__codelineno-187-4"></a>curl -H <span class="s1">&#39;Host:svc4.xxx.com&#39;</span> https://10.119.11.125:443 -k
</code></pre></div>
<p>curl同样需要忽略SSL错误</p>
<p><img alt="CURL SVC4" src="../img/20220516011150.png" /></p>
<p>删除资源</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-188-1" name="__codelineno-188-1" href="#__codelineno-188-1"></a>kubectl delete -f ./16_svc4/ingress.yaml
<a id="__codelineno-188-2" name="__codelineno-188-2" href="#__codelineno-188-2"></a>kubectl delete secret secret-tls-svc4
</code></pre></div>
<h4 id="-https-ingress-https-ssl-passthroughtmp">实验 - HTTPS-Ingress-HTTPS (ssl-passthrough)(tmp)</h4>
<p><code>18_svc5/src</code> 中存储了一对证书<code>server.crt</code>/<code>server.key</code>用于加密客户端和后端间通讯的流量。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-189-1" name="__codelineno-189-1" href="#__codelineno-189-1"></a>kubectl create secret tls secret-tls-svc5 <span class="se">\</span>
<a id="__codelineno-189-2" name="__codelineno-189-2" href="#__codelineno-189-2"></a>        --key 18_svc5/ic.key --cert 18_svc5/ic.crt <span class="c1"># create secret</span>
<a id="__codelineno-189-3" name="__codelineno-189-3" href="#__codelineno-189-3"></a>kubectl apply -f ./18_svc5/ingress.yaml <span class="c1"># launch ingress, service and deployment</span>
<a id="__codelineno-189-4" name="__codelineno-189-4" href="#__codelineno-189-4"></a>curl -H <span class="s1">&#39;Host:svc5.xxx.com&#39;</span> https://10.119.11.125 -k
</code></pre></div>
<p><img alt="CURL SVC5" src="../img/20220516014839.png" /></p>
<p>删除资源</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-190-1" name="__codelineno-190-1" href="#__codelineno-190-1"></a>kubectl delete -f ./18_svc5/ingress.yaml
<a id="__codelineno-190-2" name="__codelineno-190-2" href="#__codelineno-190-2"></a>kubectl delete secret secret-tls-svc5
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>需要修改Helm安装ingress-nginx的配置以启用<code>enable-ssl-passthrough</code>参数</p>
</div>

              
            </article>
            
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

          </div>
        </div>
        
          <a href="#" class="md-top md-top--hidden md-icon" data-md-component="top">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../container/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Container" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Container
            </div>
          </div>
        </a>
      
      
        
        <a href="../components/" class="md-footer__link md-footer__link--next" aria-label="Next: Components" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Components
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["content.tabs.link", "navigation.tracking", "navigation.instant", "navigation.tabs", "navigation.indexes", "navigation.top", "toc.integrate"], "search": "../assets/javascripts/workers/search.b028fd86.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.0f659f14.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>